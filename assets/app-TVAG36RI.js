import{c as Be,d as ps,f as en,g as ys}from"./chunk-SC4CXXHP.js";import{a as Jt,b as fs}from"./chunk-MG4MJA24.js";import"./chunk-QHE5AMPX.js";import{b as Zt,c as ms}from"./chunk-GUVSRPRW.js";function nn(e,t=document){return!Array.isArray(e)||!t||typeof t.getElementById!="function"?[]:e.map(({key:n,ids:s})=>{if(!Array.isArray(s))return null;for(let i of s){if(typeof i!="string"||!i)continue;let a=t.getElementById(i);if(a)return{key:n,element:a}}return null}).filter(n=>!!(n&&n.element))}function de(e,t){if(!e||typeof e!="object")return"";let n=hs[t]||[t];for(let s of n)if(Object.prototype.hasOwnProperty.call(e,s)){let i=e[s];return i==null?"":typeof i=="string"?i:String(i)}return""}function gs(e,t){if(!e)return;let n=t??"";if(e instanceof HTMLInputElement){e.type==="checkbox"?e.checked=!!n:e.value=typeof n=="string"?n:String(n);return}(e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)&&(e.value=typeof n=="string"?n:String(n))}function bs(e){return e?e instanceof HTMLInputElement?e.type==="checkbox"?e.checked:e.value:e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement?e.value:"":""}function sn(e,t){Array.isArray(t)&&t.forEach(({key:n,element:s})=>{let i=e&&typeof e=="object"?de(e,n):"";gs(s,i)})}function an(e,t,n,s){Array.isArray(e)&&e.forEach(({element:i})=>{i instanceof HTMLInputElement?["checkbox","radio"].includes(i.type)?i.checked=!1:i.value="":(i instanceof HTMLTextAreaElement||i instanceof HTMLSelectElement)&&(i.value="")}),t&&(t.value=""),n&&(n.textContent=s)}function on(e){let t={};return Array.isArray(e)&&e.forEach(({key:n,element:s})=>{let i=bs(s);if(typeof i=="boolean"){t[n]=i;return}let a=typeof i=="string"?i.trim():i;t[n]=a??""}),t}function b(e){return e==null?"":String(e).replace(/[&<>'"]/g,t=>{switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;";default:return t}})}var tn,hs,at,ot,rt=Zt(()=>{tn=[{key:"title",ids:["cue-title","title"]},{key:"details",ids:["cue-details","details","cue-description"]},{key:"date",ids:["cue-date","date"]},{key:"time",ids:["cue-time","time"]},{key:"priority",ids:["cue-priority","priority"]},{key:"category",ids:["cue-category","category"]}],hs={title:["title","name"],details:["details","description","notes","body"],date:["date","dueDate","due_date"],time:["time","dueTime","due_time"],priority:["priority","level"],category:["category","tag"]},at="Create Cue",ot="Edit Cue"});function lt(e=0){let t=Number.isFinite(e)?e:0;if(t<=0)return"0m";let n=Math.floor(t/1e3),s=Math.floor(n/3600),i=Math.floor(n%3600/60),a=n%60,o=[];return s&&o.push(`${s}h`),i&&o.push(`${i}m`),!s&&!i&&o.push(`${a}s`),o.join(" ")}function ct(){let e=new Date,t=String(e.getFullYear()),n=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${s}`}function Ts(e){if(typeof e!="string")return"";let[t,n,s]=e.split("-"),i=Number.parseInt(t,10),a=Number.parseInt(n,10),o=Number.parseInt(s,10);if(!Number.isFinite(i)||!Number.isFinite(a)||!Number.isFinite(o))return e;let l=new Date(i,a-1,o);return Number.isNaN(l.getTime())?e:new Intl.DateTimeFormat(void 0,{month:"long",day:"numeric",year:"numeric"}).format(l)}function cn(e={}){let t=typeof e?.text=="string"?e.text.trim():"",n=typeof e?.priority=="string"?e.priority.toLowerCase():"",s=ue.includes(n)?n:"medium",i=typeof e?.category=="string"&&e.category.trim()?e.category.trim():ln,a=Date.now(),o=Number.isFinite(e?.createdAt)?Number(e.createdAt):a,l=Number.isFinite(e?.completedAt)?Number(e.completedAt):null,d=Number.isFinite(e?.timeTrackedMs)?Number(e.timeTrackedMs):0,u=Number.isFinite(e?.estimateMs)?Number(e.estimateMs):null,c=!!e?.completed;return{id:typeof e?.id=="string"&&e.id?e.id:typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${o}-${Math.random().toString(16).slice(2)}`,text:t,completed:c,priority:s,category:i,createdAt:o,completedAt:c?l??a:null,timeTrackedMs:c?d||Math.max(0,(l??a)-o):d,estimateMs:u}}function he(e){return Array.isArray(e)?e.map(t=>cn(t)):[]}function Ls(e){let t={text:e,priority:"medium",category:ln,estimateMs:null};if(typeof e!="string")return t.text="",t;let n=e,s=e.match(/!(high|medium|low)/i);s&&(t.priority=s[1].toLowerCase(),n=n.replace(s[0],"").trim());let i=e.match(/#([a-z0-9_-]+)/i);i&&(t.category=i[1].toLowerCase(),n=n.replace(i[0],"").trim());let a=e.match(/@([0-9]+)(h|m)?/i);if(a){let o=Number.parseInt(a[1],10);if(Number.isFinite(o)){let d=(a[2]||"m").toLowerCase()==="h"?60:1;t.estimateMs=o*d*6e4}n=n.replace(a[0],"").trim()}return t.text=n.trim(),t.text||(t.text=e.trim()),t}function dn(e){return new dt(e)}var rn,ue,Es,ln,dt,un=Zt(()=>{rt();rn="dailyTasksByDate",ue=["high","medium","low"],Es={high:"High",medium:"Medium",low:"Low"},ln="general";dt=class{constructor(t={}){this.dailyTab=t.dailyTab??null,this.dailyView=t.dailyView??null,this.dailyListHeader=t.dailyListHeader??null,this.quickAddForm=t.quickAddForm??null,this.quickAddInput=t.quickAddInput??null,this.quickAddVoiceButton=t.quickAddVoiceButton??null,this.dailyTasksContainer=t.dailyTasksContainer??null,this.clearCompletedButton=t.clearCompletedButton??null,this.dailyListPermissionNotice=t.dailyListPermissionNotice??null,this.cuesTab=t.cuesTab??null,this.cuesView=t.cuesView??null,this.ensureCueFirestore=typeof t.ensureCueFirestore=="function"?t.ensureCueFirestore:null,this.storage=t.storage??(typeof window<"u"?window.localStorage:void 0),this.window=t.window??window,this.document=t.document??document,this.forceLocalMode=!!t.forceLocalMode,this.tasks=[],this.dailyListLoadPromise=null,this.shouldUseLocalDailyList=this.forceLocalMode,this.firestoreDailyListContextPromise=null,this.activeTimers=new Map,this.undoStack=[],this.quickAddVoiceRecognition=null,this.quickAddVoiceListening=!1,this.quickAddVoiceRestartTimer=null,this.todayId=ct(),this.statsElement=null,this.undoButton=null,this.boundDailyTabClick=n=>{n.preventDefault(),this.switchToDailyView()},this.boundCuesTabClick=n=>{n.preventDefault(),this.switchToCuesView()},this.boundClearCompletedClick=()=>{this.clearCompleted()},this.boundQuickAddSubmit=n=>{n.preventDefault();let s=this.quickAddInput?.value?.trim()??"";if(!s){this.quickAddInput?.focus();return}this.quickAddInput.value="",this.handleQuickAdd(s)},this.boundQuickAddFormStopVoice=()=>{this.quickAddVoiceListening&&this.stopQuickAddVoiceRecognition()},this.boundVoiceButtonClick=()=>{this.quickAddVoiceRecognition&&(this.quickAddVoiceListening?this.stopQuickAddVoiceRecognition():this.startQuickAddVoiceRecognition())},this.boundPageHide=()=>{this.quickAddVoiceListening&&this.stopQuickAddVoiceRecognition()},this.boundTaskContainerChange=n=>{let s=n.target;if(!(s instanceof this.window.HTMLInputElement)||s.type!=="checkbox")return;let i=s.getAttribute("data-task-id");i&&this.completeTask(i,s.checked)},this.boundTaskContainerClick=n=>{let s=n.target instanceof this.window.HTMLElement?n.target:null;if(!s)return;let i=s.closest("[data-task-id]");if(!i)return;let a=i.getAttribute("data-task-id");if(!a)return;let o=s.getAttribute("data-action");if(o==="cycle-priority"){this.cycleTaskPriority(a);return}if(o==="delete-task"){this.deleteTask(a);return}},this.boundUndoClick=()=>{this.undoLastAction()},this.init()}init(){this.setupStatsElement(),this.setupUndoButton(),this.setupEventListeners(),this.initialiseQuickAddVoiceRecognition(),this.loadDailyTasks()}setupStatsElement(){if(!this.dailyTasksContainer||!this.document||this.statsElement)return;let t=this.document.createElement("div");t.className="text-sm text-base-content/70 mb-2 flex items-center gap-3",t.dataset.role="daily-task-stats",t.textContent="No tasks yet",this.dailyTasksContainer.insertAdjacentElement("beforebegin",t),this.statsElement=t}setupUndoButton(){if(!this.clearCompletedButton||!this.document||this.undoButton)return;let t=this.document.createElement("button");t.type="button",t.className="btn btn-ghost btn-sm ml-2 hidden",t.textContent="Undo",t.setAttribute("aria-label","Undo last daily task action"),this.clearCompletedButton.insertAdjacentElement("afterend",t),this.undoButton=t,this.undoButton.addEventListener("click",this.boundUndoClick)}setupEventListeners(){this.dailyTab?.addEventListener("click",this.boundDailyTabClick),this.cuesTab?.addEventListener("click",this.boundCuesTabClick),this.clearCompletedButton?.addEventListener("click",this.boundClearCompletedClick),this.quickAddForm?.addEventListener("submit",this.boundQuickAddSubmit),this.quickAddForm?.addEventListener("submit",this.boundQuickAddFormStopVoice),this.quickAddVoiceButton?.addEventListener("click",this.boundVoiceButtonClick),this.window?.addEventListener?.("pagehide",this.boundPageHide),this.dailyTasksContainer?.addEventListener("change",this.boundTaskContainerChange),this.dailyTasksContainer?.addEventListener("click",this.boundTaskContainerClick)}cleanup(){this.dailyTab?.removeEventListener("click",this.boundDailyTabClick),this.cuesTab?.removeEventListener("click",this.boundCuesTabClick),this.clearCompletedButton?.removeEventListener("click",this.boundClearCompletedClick),this.quickAddForm?.removeEventListener("submit",this.boundQuickAddSubmit),this.quickAddForm?.removeEventListener("submit",this.boundQuickAddFormStopVoice),this.quickAddVoiceButton?.removeEventListener("click",this.boundVoiceButtonClick),this.window?.removeEventListener?.("pagehide",this.boundPageHide),this.dailyTasksContainer?.removeEventListener("change",this.boundTaskContainerChange),this.dailyTasksContainer?.removeEventListener("click",this.boundTaskContainerClick),this.undoButton?.removeEventListener("click",this.boundUndoClick),this.stopQuickAddVoiceRecognition(),this.window?.clearTimeout?.(this.quickAddVoiceRestartTimer)}activateTab(t){[this.cuesTab,this.dailyTab].filter(Boolean).forEach(s=>{let i=s;if(!i)return;let a=s===t;i.classList.toggle("tab-active",a),i.setAttribute("aria-selected",a?"true":"false")})}switchToDailyView(){this.dailyView&&(this.cuesView?.classList.add("hidden"),this.dailyView.classList.remove("hidden"),this.activateTab(this.dailyTab??null),this.loadDailyTasks())}switchToCuesView(){!this.cuesView||!this.dailyView||(this.cuesView.classList.remove("hidden"),this.dailyView.classList.add("hidden"),this.activateTab(this.cuesTab??null))}setQuickAddVoiceButtonActive(t){let n=this.quickAddVoiceButton;if(!n)return;n.setAttribute("aria-pressed",t?"true":"false");let s=n.querySelector('[aria-hidden="true"]');if(s){s.textContent=t?"\u{1F442}":"\u{1F399}\uFE0F";return}n.textContent=t?"\u{1F442}":"\u{1F399}\uFE0F"}scheduleQuickAddVoiceRestart(){this.quickAddVoiceListening&&(this.window?.clearTimeout?.(this.quickAddVoiceRestartTimer),this.quickAddVoiceRestartTimer=this.window?.setTimeout?.(()=>{this.quickAddVoiceRestartTimer=null,this.quickAddVoiceListening&&this.startQuickAddVoiceRecognition(!0)},400))}startQuickAddVoiceRecognition(t=!1){if(!this.quickAddVoiceRecognition)return!1;if(this.quickAddVoiceListening&&!t)return!0;try{return this.quickAddVoiceRecognition.start(),this.quickAddVoiceListening=!0,this.setQuickAddVoiceButtonActive(!0),!0}catch{return this.quickAddVoiceListening=!1,this.setQuickAddVoiceButtonActive(!1),!1}}stopQuickAddVoiceRecognition(){if(this.quickAddVoiceRecognition){this.quickAddVoiceListening=!1,this.window?.clearTimeout?.(this.quickAddVoiceRestartTimer);try{this.quickAddVoiceRecognition.stop()}catch{}this.setQuickAddVoiceButtonActive(!1)}}initialiseQuickAddVoiceRecognition(){let t=this.quickAddVoiceButton;if(!(!t||!this.window))try{let n=this.window.SpeechRecognition||this.window.webkitSpeechRecognition||this.window.mozSpeechRecognition||this.window.msSpeechRecognition;if(!n){t.setAttribute("disabled","true"),t.setAttribute("aria-disabled","true"),t.title="Voice input is not supported in this browser.";return}this.quickAddVoiceRecognition=new n;let s=this.document?.documentElement?.lang||this.window.navigator?.language||"en-AU";if(this.quickAddVoiceRecognition.lang=s,this.quickAddVoiceRecognition.interimResults=!1,"continuous"in this.quickAddVoiceRecognition)try{this.quickAddVoiceRecognition.continuous=!0}catch{}this.quickAddVoiceRecognition.onresult=i=>{let a=i?.results?.[0]?.[0]?.transcript||"";if(a&&this.quickAddInput){this.quickAddInput.value=a.trim();try{this.quickAddInput.focus({preventScroll:!0})}catch{this.quickAddInput.focus()}try{let o=this.quickAddInput.value.length;this.quickAddInput.setSelectionRange(o,o)}catch{}}},this.quickAddVoiceRecognition.onend=()=>{if(!this.quickAddVoiceListening){this.setQuickAddVoiceButtonActive(!1);return}this.scheduleQuickAddVoiceRestart()},this.quickAddVoiceRecognition.onerror=()=>{this.quickAddVoiceListening=!1,this.setQuickAddVoiceButtonActive(!1)}}catch{this.quickAddVoiceRecognition=null,this.setQuickAddVoiceButtonActive(!1),t.setAttribute("disabled","true"),t.setAttribute("aria-disabled","true")}}showPermissionNotice(){this.dailyListPermissionNotice?.classList.remove("hidden")}hidePermissionNotice(){this.dailyListPermissionNotice?.classList.add("hidden")}updateClearCompletedButtonState(){if(!this.clearCompletedButton)return;let t=this.tasks.some(n=>!!n?.completed);this.clearCompletedButton.disabled=!t}updateStats(){if(!this.statsElement)return;if(!this.tasks.length){this.statsElement.textContent="No tasks yet";return}let t=this.tasks.filter(i=>i.completed).length,n=this.tasks.length-t,s=this.tasks.reduce((i,a)=>i+(a.timeTrackedMs||0),0);this.statsElement.textContent=`Tasks: ${this.tasks.length} \u2022 Completed: ${t} \u2022 Remaining: ${n} \u2022 Tracked: ${lt(s)}`}renderDailyTasks(){if(!this.dailyTasksContainer)return;if(!Array.isArray(this.tasks)||this.tasks.length===0){this.dailyTasksContainer.innerHTML='<p class="text-sm text-base-content/60">No tasks for today yet.</p>',this.updateClearCompletedButtonState(),this.updateStats();return}let n=[...this.tasks].sort((s,i)=>{let a=ue.indexOf(s.priority)-ue.indexOf(i.priority);return a!==0?a:s.createdAt-i.createdAt}).map(s=>{let i=b(s.text||""),a=!!s.completed,o=["ml-3","flex-1","text-sm","sm:text-base","text-base-content"];a&&o.push("line-through","text-opacity-50");let l=Es[s.priority]??"Medium",d=[`Priority: ${l}`,`Category: ${b(s.category)}`];if(s.completedAt){let u=Math.max(0,s.completedAt-s.createdAt);d.push(`Time: ${lt(u)}`)}else s.estimateMs&&d.push(`Estimate: ${lt(s.estimateMs)}`);return`
        <div class="flex flex-col gap-1 p-3 border-b border-base-200" data-task-id="${s.id}">
          <div class="flex items-center gap-3">
            <input type="checkbox" class="checkbox checkbox-sm" data-task-id="${s.id}" ${a?"checked":""} />
            <span class="${o.join(" ")}">${i}</span>
          </div>
          <div class="flex items-center gap-3 text-xs text-base-content/70">
            <span>${d.join(" \u2022 ")}</span>
            <button type="button" class="btn btn-ghost btn-xs" data-action="cycle-priority">Priority: ${l}</button>
            <button type="button" class="btn btn-ghost btn-xs" data-action="delete-task">Delete</button>
          </div>
        </div>
      `}).join("");this.dailyTasksContainer.innerHTML=n,this.updateClearCompletedButtonState(),this.updateStats()}async loadDailyTasks(){if(!this.dailyListHeader||!this.dailyTasksContainer)return[];let t=ct();this.todayId=t;let n=Ts(t);if(this.dailyListHeader.textContent=n?`Today's List - ${n}`:"Today's List",this.shouldUseLocalDailyList){this.showPermissionNotice();let s=this.getLocalDailyTasks(t);return this.tasks=s,this.renderDailyTasks(),s}return this.dailyListLoadPromise||(this.dailyTasksContainer.innerHTML='<p class="text-sm text-base-content/60">Loading tasks\u2026</p>',this.updateClearCompletedButtonState(),this.dailyListLoadPromise=(async()=>{try{let s=await this.ensureDailyListFirestore();if(!s){this.shouldUseLocalDailyList=!0,this.showPermissionNotice();let l=this.getLocalDailyTasks(t);this.tasks=l,this.renderDailyTasks();return}let i=this.getDailyListDocRef(s,t),a=await s.getDoc(i),o=a.exists()?a.data()?.tasks:[];this.tasks=he(o),this.renderDailyTasks(),this.setLocalDailyTasks(t,this.tasks),this.shouldUseLocalDailyList=!1,this.hidePermissionNotice()}catch(s){if(this.isPermissionDeniedError(s)){console.warn("Falling back to local daily tasks due to permission issue",s),this.shouldUseLocalDailyList=!0,this.showPermissionNotice();let i=this.getLocalDailyTasks(t);this.tasks=i,this.renderDailyTasks();return}console.error("Failed to load daily list",s),this.dailyTasksContainer.innerHTML='<p class="text-sm text-error">Unable to load daily tasks right now.</p>',this.tasks=[],this.updateClearCompletedButtonState(),this.updateStats()}})().finally(()=>{this.dailyListLoadPromise=null})),await this.dailyListLoadPromise,this.tasks}async ensureDailyListFirestore(){return this.ensureCueFirestore?this.firestoreDailyListContextPromise?this.firestoreDailyListContextPromise:(this.firestoreDailyListContextPromise=this.ensureCueFirestore().then(t=>{let{db:n,getCollection:s}=t??{},i=typeof s=="function"&&n?s(n,"dailyLists"):null;return{...t,dailyListsCollection:i}}).catch(t=>{throw console.error("Failed to initialise Firestore for daily lists",t),t}),this.firestoreDailyListContextPromise):null}getDailyListDocRef(t,n){let{doc:s,dailyListsCollection:i,db:a}=t??{};if(typeof s!="function")throw new Error("Firestore document helper is unavailable");return i?s(i,n):s(a,"dailyLists",n)}isPermissionDeniedError(t){let n=typeof t?.code=="string"?t.code.toLowerCase():"";if(n)return n.includes("permission-denied")||n.includes("insufficient-permission");let s=typeof t?.message=="string"?t.message.toLowerCase():"";return!!(s&&s.includes("permission"))}getLocalDailyTasks(t){let n=this.readDailyTaskStorage(),s=n&&typeof n=="object"?n[t]:[];return he(s)}setLocalDailyTasks(t,n){let s=this.readDailyTaskStorage(),i=he(n);return s[t]=i,this.writeDailyTaskStorage(s),i}readDailyTaskStorage(){if(!this.storage||typeof this.storage.getItem!="function")return{};try{let t=this.storage.getItem(rn);if(!t)return{};let n=JSON.parse(t);return n&&typeof n=="object"?n:{}}catch(t){return console.warn("Unable to read daily tasks from storage",t),{}}}writeDailyTaskStorage(t){if(!(!this.storage||typeof this.storage.setItem!="function"))try{let n=t&&typeof t=="object"?t:{};this.storage.setItem(rn,JSON.stringify(n))}catch(n){console.warn("Unable to persist daily tasks locally",n)}}async handleQuickAdd(t){let{text:n,priority:s,category:i,estimateMs:a}=Ls(t);if(!n){this.quickAddInput?.focus();return}let o={text:n,completed:!1,priority:s,category:i,estimateMs:a};this.quickAddInput&&(this.quickAddInput.value="",this.quickAddInput.focus());try{await this.addDailyTask(o)}catch(l){console.error("Failed to add task to the daily list",l),this.quickAddInput&&(this.quickAddInput.value=t,this.quickAddInput.focus())}}async addDailyTask(t){let n=cn(t),s=[...this.tasks];this.tasks=[...this.tasks,n],this.renderDailyTasks();try{return await this.saveDailyTasks(this.tasks),n}catch(i){throw console.error("Failed to persist new daily task",i),this.tasks=s,this.renderDailyTasks(),i}}async completeTask(t,n){let s=this.tasks.map(a=>({...a})),i=!1;if(this.tasks=this.tasks.map(a=>{if(a.id!==t)return a;i=!0;let o=n?Date.now():null;return{...a,completed:n,completedAt:o,timeTrackedMs:n?Math.max(0,(o??Date.now())-a.createdAt):0}}),!!i){this.renderDailyTasks();try{await this.saveDailyTasks(this.tasks)}catch(a){console.error("Failed to update task completion state",a),this.tasks=s,this.renderDailyTasks()}}}async clearCompleted(){if(!this.tasks.length)return;let t=this.tasks.filter(s=>!s.completed);if(t.length===this.tasks.length)return;this.pushUndoState();let n=this.tasks;this.tasks=t,this.renderDailyTasks();try{await this.saveDailyTasks(this.tasks)}catch(s){console.error("Failed to clear completed tasks",s),this.tasks=n,this.renderDailyTasks(),this.popUndoState()}}cycleTaskPriority(t){let n=this.tasks.findIndex(o=>o.id===t);if(n===-1)return;let s=this.tasks[n],i=ue.indexOf(s.priority),a=ue[(i+1)%ue.length];this.tasks=this.tasks.map(o=>o.id===t?{...o,priority:a}:o),this.renderDailyTasks(),this.saveDailyTasks(this.tasks)}deleteTask(t){this.tasks.find(s=>s.id===t)&&(this.pushUndoState(),this.tasks=this.tasks.filter(s=>s.id!==t),this.renderDailyTasks(),this.saveDailyTasks(this.tasks).catch(s=>{console.error("Failed to delete daily task",s),this.undoLastAction()}))}pushUndoState(){this.undoStack.push({tasks:this.tasks.map(t=>({...t}))}),this.updateUndoButton()}popUndoState(){let t=this.undoStack.pop();return this.updateUndoButton(),t}undoLastAction(){let t=this.popUndoState();t&&(this.tasks=he(t.tasks),this.renderDailyTasks(),this.saveDailyTasks(this.tasks))}updateUndoButton(){this.undoButton&&(this.undoStack.length?this.undoButton.classList.remove("hidden"):this.undoButton.classList.add("hidden"))}readTodayId(){return this.todayId||ct()}async saveDailyTasks(t){let n=this.readTodayId(),s=he(t);if(this.shouldUseLocalDailyList){this.setLocalDailyTasks(n,s);return}try{let i=await this.ensureDailyListFirestore();if(!i){this.setLocalDailyTasks(n,s);return}let a=this.getDailyListDocRef(i,n);typeof i.setDoc=="function"?await i.setDoc(a,{tasks:s},{merge:!0}):await i.updateDoc(a,{tasks:s}),this.setLocalDailyTasks(n,s)}catch(i){if(this.isPermissionDeniedError(i)){console.warn("Persisting daily tasks locally because cloud sync is unavailable",i),this.shouldUseLocalDailyList=!0,this.showPermissionNotice(),this.setLocalDailyTasks(n,s);return}throw i}}}});var ma=ms(()=>{fs();ps();rt();ys();un();Jt();function ws(){if(typeof document>"u")return;let e=document.getElementById("add-reminder-modal")??document.getElementById("reminder-modal"),t=document.getElementById("add-reminder-form")??document.getElementById("reminder-form"),n=document.getElementById("reminder-title");if(!t||!n)return;let s=document.querySelectorAll("[data-open-reminder-modal]");if(!s.length)return;if(!e){let p=()=>{if(!(!(n instanceof HTMLElement)||typeof n.focus!="function"))try{n.focus({preventScroll:!1})}catch{n.focus()}};s.forEach(h=>{h.addEventListener("click",v=>{if(v.preventDefault(),typeof window<"u"){let H="#reminders";window.location.hash!==H&&(window.location.hash=H),typeof window.renderRoute=="function"&&window.renderRoute()}window.requestAnimationFrame(()=>{p()})})});return}let i=e.querySelector("[data-reminder-modal-backdrop]"),a=e.querySelectorAll("[data-close-modal]"),o=document.getElementById("mainContent"),l=document.querySelector('nav[aria-label="Primary"]'),d=[o,l],u=e.querySelector('[role="dialog"]')??e,c=["a[href]","area[href]","button:not([disabled])",'input:not([type="hidden"]):not([disabled])',"select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'],y=null,w=()=>{if(!(u instanceof HTMLElement))return[];let p=u.querySelectorAll(c.join(","));return Array.from(p).filter(h=>{let v=h instanceof HTMLElement,H=typeof SVGElement<"u"&&h instanceof SVGElement;if(!v&&!H||h.getAttribute("aria-hidden")==="true"||"disabled"in h&&h.disabled||h.hidden||h.closest("[hidden]"))return!1;let L=h.getBoundingClientRect();return L.width>0&&L.height>0})},g=()=>{let p=w(),h=p.find(v=>v.hasAttribute("data-autofocus")||v.hasAttribute("autofocus"))||(n&&p.includes(n)?n:null)||p[0];if(h&&typeof h.focus=="function"){h.focus({preventScroll:!0});return}u instanceof HTMLElement&&typeof u.focus=="function"&&u.focus({preventScroll:!0})},k=p=>{u instanceof HTMLElement&&(!(p.target instanceof Node)||!u.contains(p.target))&&(p.stopPropagation(),g())},C=p=>{if(p.key!=="Tab")return;let h=w();if(!h.length){p.preventDefault(),u instanceof HTMLElement&&u.focus({preventScroll:!0});return}let v=h[0],H=h[h.length-1],L=document.activeElement;if(p.shiftKey){(!u.contains(L)||L===v)&&(p.preventDefault(),H.focus());return}(!u.contains(L)||L===H)&&(p.preventDefault(),v.focus())},_=p=>{d.forEach(h=>{h&&(p?h.setAttribute("inert",""):h.removeAttribute("inert"))})},M=()=>{e.classList.add("hidden"),e.setAttribute("aria-hidden","true"),e.setAttribute("inert",""),_(!1),document.removeEventListener("keydown",N,!0),e.removeEventListener("keydown",C,!0),e.removeEventListener("focusin",k,!0),y&&typeof y.focus=="function"&&y.focus(),y=null},N=p=>{p.key==="Escape"&&(p.preventDefault(),M())},O=({triggerElement:p}={})=>{p&&typeof p.focus=="function"?y=p:y=document.activeElement,e.classList.remove("hidden"),e.removeAttribute("aria-hidden"),e.removeAttribute("inert"),_(!0),document.addEventListener("keydown",N,!0),e.addEventListener("keydown",C,!0),e.addEventListener("focusin",k,!0),window.requestAnimationFrame(()=>{g()})},q=(p,h={})=>{try{document.dispatchEvent(new CustomEvent(p,{detail:h}))}catch{if(typeof document<"u"&&typeof document.createEvent=="function"){let v=document.createEvent("CustomEvent");v.initCustomEvent(p,!0,!0,h),document.dispatchEvent(v)}}},B=(p={})=>{q("cue:cancelled",p)};s.forEach(p=>{p.addEventListener("click",h=>{h.preventDefault();let H={trigger:h.currentTarget instanceof HTMLElement?h.currentTarget:null,mode:"create"};q("cue:prepare",H),q("cue:open",H)})}),a.forEach(p=>{p.addEventListener("click",h=>{h.preventDefault(),B({trigger:p,reason:"button"})})}),e.addEventListener("click",p=>{p.target===e&&B({reason:"backdrop"})}),i?.addEventListener("click",p=>{p.target===i&&B({reason:"backdrop"})}),document.addEventListener("cue:open",p=>{let h=p?.detail?.trigger,v=h instanceof HTMLElement?h:null;O({triggerElement:v})});let P=()=>{M()};document.addEventListener("cue:close",P),document.addEventListener("cue:cancelled",P);let F=e.querySelector("#saveReminder");t instanceof HTMLFormElement&&F instanceof HTMLElement&&t.addEventListener("submit",p=>{p.preventDefault(),!F.matches(":disabled")&&F.click()}),F instanceof HTMLElement&&document.addEventListener("reminder:save",p=>{let h=p?.detail?.trigger;h&&h!==F||F.matches(":disabled")||F.click()})}ws();function ut(e,t={}){if(!(typeof document>"u"||!e))try{document.dispatchEvent(new CustomEvent(e,{detail:t}))}catch{if(typeof document.createEvent=="function"){let n=document.createEvent("CustomEvent");n.initCustomEvent(e,!0,!0,t),document.dispatchEvent(n)}}}var mn=null;function ks(e){return!e||typeof document>"u"?null:document.querySelector(`[data-route="${e}"]`)}function vs(){if(typeof window>"u")return"";let e=window.location.hash||"#dashboard";return(e.startsWith("#")?e.slice(1):e)||"dashboard"}function Ss(e){typeof document>"u"||!e||(window.clearTimeout(mn),mn=window.setTimeout(()=>{let t=ks(e);if(!t)return;let n=t.querySelector("h1, [data-primary-heading]");if(n instanceof HTMLElement&&(n.hasAttribute("tabindex")||n.setAttribute("tabindex","-1"),typeof n.focus=="function"))try{n.focus({preventScroll:!0})}catch{n.focus()}},0))}function Te(e){let t=e||vs();t&&Ss(t)}function xs(){if(typeof document>"u"||typeof window>"u")return;let e=()=>{Te()};window.addEventListener("hashchange",e),window.addEventListener("DOMContentLoaded",e),document.querySelectorAll("[data-nav]").forEach(n=>{n.addEventListener("click",s=>{if(!(s.currentTarget instanceof HTMLAnchorElement))return;let i=s.currentTarget.getAttribute("href")||"";if(!i.startsWith("#"))return;s.preventDefault();let a=i||"#dashboard",o=a.replace("#","")||"dashboard";window.location.hash!==a&&(window.location.hash=a),typeof window.renderRoute=="function"&&window.renderRoute(),Te(o)})}),typeof window.renderRoute=="function"&&window.renderRoute(),Te()}xs();var fn=document.getElementById("settings-save-button"),Ne=document.getElementById("settings-save-confirmation"),$=document.getElementById("live-status"),mt=null,ie=document.getElementById("resourcePlannerStatus"),ft=null;document.addEventListener("planner:reminderCreated",e=>{if(!$)return;let t=e?.detail||{},n=typeof t.lessonTitle=="string"&&t.lessonTitle.trim()?t.lessonTitle.trim():"",s=typeof t.dayLabel=="string"&&t.dayLabel.trim()?t.dayLabel.trim():"",i=s?`Reminder saved for ${s}${n?` \xB7 ${n}`:""}.`:n?`Reminder saved for ${n}.`:"Planner reminder saved.";$.textContent=i});fn&&Ne&&fn.addEventListener("click",e=>{e.preventDefault(),Ne.classList.remove("hidden"),Ne.textContent="Settings saved!",$&&($.textContent="Settings saved!"),mt&&window.clearTimeout(mt),mt=window.setTimeout(()=>{Ne.classList.add("hidden")},3e3)});function As(e){if(typeof window>"u")return;e.preventDefault();let t="planner",n="#planner";window.location.hash!==n&&(window.location.hash=n),typeof window.renderRoute=="function"&&window.renderRoute(),Te(t),$&&($.textContent="Opening planner to add a new lesson."),_t(),window.requestAnimationFrame(()=>{let s=es();s&&typeof s.catch=="function"&&s.catch(i=>{console.error("Planner quick action failed to start new lesson flow",i)})})}function Cs(){if(typeof document>"u")return;let e=document.querySelectorAll('[data-quick-action="planner"]');e.length&&e.forEach(t=>{t.addEventListener("click",As)})}Cs();function pt(e,{tone:t="success"}={}){ie&&(ie.textContent=e,ie.classList.remove("hidden"),ie.classList.remove("text-success","text-error"),ie.classList.add(t==="error"?"text-error":"text-success"),typeof window<"u"&&(ft&&window.clearTimeout(ft),ft=window.setTimeout(()=>{ie.classList.add("hidden"),ie.textContent=""},4e3))),$&&($.textContent=e)}function Nt(e="resource"){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`${e}-${Date.now()}-${Math.random().toString(16).slice(2)}`}async function Is(e){if(typeof document>"u"||typeof window>"u")return;e.preventDefault();let t=e.currentTarget instanceof Element?e.currentTarget:e.target instanceof Element?e.target.closest("[data-resource-planner]"):null;if(!t)return;let n=t.closest("[data-resource-title][data-resource-link]");if(!n)return;let s=n.getAttribute("data-resource-title")?.trim(),i=n.getAttribute("data-resource-link")?.trim();if(!s||!i)return;let a="#planner";window.location.hash!==a&&(window.location.hash=a),typeof window.renderRoute=="function"&&window.renderRoute(),Te("planner"),_t(),await tt();let o=`${s} \u2014 ${i}`,l=Ri(),d=null;try{if(l)d=await addLessonDetail(f,l,{badge:"Resource",text:o});else{let u=Nt("lesson"),c=T?.lessons?.[0]?.dayLabel||"Monday";d=await addLessonToWeek(f,{id:u,dayName:c,title:s,summary:`Resource link: ${i}`,details:[{badge:"Resource",text:o}]}),d&&(A=u)}if(d){T=d,D(d),R(d,f);let u=l?`Added "${s}" to your selected lesson.`:`Created a lesson for "${s}" in this week's planner.`;pt(u);return}pt("Unable to save that resource to the planner right now.",{tone:"error"})}catch(u){console.error("Failed to save resource to planner",u),pt("Unable to save that resource to the planner right now.",{tone:"error"})}}function Ds(){if(typeof document>"u")return;let e=document.querySelectorAll("[data-resource-planner]");e.length&&e.forEach(t=>{t.addEventListener("click",Is)})}Ds();var Mn=document.getElementById("reminder-title"),Ms=document.getElementById("reminderText"),z=(()=>{let e=document.getElementById("cue-modal")??document.getElementById("cue_modal");if(!(e instanceof HTMLElement))return null;let t=document.getElementById("openCueModal"),n=document.getElementById("closeCueModal"),s=e.querySelector(".modal-backdrop button"),i=document.getElementById("modal-title");return en({modalElement:e,openButton:t instanceof HTMLElement?t:null,closeButton:n instanceof HTMLElement?n:null,backdropButton:s instanceof HTMLElement?s:null,titleInput:Mn,modalTitle:i instanceof HTMLElement?i:null,defaultTitle:at,editTitle:ot})})();z?.setEditMode(!1);var Bs=()=>{let e=!!Mn;if(!!Ms)return Be({variant:"mobile",titleSel:"#reminderText",dateSel:"#reminderDate",timeSel:"#reminderTime",detailsSel:"#reminderDetails",prioritySel:"#priority",categorySel:"#category",saveBtnSel:"#saveReminder",cancelEditBtnSel:"#cancelEditBtn",listSel:"#reminderList",listWrapperSel:"#remindersWrapper",emptyStateSel:"#emptyState",statusSel:"#statusMessage",syncStatusSel:"#syncStatus",voiceBtnSel:"#voiceBtn",notifBtnSel:"#notifBtn",categoryOptionsSel:"#categorySuggestions",countTotalSel:"#totalCount",googleSignInBtnSel:"#googleSignInBtn",googleSignOutBtnSel:"#googleSignOutBtn",googleAvatarSel:"#googleAvatar",googleUserNameSel:"#googleUserName",syncAllBtnSel:"#syncAll",syncUrlInputSel:"#syncUrl",saveSettingsSel:"#saveSyncSettings",testSyncSel:"#testSync",openSettingsSel:'[data-open="settings"]',dateFeedbackSel:"#dateFeedback"});let n={titleSel:"#reminder-title",dateSel:"#reminder-date",timeSel:null,detailsSel:"#reminder-notes",prioritySel:"#reminder-priority",categorySel:null,saveBtnSel:"#saveReminder",cancelEditBtnSel:null,listSel:"#reminders-list",statusSel:"#auth-feedback-header",syncStatusSel:"#sync-status",voiceBtnSel:null,categoryOptionsSel:null,countTotalSel:"#remindersCount",emptyStateSel:null,listWrapperSel:null,dateFeedbackSel:null,googleSignInBtnSel:"#googleSignInBtn",googleSignOutBtnSel:"#googleSignOutBtn",googleUserNameSel:"#googleUserName",variant:"desktop",autoWireAuthButtons:!0,plannerContextSel:"#planner-reminder-context",plannerLessonInputSel:"#planner-reminder-lesson-id",detailPanelSel:"#reminder-detail-panel",detailEmptySel:"#reminder-detail-empty",detailContentSel:"#reminder-detail-content",detailTitleSel:"#reminder-detail-title",detailDueSel:"#reminder-detail-due",detailPrioritySel:"#reminder-detail-priority",detailCategorySel:"#reminder-detail-category",detailNotesSel:"#reminder-detail-notes",detailClearSel:"#reminder-detail-clear"};return e?Be(n):Be({...n,listSel:null,listWrapperSel:null,emptyStateSel:null,countTotalSel:null,voiceBtnSel:null,categoryOptionsSel:null,dateSel:null,timeSel:null,prioritySel:null,categorySel:null,saveBtnSel:null,cancelEditBtnSel:null,detailsSel:null,titleSel:null,dateFeedbackSel:null})};Bs().catch(e=>{console.error("Failed to initialise reminders",e)});var wt=initNotesSync(),yt=initSupabaseAuth({selectors:{signInButtons:["#googleSignInBtn"],signOutButtons:["#googleSignOutBtn"],userBadge:"#user-badge",userBadgeEmail:"#user-badge-email",userBadgeInitial:"#user-badge-initial",userName:"#googleUserName",syncStatus:["#sync-status"],feedback:["#auth-feedback-header","#auth-feedback-rail"]},disableButtonBinding:!0,onSessionChange:e=>{wt?.handleSessionChange(e)}});if(yt?.supabase){wt?.setSupabaseClient(yt.supabase);try{yt.supabase.auth.getSession().then(({data:e})=>{wt?.handleSessionChange(e?.session?.user??null)}).catch(()=>{})}catch{}}var G=document.getElementById("cues-list"),ht=document.getElementById("pinnedNotesCard"),pe=document.getElementById("pinnedNotesList"),oe=document.getElementById("cue-form"),W=oe?.querySelector("#cue-id-input"),Ns=z?.defaultTitle||z?.modalTitle?.textContent?.trim()||at,La=z?.editTitle||ot,Ps=document.getElementById("tab-cues"),Fs=document.getElementById("tab-daily"),Hs=document.getElementById("cues-view"),Rs=document.getElementById("daily-list-view"),$s=document.getElementById("daily-list-header"),_s=document.getElementById("quick-add-form"),Vs=document.getElementById("quick-add-input"),qs=document.getElementById("daily-voice-btn"),Us=document.getElementById("daily-tasks-container"),Os=document.getElementById("clear-completed-btn"),js=document.getElementById("daily-list-permission-notice"),x=document.getElementById("plannerCards")||document.getElementById("planner-grid"),pn=document.getElementById("plannerWeekRange"),Ws=document.getElementById("planner-prev"),zs=document.getElementById("planner-next"),Qs=document.getElementById("planner-today"),Ys=document.getElementById("planner-copy-week"),Ks=document.getElementById("planner-clear-week"),Gs=document.getElementById("planner-duplicate-btn"),Xs=document.getElementById("planner-new-lesson-btn"),kt=document.getElementById("planner-list-view-toggle"),vt=document.getElementById("planner-week-view-toggle"),Le=document.getElementById("plannerWeekView"),Oe=document.querySelector("[data-planner-text-size]"),gt=document.querySelector("[data-planner-card-panel]"),yn=document.getElementById("plannerSummaryCount"),je=document.getElementById("plannerSummaryRange"),hn=document.getElementById("plannerInsightsLessons"),gn=document.getElementById("plannerInsightsSubjects"),bn=document.getElementById("plannerInsightsNotes"),J=document.getElementById("plannerTeacherNotes"),bt=document.getElementById("plannerTeacherNotesStatus"),U=document.getElementById("planner-lesson-timetable"),wa=document.getElementById("timetable-form"),ka=document.getElementById("timetable-list"),va=document.getElementById("timetable-day"),Sa=document.getElementById("timetable-period"),xa=document.getElementById("timetable-class"),Aa=document.getElementById("timetable-subject"),Ca=document.getElementById("timetable-submit"),Ia=document.getElementById("timetable-reset"),Pe=document.querySelector("[data-mobile-notes-text-size]"),Et=document.querySelector(".mobile-panel--notes"),Bn="plannerTextSizePreference",We="default",Xe=new Set(["small","default","large"]),Zs=["planner-text-small","planner-text-default","planner-text-large"],Nn="mobileNotesTextSizePreference",ze="default",Ze=new Set(["small","default","large"]),Js=["mobile-panel--notes-size-small","mobile-panel--notes-size-default","mobile-panel--notes-size-large"];function St(e){return typeof HTMLSelectElement<"u"&&e instanceof HTMLSelectElement}function ei(){if(typeof localStorage>"u")return We;let e=localStorage.getItem(Bn);return e&&Xe.has(e)?e:We}function ti(e){typeof localStorage>"u"||!Xe.has(e)||localStorage.setItem(Bn,e)}function Pn(e){if(!gt)return;let t=Xe.has(e)?e:We;Zs.forEach(n=>gt.classList.remove(n)),gt.classList.add(`planner-text-${t}`)}var Fn=ei();Pn(Fn);St(Oe)&&(Oe.value=Fn);function Hn(){if(typeof localStorage>"u")return ze;let e=localStorage.getItem(Nn);return e&&Ze.has(e)?e:ze}function ni(e){typeof localStorage>"u"||!Ze.has(e)||localStorage.setItem(Nn,e)}function Rn(e){if(!Et)return;let t=Ze.has(e)?e:ze;Js.forEach(n=>Et.classList.remove(n)),Et.classList.add(`mobile-panel--notes-size-${t}`)}var $n=Hn();Rn($n);Pe instanceof HTMLSelectElement&&(Pe.value=$n,Pe.addEventListener("change",e=>{let t=typeof e.target?.value=="string"?e.target.value:ze;if(!Ze.has(t)){Pe.value=Hn();return}ni(t),Rn(t)}));var si=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];function ii(e){if(e&&Number.isFinite(e.dayIndex))return e.dayIndex;let t=typeof e?.dayLabel=="string"&&e.dayLabel.trim()?e.dayLabel.trim():typeof e?.dayName=="string"&&e.dayName.trim()?e.dayName.trim():"";if(!t)return 0;let n=si.findIndex(s=>s.toLowerCase()===t.toLowerCase());return n>=0?n:0}function ai(e){if(!(e instanceof Date)||Number.isNaN(e.getTime()))return"";let t=String(e.getFullYear()).padStart(4,"0"),n=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${n}-${s}`}function oi(e){if(!e)return"";let t=[],n=typeof e.day=="string"?e.day.trim():"",s=typeof e.period=="string"?e.period.trim():"",i=typeof e.className=="string"?e.className.trim():"";return n&&t.push(n.charAt(0).toUpperCase()+n.slice(1)),s&&t.push(s),i&&t.push(i),t.join(" \u2013 ")}function Qe(e){return Number.isFinite(e)?e<0?0:e>6?6:e:1}function Ye(e){if(typeof e!="string")return"Monday";let t=e.trim();return t?t.charAt(0).toUpperCase()+t.slice(1):"Monday"}function Tt(e=""){if(!(U instanceof HTMLSelectElement))return;let t=['<option value="">No timetable link</option>'];Ft.forEach(n=>{let s=oi(n)||"Timetable slot",i=e&&n.id===e?"selected":"";t.push(`<option value="${n.id}" ${i}>${b(s)}</option>`)}),U.innerHTML=t.join(""),e&&U.value!==e&&(U.value=e)}function ri(){if(typeof document>"u")return null;let e=document.getElementById("planner-lesson-modal"),t=document.getElementById("planner-lesson-form"),n=document.getElementById("planner-modal-title"),s=document.getElementById("planner-modal-description"),i=document.getElementById("planner-modal-error"),a=document.getElementById("planner-modal-submit"),o=document.getElementById("planner-modal-submit-add-another"),l=document.getElementById("planner-lesson-day"),d=document.getElementById("planner-lesson-period"),u=document.getElementById("planner-lesson-title"),c=document.getElementById("planner-lesson-summary"),y=document.getElementById("planner-lesson-subject"),w=document.getElementById("planner-lesson-status"),g=document.getElementById("planner-detail-badge"),k=document.getElementById("planner-detail-text"),C=document.getElementById("planner-duplicate-week"),_=t?.querySelectorAll("[data-summary-template]")||[];if(!(e instanceof HTMLElement)||!(t instanceof HTMLFormElement)||!(a instanceof HTMLElement)||!(l instanceof HTMLSelectElement)||!(d instanceof HTMLInputElement)||!(u instanceof HTMLInputElement)||!(c instanceof HTMLTextAreaElement)||!(w instanceof HTMLSelectElement))return null;let M=t.querySelector("[data-planner-lesson-section]"),N=t.querySelector("[data-planner-summary-section]"),O=t.querySelector("[data-planner-detail-section]"),q=t.querySelector("[data-planner-duplicate-section]"),B=e.querySelector("[data-planner-modal-dialog]"),P=e.querySelector("[data-planner-modal-backdrop]"),F=e.querySelectorAll("[data-planner-modal-close]"),p=document.getElementById("mainContent"),h=document.querySelector('nav[aria-label="Primary"]'),v=(()=>{let r=[],m=e.parentElement;return h instanceof HTMLElement&&r.push(h),m instanceof HTMLElement?r.push(...Array.from(m.children).filter(E=>E instanceof HTMLElement&&E!==e)):p instanceof HTMLElement&&(p.contains(e)?r.push(...Array.from(p.children).filter(E=>E instanceof HTMLElement&&!E.contains(e))):r.push(p)),r})(),H=["a[href]","area[href]","button:not([disabled])",'input:not([type="hidden"]):not([disabled])',"select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'],L={mode:"add",lessonId:null,trigger:null},ne=null,ve=null,re="",nt="",X="simple",Se="save",se=r=>{ne=r instanceof HTMLElement?r:null},Vt=r=>{Se=r},ye=r=>{if(!(w instanceof HTMLSelectElement))return;let m=V[r]?r:"not_started";w.value=m},xe=r=>{let m=typeof r=="string"&&r.trim()?r.trim():"Monday";l.value=m,l.value!==m&&(l.value="Monday")},as=r=>{let m=Jn(r||"simple");!m||typeof c.value=="string"&&c.value.trim()&&!window.confirm("Replace existing summary with this template?")||(c.value=m,X=r||"simple",c.focus())},qt=r=>{v.forEach(m=>{m&&(r?m.setAttribute("inert",""):m.removeAttribute("inert"))})},Ut=()=>{if(!(B instanceof HTMLElement))return[];let r=B.querySelectorAll(H.join(","));return Array.from(r).filter(m=>{if(m.closest('[aria-hidden="true"]')||"disabled"in m&&m.disabled)return!1;let E=m.getBoundingClientRect();return E.width>0&&E.height>0})},Ot=()=>{let r=Ut(),m=(ne&&r.includes(ne)?ne:null)||r[0]||B;m&&typeof m.focus=="function"&&m.focus({preventScroll:!0})},jt=r=>{B instanceof HTMLElement&&(B.contains(r.target)||Ot())},os=r=>{if(r.key!=="Tab")return;let m=Ut();if(!m.length){r.preventDefault();return}let E=m[0],j=m[m.length-1];if(r.shiftKey&&document.activeElement===E){r.preventDefault(),j.focus();return}!r.shiftKey&&document.activeElement===j&&(r.preventDefault(),E.focus())},Wt=r=>{if(r.key==="Escape"){r.preventDefault(),Q();return}os(r)},zt=()=>{i&&(i.textContent="",i.classList.add("hidden"),i.setAttribute("aria-hidden","true"))},Z=r=>{i&&(i.textContent=r,i.classList.remove("hidden"),i.removeAttribute("aria-hidden"))},Qt=r=>{a.disabled=!!r,a.classList.toggle("loading",!!r),o instanceof HTMLButtonElement&&(o.disabled=!!r,o.classList.toggle("loading",!!r))},I=(r,m)=>{r instanceof HTMLElement&&(r.classList.toggle("hidden",!m),m?r.removeAttribute("aria-hidden"):r.setAttribute("aria-hidden","true"))},Ae=r=>{[l,d,u,c,y,w,U].forEach(m=>{m instanceof HTMLElement&&(m.disabled=!!r,m.classList.toggle("opacity-60",!!r),m.classList.toggle("cursor-not-allowed",!!r))}),_.forEach(m=>{m instanceof HTMLButtonElement&&(m.disabled=!!r,m.classList.toggle("opacity-60",!!r),m.classList.toggle("cursor-not-allowed",!!r))})},le=()=>{t.reset(),zt(),se(null),Ae(!1),Tt(""),U instanceof HTMLSelectElement&&(U.value=""),y instanceof HTMLInputElement&&(y.value=""),d instanceof HTMLInputElement&&(d.value=""),g instanceof HTMLInputElement&&(g.value=""),(k instanceof HTMLTextAreaElement||k instanceof HTMLInputElement)&&(k.value=""),C instanceof HTMLInputElement&&(C.value=""),ye("not_started"),X="simple",Se="save"},Ce=({title:r,description:m,action:E})=>{n&&(n.textContent=r||"Plan lesson"),s&&(s.textContent=m||""),a.textContent=E||"Save lesson"},Ie=({trigger:r}={})=>{L.trigger=r instanceof HTMLElement?r:null,ve=L.trigger||(document.activeElement instanceof HTMLElement?document.activeElement:null),e.classList.remove("hidden"),e.removeAttribute("aria-hidden"),e.removeAttribute("inert"),qt(!0),document.addEventListener("keydown",Wt,!0),e.addEventListener("focusin",jt,!0),window.requestAnimationFrame(()=>{Ot()})},Q=()=>{e.classList.add("hidden"),e.setAttribute("aria-hidden","true"),e.setAttribute("inert",""),qt(!1),document.removeEventListener("keydown",Wt,!0),e.removeEventListener("focusin",jt,!0);let r=L.trigger||ve;L.mode="add",L.lessonId=null,L.trigger=null,se(null),le(),r&&typeof r.focus=="function"&&r.focus({preventScroll:!0})},rs=({defaultDay:r="Monday",trigger:m,timetableEntry:E}={})=>{L.mode="add",L.lessonId=null,le(),I(M,!0),I(N,!0),I(O,!1),I(q,!1),Ae(!1);let j=typeof E?.day=="string"&&E.day.trim()?E.day.charAt(0).toUpperCase()+E.day.slice(1):typeof r=="string"&&r.trim()?r.trim():"Monday";xe(j),u.value=E?.className&&E.className.trim()||(j?`${j} lesson`:""),c.value="",d instanceof HTMLInputElement&&(d.value=E?.period||""),y instanceof HTMLInputElement&&(y.value=E?.subject||""),Tt(E?.id||""),ye("not_started"),X="simple",Ce({title:"Add lesson",description:"Pick a day and capture the lesson focus for this week.",action:"Save lesson"}),se(u),Ie({trigger:m})},ls=({lesson:r,trigger:m}={})=>{if(!r)return;L.mode="edit",L.lessonId=r.id,le(),I(M,!0),I(N,!0),I(O,!1),I(q,!1),Ae(!1);let E=r.dayLabel||r.dayName||"Monday";xe(E),u.value=r.title||"",c.value=r.summary||"",d instanceof HTMLInputElement&&(d.value=r.period||""),y instanceof HTMLInputElement&&(y.value=r.subject||""),Tt(r.timetableEntryId||""),U instanceof HTMLSelectElement&&(U.value=r.timetableEntryId||""),ye(r.status||"not_started"),X=r.templateType||"simple",Ce({title:"Edit lesson",description:"Update the lesson information for this week.",action:"Update lesson"}),se(u),Ie({trigger:m})},cs=({lesson:r,trigger:m}={})=>{if(!r)return;L.mode="detail",L.lessonId=r.id,le(),I(M,!0),I(N,!0),I(O,!0),I(q,!1),Ae(!0);let E=r.dayLabel||r.dayName||"Monday";xe(E),u.value=r.title||"",c.value=r.summary||"",d instanceof HTMLInputElement&&(d.value=r.period||""),y instanceof HTMLInputElement&&(y.value=r.subject||""),ye(r.status||"not_started"),X=r.templateType||"simple",g instanceof HTMLInputElement&&(g.value=""),(k instanceof HTMLTextAreaElement||k instanceof HTMLInputElement)&&(k.value=""),Ce({title:"Add lesson detail",description:"Add a quick badge and note to this lesson.",action:"Save detail"}),se(k instanceof HTMLElement?k:null),Ie({trigger:m})},ds=({suggestedWeekId:r="",trigger:m}={})=>{L.mode="duplicate",L.lessonId=null,le(),I(M,!1),I(N,!1),I(O,!1),I(q,!0),C instanceof HTMLInputElement&&(C.value=r),Ce({title:"Duplicate plan",description:"Copy everything from this week into another week.",action:"Duplicate week"}),se(C instanceof HTMLElement?C:null),Ie({trigger:m})},us=async r=>{r.preventDefault(),zt(),Qt(!0);let m=Se==="add_another";try{if(L.mode==="duplicate"){let S=C?.value?.trim();if(!S){Z("Enter the Monday date for the destination week.");return}if(S===f){Z("Choose a different week to duplicate into.");return}let ce=await duplicateWeekPlan(f,S);ce&&(f=S,Yn(S),T=ce,D(ce),R(ce,S),Q());return}if(L.mode==="detail"){if(!L.lessonId){Z("Select a lesson before adding details.");return}let S=k?.value?.trim();if(!S){Z("Add text for this detail.");return}let ce=g?.value?.trim()||"",Me=await addLessonDetail(f,L.lessonId,{badge:ce,text:S});Me&&(T=Me,D(Me),R(Me,f),Q());return}let E=l.value.trim(),j=d?.value?.trim()||"",st=u.value.trim(),Yt=c.value.trim(),it=y?.value?.trim()||"",Kt=V[w?.value]?w.value:"not_started",Gt=U instanceof HTMLSelectElement?U.value:"",Xt=(()=>{let S=getWeekDateForDayIndex(f,1);return S instanceof Date&&!Number.isNaN(S.getTime())?S.toISOString():""})();if(!E){Z("Choose a day for this lesson.");return}if(!st){Z("Enter a lesson title.");return}if(L.mode==="edit"){if(!L.lessonId){Z("Select a lesson to edit.");return}let S=await updateLessonInWeek(f,L.lessonId,{dayName:E,title:st,summary:Yt,subject:it,period:j,status:Kt,timetableEntryId:Gt,weekStartDate:Xt,templateType:X||"simple"});S&&(T=S,D(S),R(S,f),Q());return}let De=await addLessonToWeek(f,{dayName:E,title:st,summary:Yt,subject:it,period:j,status:Kt,timetableEntryId:Gt,weekStartDate:Xt,templateType:X||"simple"});De&&(T=De,D(De),R(De,f),m?(re=E,nt=it,le(),xe(re||"Monday"),u.value=l.value?`${l.value} lesson`:"",y instanceof HTMLInputElement&&(y.value=nt||""),ye("not_started"),X="simple",se(u)):Q())}catch(E){console.error("Failed to save planner change",E),Z("Unable to save changes right now. Please try again.")}finally{Qt(!1),Se="save"}};return o instanceof HTMLButtonElement&&o.addEventListener("click",()=>Vt("add_another")),a.addEventListener("click",()=>Vt("save")),_.forEach(r=>{r instanceof HTMLButtonElement&&r.addEventListener("click",m=>{m.preventDefault();let E=r.dataset.summaryTemplate||"simple";as(E)})}),t.addEventListener("submit",us),F.forEach(r=>{r.addEventListener("click",m=>{m.preventDefault(),Q()})}),e.addEventListener("click",r=>{r.target===e&&Q()}),P?.addEventListener("click",r=>{r.target===P&&Q()}),{openAddLesson:rs,openEditLesson:ls,openAddDetail:cs,openDuplicatePlan:ds,close:Q}}var En=document.getElementById("remindersCount"),ee=typeof document<"u"?ri():null,Tn=document.getElementById("plannerCount"),Ln=document.getElementById("plannerSubtitle"),Da=document.getElementById("resourcesCount"),Ma=document.getElementById("templatesCount"),Fe=document.getElementById("dailySnapshotList"),He=document.getElementById("todaysFocusList"),Y=document.getElementById("weekAtAGlanceList"),K=null;Y&&(K=document.createElement("li"),K.dataset.emptyState="week",K.className="list-none rounded-xl border border-dashed border-base-300/70 bg-base-100/60 p-4 text-sm italic text-base-content/60",K.textContent="No upcoming events this week.");var wn=()=>{if(!Y||!K)return;Y.querySelectorAll(":scope > li:not([data-empty-state]):not(.hidden):not([hidden])").length===0?Y.contains(K)||Y.appendChild(K):Y.contains(K)&&Y.removeChild(K)};Y&&(wn(),new MutationObserver(wn).observe(Y,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","hidden"]}));var Lt=e=>{ht&&(e?ht.classList.remove("hidden"):ht.classList.add("hidden"))},we={high:{badgeClass:"badge badge-outline text-error",badgeLabel:"High priority",rank:0},medium:{badgeClass:"badge badge-outline text-warning",badgeLabel:"Due soon",rank:1},low:{badgeClass:"badge badge-outline text-secondary",badgeLabel:"Scheduled",rank:2}},kn=(()=>{try{return new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit"})}catch{return null}})(),vn=(()=>{try{return new Intl.DateTimeFormat(void 0,{month:"short",day:"numeric"})}catch{return null}})(),_e=e=>e?(typeof e.title=="string"?e.title.trim():"")||"Untitled reminder":"",Pt=e=>{if(!e?.due)return null;try{let t=new Date(e.due);return Number.isNaN(t.getTime())?null:t}catch{return null}},li=(e,t)=>!e||!t?!1:e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate(),_n=e=>{if(!e)return"";if(kn)try{return kn.format(e)}catch{}let t=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0");return`${t}:${n}`},ci=e=>{if(!e)return"";if(vn)try{return vn.format(e)}catch{}return e.toLocaleDateString()},Vn=e=>{let t=typeof e?.priority=="string"?e.priority.trim().toLowerCase():"";return Object.prototype.hasOwnProperty.call(we,t)?t:"medium"},Sn=e=>{let t=Vn(e);return we[t]?.rank??we.medium.rank},di=e=>{let t=Vn(e);return we[t]??we.medium},xn=e=>{let t=Pt(e);return t?t.getTime():Number.POSITIVE_INFINITY};function qn(e=[]){if(!Fe)return;let t=new Date,n=(Array.isArray(e)?e:[]).map(s=>({reminder:s,date:Pt(s)})).filter(({date:s})=>s&&li(s,t)).sort((s,i)=>s.date.getTime()-i.date.getTime());if(!n.length){Fe.innerHTML='<p class="text-sm italic text-base-content/60">No reminders due today.</p>';return}Fe.innerHTML="",n.forEach(({reminder:s,date:i})=>{let a=document.createElement("li");a.className="rounded-xl border border-base-200 bg-base-100/80 p-3 shadow-sm";let o=document.createElement("p");o.className="font-semibold text-base-content",o.textContent=_e(s),a.appendChild(o);let l=_n(i),d=document.createElement("p");d.className="text-xs text-base-content/70",d.textContent=l?`Due ${l}`:"Due today",a.appendChild(d),Fe.appendChild(a)})}function Un(e=[]){if(!He)return;let t=(Array.isArray(e)?e:[]).filter(n=>n&&!n.done).sort((n,s)=>{let i=Sn(n)-Sn(s);if(i!==0)return i;let a=xn(n)-xn(s);return a!==0?a:_e(n).localeCompare(_e(s),void 0,{sensitivity:"base"})}).slice(0,3);if(!t.length){He.innerHTML='<li class="list-none text-sm italic text-base-content/60">No focus items.</li>';return}He.innerHTML="",t.forEach(n=>{let s=document.createElement("li");s.className="rounded-xl border border-base-200 bg-base-100/80 p-4 shadow-sm";let i=document.createElement("div");i.className="flex items-center justify-between gap-3";let a=document.createElement("p");a.className="font-semibold text-base-content",a.textContent=_e(n),i.appendChild(a);let o=di(n),l=document.createElement("span");l.className=o.badgeClass,l.textContent=o.badgeLabel,i.appendChild(l),s.appendChild(i);let d=Pt(n),u=document.createElement("p");if(u.className="text-xs text-base-content/70",d){let c=_n(d),y=ci(d),w=[];c&&w.push(`Due ${c}`),y&&w.push(y),u.textContent=w.length?w.join(" \u2022 "):"Due soon"}else u.textContent="No due date";s.appendChild(u),He.appendChild(s)})}var ui=e=>{if(!En)return;let t=Array.isArray(e)?e.length:0;En.textContent=String(t)},mi=e=>{let t=Array.isArray(e?.detail?.items)?e.detail.items:[];ui(t),qn(t),Un(t)};document.addEventListener("memoryCue:remindersUpdated",mi);qn();Un();var xt=nn(tn),fi={apiKey:"AIzaSyAmAMiz0zG3dAhZJhOy1DYj8fKVDObL36c",authDomain:"memory-cue-app.firebaseapp.com",projectId:"memory-cue-app",storageBucket:"memory-cue-app.firebasestorage.app",messagingSenderId:"751284466633",appId:"1:751284466633:web:3b10742970bef1a5d5ee18",measurementId:"G-R0V4M7VCE6"},Re=null,pi=3,An=120;function yi(e){if(e==null)return"";let t=String(e).replace(/\s+/g," ").trim();return t?t.length<=An?t:`${t.slice(0,An-1)}\u2026`:""}function hi(e){return!e||typeof e!="object"?!1:[e.pinned,e.isPinned,e.pin].some(n=>{if(typeof n=="boolean")return n;if(typeof n=="string"){let s=n.trim().toLowerCase();return s==="true"||s==="1"||s==="yes"}return!1})}function Cn(e){if(!pe)return;let t=Array.isArray(e)?e:[];if(!t.length){pe.innerHTML='<li class="list-none text-sm italic text-base-content/60">No pinned notes yet.</li>',Lt(!1);return}let n=t.filter(a=>hi(a));if(!n.length){pe.innerHTML='<li class="list-none text-sm italic text-base-content/60">No pinned notes yet.</li>',Lt(!1);return}Lt(!0);let i=n.slice(0,pi).map(a=>{let o=b(de(a,"title")||"Untitled Cue"),l=de(a,"details"),d=b(yi(l)),u=d?`<p class="mt-1 text-sm text-base-content/70">${d}</p>`:"";return`
        <li class="rounded-xl border border-base-300 bg-base-100/80 p-3">
          <p class="font-medium text-base-content">${o}</p>
          ${u}
        </li>
      `}).join("");pe.innerHTML=i}function At(e,{tone:t="muted"}={}){if(!G)return;let n=["text-sm"];n.push(t==="error"?"text-error":"text-base-content/60"),G.innerHTML=`<p class="${n.join(" ")}">${b(e)}</p>`}function gi(e){if(!G)return;if(!Array.isArray(e)||e.length===0){At("No cues yet.");return}let t=e.map(n=>{let s=b(de(n,"title")||"Untitled Cue"),i=b(de(n,"details"));return`
        <div class="card w-96 bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title">${s}</h2>
            ${i?`<p>${i}</p>`:""}
            <div class="card-actions justify-end">
              <div class="dropdown dropdown-left">
                <label tabindex="0" class="btn btn-ghost btn-xs m-1">...</label>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                  <li><a class="edit-btn" data-id="${b(n.id)}">Edit</a></li>
                  <li><a class="delete-btn" data-id="${b(n.id)}">Delete</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      `}).join("");G.innerHTML=t}async function ke(){return Re||(Re=(async()=>{let[{initializeApp:e,getApps:t},{getFirestore:n,enableMultiTabIndexedDbPersistence:s,enableIndexedDbPersistence:i,collection:a,doc:o,getDoc:l,addDoc:d,updateDoc:u,getDocs:c,query:y,orderBy:w,serverTimestamp:g,setDoc:k,arrayUnion:C}]=await Promise.all([import("https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js"),import("https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js")]),_=t(),M=_&&_.length?_[0]:e(fi),N=n(M);(function(){let B=typeof window<"u"?window:typeof globalThis<"u"?globalThis:null;B&&(B.__persistenceInitialized__||(B.__persistenceInitialized__=!0,(async()=>{try{await s(N),console.info("[Firestore] Persistence: multi-tab enabled")}catch(P){if(P&&P.code==="failed-precondition")try{await i(N),console.info("[Firestore] Persistence: single-tab fallback enabled")}catch(F){console.warn("[Firestore] Persistence disabled (single-tab fallback failed):",F?.code||F)}else P&&P.code==="unimplemented"?console.warn("[Firestore] Persistence not supported in this browser (online-only)."):console.warn("[Firestore] Persistence initialization error:",P?.code||P)}})()))})();let O=a(N,"cues");return{db:N,cuesCollection:O,getCollection:a,doc:o,getDoc:l,addDoc:d,updateDoc:u,getDocs:c,query:y,orderBy:w,serverTimestamp:g,setDoc:k,arrayUnion:C}})().catch(e=>{throw console.error("Failed to initialise Firestore for cues",e),e}),Re)}async function bi(){let e=await ke(),{getDocs:t,cuesCollection:n,query:s,orderBy:i}=e,a=s&&i?s(n,i("createdAt","desc")):n;return(await t(a)).docs.map(l=>({id:l.id,...l.data()}))}async function Ei(e){if(!e)return null;let t=await ke(),{db:n,doc:s,getDoc:i}=t,a=s(n,"cues",e),o=await i(a);return o.exists()?{id:o.id,...o.data()}:null}async function On(){if(!(!G&&!pe))try{let e=await bi();gi(e),Cn(e)}catch(e){console.error("Failed to load cues",e),isPermissionDeniedError(e)?At("Sign in to view your cues.",{tone:"muted"}):At("Unable to load cues right now.",{tone:"error"}),Cn([])}}function Ti(e){!oe||!W||(sn(e,xt),W.value=e?.id||"",z?.setEditMode(!0),z?.show({mode:"edit"}))}async function Li(e){let t=e.target instanceof Element?e.target.closest(".edit-btn"):null;if(!t)return;e.preventDefault();let n=t.getAttribute("data-id");if(n)try{let s=await Ei(n);if(!s)return;Ti(s)}catch(s){console.error("Failed to prepare cue for editing",s)}}async function wi(e){if(e.preventDefault(),!oe||!W)return;let t=W.value.trim(),n=on(xt);try{let s=await ke(),{db:i,doc:a,addDoc:o,updateDoc:l,cuesCollection:d,serverTimestamp:u}=s,c=typeof u=="function"?u():null;if(t){let y=a(i,"cues",t),w={...n};c&&(w.updatedAt=c),await l(y,w)}else{let y={...n};c&&(y.createdAt=c,y.updatedAt=c),await o(d,y)}await On(),an(xt,W,z?.modalTitle??null,Ns),await z?.hide({reason:"form-submit"})}catch(s){console.error("Failed to save cue",s)}}async function ki(){!oe||!W||!G||(G.addEventListener("click",Li),oe.addEventListener("submit",wi))}oe&&W&&(document.addEventListener("cue:prepare",()=>{W.value="",z?.setEditMode(!1)}),document.addEventListener("cue:close",()=>{W.value="",z?.setEditMode(!1)}));oe&&W&&G&&ki().catch(e=>{console.error("Failed to initialise cue editing",e)});(G||pe)&&On();var Je=getPlannerWeekIdFromDate(),Ve=!1,f=Je,T=null,Ee=null,A=null,Ft=getTimetableEntries(),Ke=new Map,vi=800,jn=1500,Ct={idle:"Notes save automatically.",saving:"Saving\u2026",saved:"Saved",error:"Unable to save"},Wn=new Set(["saving","saved","error"]),zn="plannerNotesOpenState",ae=xi(),$e=null,Qn="list",Si=800;function xi(){if(typeof localStorage>"u")return{};try{let e=localStorage.getItem(zn);if(!e)return{};let t=JSON.parse(e);return t&&typeof t=="object"?t:{}}catch(e){return console.warn("Unable to load planner notes state",e),{}}}function Ai(){if(!(typeof localStorage>"u"))try{localStorage.setItem(zn,JSON.stringify(ae))}catch(e){console.warn("Unable to persist planner notes state",e)}}function Ci(e){return e?!!ae?.[e]:!1}function Ii(e,t){if(e){if(t)ae={...ae,[e]:!0};else if(ae?.[e]){let n={...ae};delete n[e],ae=n}Ai()}}function Di(e,t=Je){return Array.isArray(e)?e:e&&typeof e=="object"&&Array.isArray(e.lessons)?e.lessons:typeof t=="string"&&t?getPlannerLessonsForWeek(t):[]}var Mi=(e=[])=>{if(!Tn)return;let t=Array.isArray(e)?e.length:0;Tn.textContent=String(t)};function Bi(e=[]){let t=Array.isArray(e)?e:[];if(hn&&(hn.textContent=String(t.length)),gn){let n=new Set;t.forEach(s=>{let i=Ht(s);i&&n.add(i.toLowerCase())}),gn.textContent=String(n.size)}if(bn){let n=t.filter(s=>typeof s.notes=="string"&&s.notes.trim().length>0).length;bn.textContent=String(n)}}function R(e,t){let n=Di(e,t);Mi(n);let s=e?.weekId||t||Je,i=getWeekLabel(s,{short:!0});Ln&&(Ln.textContent=i||""),yn&&(yn.textContent=String(n.length)),je&&(je.textContent=i||""),Bi(n)}function Ge(e,{tone:t="muted"}={}){if(!x)return;A=null;let n=["rounded-xl","border","border-dashed","border-base-300/70","bg-base-100/60","p-4","text-sm"];n.push(t==="error"?"text-error":"text-base-content/70"),x.innerHTML=`<p class="${n.join(" ")}">${b(e)}</p>`}function Yn(e){if(!pn)return;let t=getWeekLabel(e);pn.textContent=t||"",je&&(je.textContent=t||"")}function Kn(e=f){let t=getWeekDateForDayIndex(e,1);return t instanceof Date&&!Number.isNaN(t.getTime())?t.toISOString():""}function Ht(e){return!e||typeof e!="object"?"":typeof e.subject=="string"?e.subject.trim():""}function Gn(e){if(!e)return"badge-ghost";let t=e.toLowerCase();return t.includes("hpe")||t.includes("pe")?"badge-info":t.includes("english")?"badge-success":t.includes("civics")||t.includes("cac")?"badge-secondary":t.includes("geo")?"badge-warning":"badge-ghost"}var V={not_started:{label:"Not started",badge:"badge-ghost"},in_progress:{label:"In progress",badge:"badge-warning"},ready:{label:"Ready",badge:"badge-success"},taught:{label:"Taught",badge:"badge-neutral"}};function Ni(e){if(!e)return"";let t=Ye(e.day||"Monday"),n=e.period?e.period:"Lesson",s=e.subject?`<span class="badge badge-ghost badge-xs">${b(e.subject)}</span>`:"";return`
    <article
      class="flex h-full flex-col justify-between rounded-2xl border border-dashed border-base-300/80 bg-base-100/70 px-4 py-4 text-left text-base-content shadow-sm"
      data-planner-slot="true"
      data-timetable-entry="${e.id}"
    >
      <div class="space-y-2">
        <p class="label-text">${b(t)} \xB7 ${b(n)}</p>
        <p class="text-base font-semibold">${b(e.className||"Timetable slot")}</p>
        ${e.subject?`<p class="text-xs text-base-content/70">${b(e.subject)}</p>`:""}
      </div>
      <div class="flex flex-wrap items-center justify-between gap-2 pt-3">
        <div class="flex flex-wrap gap-2">${s}</div>
        <button
          type="button"
          class="btn btn-primary btn-xs"
          data-planner-action="create-slot"
          data-timetable-entry-id="${e.id}"
        >
          Plan lesson
        </button>
      </div>
    </article>
  `}function Rt(e=[],t=f){let n=Array.isArray(e)?e:[],s=new Set,i=Kn(t),a=[];return Ft.forEach(o=>{let l=n.find(u=>u.timetableEntryId===o.id),d=Qe(Number(o.dayIndex));l?(s.add(l.id),a.push({type:"lesson",entry:o,lesson:l,dayIndex:d})):a.push({type:"slot",entry:o,lesson:null,dayIndex:d,weekStartDate:i})}),n.forEach(o=>{if(s.has(o.id))return;let l=Qe(Number(o.dayIndex));a.push({type:"lesson",entry:null,lesson:o,dayIndex:l,isLoose:!0})}),a.sort((o,l)=>{if(o.dayIndex!==l.dayIndex)return o.dayIndex-l.dayIndex;let d=o.entry?.period||o.lesson?.period||"",u=l.entry?.period||l.lesson?.period||"";if(d&&u&&d!==u)return d.localeCompare(u,void 0,{numeric:!0,sensitivity:"base"});let c=o.entry?.className||o.lesson?.title||"",y=l.entry?.className||l.lesson?.title||"";return c.localeCompare(y)})}function Pi(e,t){let n=V[t]?t:"not_started",s=Object.entries(V).map(([i,a])=>`<option value="${i}" ${i===n?"selected":""}>${b(a.label)}</option>`).join("");return`
    <label class="flex items-center gap-2 text-xs font-semibold text-base-content/80">
      <span>Status</span>
      <select class="select select-bordered select-xs" data-lesson-status="true" data-lesson-id="${e}">
        ${s}
      </select>
    </label>
  `}function Fi(e=[],t=""){return e.length?`
    <ul class="space-y-2">
      ${e.map(n=>{let s=typeof n?.label=="string"&&n.label.trim()?n.label.trim():"Resource",i=typeof n?.url=="string"?n.url.trim():"",a=typeof n?.id=="string"?n.id:"",o=i?`<a class="link link-primary break-words" href="${i}" target="_blank" rel="noreferrer">${b(s)}</a>`:`<span class="text-base-content">${b(s)}</span>`,l=a?`<button class="btn btn-ghost btn-xs text-error" type="button" data-planner-action="remove-resource" data-lesson-id="${t}" data-resource-id="${a}">Remove</button>`:"";return`<li class="flex items-start justify-between gap-2 rounded-lg bg-base-200/70 px-2 py-1">${o}${l}</li>`}).join("")}
    </ul>
  `:'<p class="text-xs text-base-content/60">No resources added yet.</p>'}function D(e){if(!x)return;Vi(e);let t=Array.isArray(e?.lessons)?e.lessons:[],n=e?.weekId||f||Je,s=Rt(t,n),i=t,a=s.some(c=>c.type==="slot");if(!t.length&&!a){Ge("No lessons or timetable slots yet. Start by adding a timetable entry."),qe([],s);return}let o=i.map(c=>typeof c.id=="string"&&c.id?c.id:"").filter(c=>!!c);A&&!o.includes(A)&&(A=null);let l=i.map(c=>{let y=Array.isArray(c.details)?c.details.map(re=>`
                <li class="flex items-center gap-2">
                  ${re.badge?`<span class="badge badge-outline badge-sm text-secondary">${b(re.badge)}</span>`:""}
                  <span class="text-sm text-base-content/80">${b(re.text)}</span>
                </li>
              `).join(""):"",w=y?`<ul class="space-y-2 text-sm text-base-content/80">${y}</ul>`:'<p class="text-sm text-base-content/60">No details yet.</p>',g=typeof c.id=="string"?c.id:"",k=!!(A&&g&&A===g),C=["data-planner-lesson",g?`data-lesson-id="${g}"`:"",k?'data-planner-selected="true"':""].filter(Boolean).join(" "),_=c.summary?`<p class="text-sm text-base-content/80">${b(c.summary)}</p>`:"",M=Ht(c),N=Gn(M),O=M?`<span class="badge ${N} badge-sm">${b(M)}</span>`:"",q=typeof c.notes=="string"?c.notes:"",B=Ci(g),P=g?`
            <details
              class="planner-notes-collapse"
              data-planner-notes-collapse="true"
              data-lesson-id="${g}"
              ${B?"open":""}
            >
              <summary class="planner-notes-summary">
                <span class="label-text text-xs font-semibold uppercase tracking-[0.3em] text-base-content/60">Lesson notes</span>
                <span class="planner-notes-summary-indicator" aria-hidden="true"></span>
              </summary>
              <div class="planner-notes-panel">
                <label class="form-control w-full gap-1">
                  <textarea
                    class="textarea textarea-bordered w-full min-h-[6rem] text-base-content"
                    data-planner-notes="true"
                    data-lesson-id="${g}"
                    placeholder="Write lesson notes"
                    spellcheck="true"
                    aria-label="Lesson notes"
                  >${b(q)}</textarea>
                  <div class="label py-1">
                    <span class="label-text-alt text-xs text-base-content/60">
                      Status:
                      <span
                        data-notes-status-text
                        data-status="idle"
                        role="status"
                        aria-live="polite"
                      >${b(Ct.idle)}</span>
                    </span>
                  </div>
                </label>
              </div>
            </details>
          `:"",F=g?`
            <div class="dropdown dropdown-end">
              <label tabindex="0" class="btn btn-ghost btn-circle btn-sm" aria-label="Lesson actions">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4">
                  <circle cx="12" cy="6" r="1.5" />
                  <circle cx="12" cy="12" r="1.5" />
                  <circle cx="12" cy="18" r="1.5" />
                </svg>
              </label>
              <ul tabindex="0" class="dropdown-content menu rounded-box z-[1] mt-2 w-48 bg-base-100 p-2 shadow">
                <li><button type="button" data-planner-action="move-up" data-lesson-id="${g}">Move up</button></li>
                <li><button type="button" data-planner-action="move-down" data-lesson-id="${g}">Move down</button></li>
                <li><button type="button" data-planner-action="duplicate" data-lesson-id="${g}">Duplicate</button></li>
                <li><button type="button" data-planner-action="edit" data-lesson-id="${g}">Edit</button></li>
                <li>
                  <button type="button" class="text-error" data-planner-action="delete" data-lesson-id="${g}">
                    Delete
                  </button>
                </li>
              </ul>
            </div>
          `:"",p=`
        <div class="dropdown">
          <label tabindex="0" class="btn btn-sm btn-outline gap-2" aria-label="Add lesson detail or reminder">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-4 w-4">
              <path d="M12 5c.552 0 1 .448 1 1v5h5a1 1 0 1 1 0 2h-5v5a1 1 0 1 1-2 0v-5H6a1 1 0 1 1 0-2h5V6c0-.552.448-1 1-1Z" />
            </svg>
            Add
          </label>
          <ul tabindex="0" class="dropdown-content menu rounded-box z-[1] mt-2 w-56 bg-base-100 p-2 shadow">
            <li>
              <button type="button" data-planner-action="add-detail" data-lesson-id="${g}">Add detail</button>
            </li>
            <li>
              <button
                type="button"
                data-planner-action="create-reminder"
                data-open-reminder-modal="true"
                data-lesson-id="${g}"
              >
                Create reminder
              </button>
            </li>
          </ul>
        </div>
      `,h=g?Pi(g,c.status):"",v=Fi(Array.isArray(c.resources)?c.resources:[],g),H=V[c.status]?.badge||V.not_started.badge,L=V[c.status]?.label||V.not_started.label,ne=[c.weekDay||c.dayLabel||"Lesson"];c.period&&ne.push(c.period);let ve=ne.filter(Boolean).join(" \xB7 ");return`
        <article class="card border border-base-300 bg-base-100 shadow-lg transition hover:-translate-y-1 hover:shadow-xl" ${C}>
          <div class="card-body gap-4">
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-2">
                <div class="flex flex-wrap items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-base-content/60">
                  <span>${b(ve)}</span>
                  <span class="badge ${H} badge-xs">${b(L)}</span>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                  <h2 class="text-lg font-semibold text-base-content">${b(c.title||c.dayLabel||"Lesson")}</h2>
                  ${O}
                </div>
                ${_}
                <div class="flex flex-wrap items-center gap-3">
                  ${h}
                </div>
              </div>
              <div class="flex flex-col items-end gap-2">
                ${F}
              </div>
            </div>
            ${w}
            <div class="rounded-xl border border-base-200 bg-base-200/60 p-3">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <div>
                  <p class="text-xs font-semibold uppercase tracking-[0.2em] text-base-content/60">Resources</p>
                  <p class="text-xs text-base-content/70">Link slides, videos, and activity sheets.</p>
                </div>
                <span class="badge badge-outline badge-sm">${Array.isArray(c.resources)?c.resources.length:0} linked</span>
              </div>
              <div class="mt-2 space-y-2">
                ${v}
                <div class="grid gap-2 md:grid-cols-[1fr_1.5fr_auto]">
                  <input
                    type="text"
                    class="input input-bordered input-sm w-full"
                    placeholder="Label (e.g. Slides)"
                    data-resource-label="true"
                    data-lesson-id="${g}"
                  />
                  <input
                    type="url"
                    class="input input-bordered input-sm w-full"
                    placeholder="URL"
                    data-resource-url="true"
                    data-lesson-id="${g}"
                  />
                  <button
                    type="button"
                    class="btn btn-outline btn-sm"
                    data-planner-action="add-resource"
                    data-lesson-id="${g}"
                  >
                    Add resource
                  </button>
                </div>
              </div>
            </div>
            ${P}
            <div class="flex flex-wrap items-center gap-2">
              <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-xs">Add template</label>
                <ul tabindex="0" class="dropdown-content menu rounded-box z-[1] mt-2 w-64 bg-base-100 p-2 shadow">
                  <li><button type="button" data-planner-action="apply-template" data-template-type="simple" data-lesson-id="${g}">Simple lesson template</button></li>
                  <li><button type="button" data-planner-action="apply-template" data-template-type="hpe" data-lesson-id="${g}">HPE lesson template</button></li>
                  <li><button type="button" data-planner-action="apply-template" data-template-type="english" data-lesson-id="${g}">English lesson template</button></li>
                  <li><button type="button" data-planner-action="apply-template" data-template-type="cac" data-lesson-id="${g}">CAC lesson template</button></li>
                </ul>
              </div>
              ${p}
            </div>
          </div>
        </article>
      `}).join(""),d=s.filter(c=>c.type==="slot"&&c.entry).map(c=>Ni(c.entry)).join(""),u=[l,d].filter(Boolean).join("");if(!u){Ge("No lessons or timetable slots yet. Start by adding a timetable entry."),qe([],s);return}x.innerHTML=u,$t(A),qe(i,s)}function qe(e=[],t=null){if(!Le)return;let n=Array.isArray(t)?t:Rt(e,f),i=[{day:"Monday",index:1},{day:"Tuesday",index:2},{day:"Wednesday",index:3},{day:"Thursday",index:4},{day:"Friday",index:5}].map(o=>({...o,items:[]}));n.forEach(o=>{let l=Qe(Number(o?.dayIndex)),d=i.find(u=>u.index===l);d&&d.items.push(o)});let a=i.map(({day:o,items:l})=>{let d=l.map(c=>{if(c.type==="slot"&&c.entry){let _=c.entry.period?` \xB7 ${b(c.entry.period)}`:"",M=c.entry.subject?`<span class="badge badge-ghost badge-xs">${b(c.entry.subject)}</span>`:"";return`
              <div class="rounded-xl border border-dashed border-base-200 bg-base-100 px-3 py-2">
                <div class="flex items-start justify-between gap-2">
                  <div>
                    <p class="text-xs font-semibold text-base-content/70">${b(c.entry.className||"Timetable slot")}</p>
                    <p class="text-xs text-base-content/60">${b(Ye(c.entry.day||o)+_)}</p>
                  </div>
                  ${M}
                </div>
                <div class="mt-2 flex flex-wrap justify-end">
                  <button class="btn btn-primary btn-ghost btn-xs" type="button" data-planner-action="create-slot" data-timetable-entry-id="${c.entry.id}">Plan lesson</button>
                </div>
              </div>
            `}let y=c.lesson||c,w=Ht(y),g=Gn(w),k=V[y.status]?.label||V.not_started.label,C=V[y.status]?.badge||V.not_started.badge;return`
            <button
              type="button"
              class="w-full text-left rounded-xl border border-base-200 bg-base-100 px-3 py-2 shadow-sm transition hover:-translate-y-[1px] hover:shadow"
              data-week-view-lesson="${y.id||""}"
            >
              <div class="flex items-start justify-between gap-2">
                <div>
                  <p class="text-xs font-semibold text-base-content/70">${b(y.title||y.dayLabel||"Lesson")}</p>
                  <p class="text-xs text-base-content/60">${b(y.summary||"")}</p>
                </div>
                <div class="flex flex-col items-end gap-1">
                  ${w?`<span class="badge ${g} badge-xs">${b(w)}</span>`:""}
                  <span class="badge ${C} badge-xs">${b(k)}</span>
                </div>
              </div>
            </button>
          `}).join("");return`
        <div class="space-y-2 rounded-2xl border border-base-200 bg-base-200/50 p-3">
          <p class="text-xs font-semibold uppercase tracking-[0.25em] text-base-content/70">${o}</p>
          <div class="space-y-2">${d||'<p class="text-xs text-base-content/60">No lessons yet.</p>'}</div>
        </div>
      `}).join("");Le.innerHTML=a}function Ue(e="list"){let t=e==="week"?"week":"list";if(Qn=t,x&&x.classList.toggle("hidden",t==="week"),Le&&Le.classList.toggle("hidden",t!=="week"),kt instanceof HTMLElement&&kt.setAttribute("aria-pressed",t==="list"?"true":"false"),vt instanceof HTMLElement&&vt.setAttribute("aria-pressed",t==="week"?"true":"false"),t==="week"){let n=T?.lessons||[];qe(n,Rt(n,f))}}function $t(e){A=e||null,x&&x.querySelectorAll("[data-planner-lesson]").forEach(n=>{!!e&&n.getAttribute("data-lesson-id")===e?n.setAttribute("data-planner-selected","true"):n.removeAttribute("data-planner-selected")})}function Hi(e){let t=e.target instanceof Element?e.target.closest("[data-week-view-lesson]"):null;if(!t)return;let n=t.getAttribute("data-week-view-lesson");if(!n)return;Ue("list"),$t(n);let s=x?.querySelector(`[data-lesson-id="${n}"]`);s instanceof HTMLElement&&typeof s.scrollIntoView=="function"&&s.scrollIntoView({behavior:"smooth",block:"center"})}function Ri(){return A&&(Array.isArray(T?.lessons)?T.lessons:[]).some(t=>t.id===A)?A:null}function $i(e){let t=e.target instanceof Element?e.target.closest("[data-planner-lesson][data-lesson-id]"):null;if(!t)return;let n=t.getAttribute("data-lesson-id");!n||n===A||$t(n)}function _i(e){let t=St(e?.currentTarget)?e.currentTarget:Oe;if(!St(t))return;let n=t.value,s=Xe.has(n)?n:We;Pn(s),ti(s),t.value!==s&&(t.value=s)}function et(){return typeof window<"u"&&typeof window.setTimeout=="function"?window.setTimeout.bind(window):typeof setTimeout=="function"?setTimeout:null}function Xn(){return typeof window<"u"&&typeof window.clearTimeout=="function"?window.clearTimeout.bind(window):typeof clearTimeout=="function"?clearTimeout:null}function Zn(e){if(!e)return;let t=Ke.get(e);if(!t)return;let n=Xn();n&&n(t),Ke.delete(e)}function ge(e,t){if(!(e instanceof HTMLTextAreaElement))return;let n=typeof t=="string"&&Wn.has(t)?t:null;n?e.setAttribute("data-notes-status",n):e.removeAttribute("data-notes-status")}function be(e,t){if(!(e instanceof HTMLTextAreaElement))return;let n=typeof t=="string"&&Wn.has(t)?t:null,s=e.parentElement instanceof HTMLElement?e.parentElement.querySelector("[data-notes-status-text]"):null;if(s instanceof HTMLElement){let i=n||"idle",a=Ct[i]||Ct.idle;s.textContent=a,s.setAttribute("data-status",i)}}function Vi(e){if(!(J instanceof HTMLTextAreaElement))return;me("idle");let t=typeof e?.teacherNotes=="string"?e.teacherNotes:"";J.value!==t&&(J.value=t)}function me(e="idle"){if(!(bt instanceof HTMLElement))return;let t={idle:"Notes save automatically.",saving:"Saving\u2026",saved:"Saved",error:"Unable to save"},n=t[e]||t.idle;bt.textContent=n,bt.setAttribute("data-status",e)}async function qi(e){if(f){me("saving");try{let t=await updatePlannerTeacherNotes(f,e);t&&(T=t),me("saved");let n=et();n?n(()=>me("idle"),jn):me("idle")}catch(t){console.error("Failed to save teacher notes",t),me("error")}}}function Ui(e){if(!(J instanceof HTMLTextAreaElement)||e?.target!==J)return;if($e){let n=Xn();n&&n($e)}let t=et();t&&($e=t(()=>{$e=null,qi(J.value)},Si))}function Jn(e="simple"){switch(e){case"hpe":return`Focus skill:
Warm-up:
Skill drill:
Modified game:
Reflection questions:`;case"english":return`Text focus:
Discussion questions:
Mentor sentence:
Writing task:
Reflection / exit ticket:`;case"cac":return`Civics topic:
Key terms:
Source / video:
Discussion questions:
Activity:
Reflection question:`;case"simple":default:return`Learning intention:
Success criteria:
Warm-up:
Main activity:
Exit task:`}}async function Oi(e,t){if(!e)return;await tt();let n=T?.lessons?.find(o=>o.id===e);if(!n)return;let s=Jn(t),i=typeof n.notes=="string"?n.notes:"";if(i&&typeof window<"u"&&typeof window.confirm=="function"&&!window.confirm("Add this template to the existing notes?"))return;let a=i?`${i.trim()}

${s}`:s;try{let o=await updateLessonInWeek(f,e,{notes:a,templateType:t||"simple"});o&&(T=o,D(o),R(o,f))}catch(o){console.error("Failed to apply lesson template",o)}}async function ji(e){let t=e.target instanceof HTMLSelectElement&&e.target.hasAttribute("data-lesson-status")?e.target:null;if(!t)return;let n=t.getAttribute("data-lesson-id"),s=t.value;if(n)try{let i=await updateLessonInWeek(f,n,{status:s});i&&(T=i,D(i),R(i,f))}catch(i){console.error("Failed to update lesson status",i)}}async function Wi(e,t,n){if(!e||!(t instanceof HTMLInputElement)||!(n instanceof HTMLInputElement))return;let s=t.value.trim(),i=n.value.trim();if(!s&&!i)return;let a=T?.lessons?.find(l=>l.id===e);if(!a)return;let o=Array.isArray(a.resources)?[...a.resources]:[];o.push({id:Nt("resource"),label:s,url:i});try{let l=await updateLessonInWeek(f,e,{resources:o});l&&(T=l,D(l)),t.value="",n.value=""}catch(l){console.error("Failed to add resource",l)}}async function zi(e,t){if(!e||!t)return;let n=T?.lessons?.find(i=>i.id===e);if(!n)return;let s=(n.resources||[]).filter(i=>i?.id!==t);try{let i=await updateLessonInWeek(f,e,{resources:s});i&&(T=i,D(i))}catch(i){console.error("Failed to remove resource",i)}}async function It(e,t,n){if(!e||!f)return;let s=n instanceof HTMLTextAreaElement?n:null;s&&(ge(s,"saving"),be(s,"saving"));try{let i=await updateLessonInWeek(f,e,{notes:t});if(i&&(T=i),s){ge(s,"saved"),be(s,"saved");let a=et();a?a(()=>{s.getAttribute("data-notes-status")==="saved"&&(ge(s,null),be(s,null))},jn):(ge(s,null),be(s,null))}}catch(i){console.error("Failed to save planner notes",i),s&&(ge(s,"error"),be(s,"error"))}}function Qi(e){let t=e.target instanceof HTMLTextAreaElement?e.target:null;if(!t||!t.hasAttribute("data-planner-notes"))return;let n=t.getAttribute("data-lesson-id");if(!n)return;Zn(n);let s=et();if(!s){It(n,t.value,t);return}let i=s(()=>{Ke.delete(n),It(n,t.value,t)},vi);Ke.set(n,i)}function Yi(e){let t=e.target instanceof HTMLTextAreaElement?e.target:null;if(!t||!t.hasAttribute("data-planner-notes"))return;let n=t.getAttribute("data-lesson-id");n&&(Zn(n),It(n,t.value,t))}function Ki(e){let t=e.target instanceof HTMLDetailsElement?e.target:null;if(!t||!t.hasAttribute("data-planner-notes-collapse"))return;let n=t.getAttribute("data-lesson-id");if(!n)return;let s=t.hasAttribute("open");Ii(n,s)}function fe(e){if(!x)return Ee=null,Promise.resolve();let t=e||getPlannerWeekIdFromDate();f=t,Yn(t),Ge("Loading plan\u2026");let n=(async()=>{try{let s=await loadWeekPlan(t);T=s,D(s),R(s,t)}catch(s){console.error("Failed to load planner week",s),Ge("Unable to load this week's planner.",{tone:"error"})}})();return Ee=n,n.finally(()=>{Ee===n&&(Ee=null)})}async function tt(){if(!x)return;Ve||_t();let e=Ee;if(!e&&(!T||T.weekId!==f)&&(e=fe(f)),e&&typeof e.then=="function")try{await e}catch(t){console.error("Planner failed to load",t)}}async function Gi(e,t){if(!e)return;await tt();let n=Array.isArray(T?.lessons)?T.lessons:[];if(!n.length)return;let s=n.find(g=>g?.id===e);if(!s)return;let i=typeof s.dayLabel=="string"&&s.dayLabel.trim()?s.dayLabel.trim():typeof s.dayName=="string"&&s.dayName.trim()?s.dayName.trim():"",a=typeof s.title=="string"&&s.title.trim()?s.title.trim():i||"Lesson",o=typeof s.summary=="string"&&s.summary.trim()?s.summary.trim():"",l=o||a,d=i?`${i} \xB7 ${l}`:l,u=o||"",c=ii(s),y=ai(getWeekDateForDayIndex(f,c)),w={reminderTitle:d,reminderNotes:u,dueDate:y,dayLabel:i,lessonTitle:a,summary:o,plannerLessonId:e};ut("cue:prepare",{trigger:t,source:"planner"}),ut("planner:prefillReminder",w),ut("cue:open",{trigger:t,source:"planner"})}async function Xi(e,t){if(!e)return;await tt();let s=(Array.isArray(T?.lessons)?T.lessons:[]).find(l=>l?.id===e);if(!s)return;let i=t instanceof HTMLElement?t:null;i&&i.setAttribute("disabled","true");let a=Nt("lesson"),o={id:a,dayIndex:s.dayIndex,dayLabel:s.dayLabel,dayName:s.dayName,title:s.title,summary:s.summary,subject:s.subject,notes:s.notes,period:s.period,templateType:s.templateType||"simple",status:"not_started",resources:Array.isArray(s.resources)?s.resources.map(l=>({label:l?.label||"",url:l?.url||""})):[],details:Array.isArray(s.details)?s.details.map(l=>({badge:l?.badge||"",text:l?.text||""})):[]};try{let l=await addLessonToWeek(f,o),d=l;l&&Number.isFinite(s.position)&&(d=await updateLessonInWeek(f,a,{position:s.position+.1})),d&&(T=d,A=a,D(d),R(d,f),$&&($.textContent=`Duplicated ${s.title||"lesson"} into this week.`))}catch(l){console.error("Failed to duplicate planner lesson",l),typeof window<"u"&&typeof window.alert=="function"&&window.alert("Unable to duplicate that lesson right now.")}finally{i&&i.removeAttribute("disabled")}}async function Zi(e,t){if(!e||!f)return;let n=Ft.find(i=>i.id===e);if(!n)return;let s=t instanceof HTMLElement?t:null;s&&s.setAttribute("disabled","true");try{let i=Kn(f),a=await addLessonToWeek(f,{dayIndex:Qe(Number(n.dayIndex)),dayName:Ye(n.day),title:n.className||Ye(n.day||"Monday"),summary:"",subject:n.subject||"",period:n.period||"",status:"not_started",timetableEntryId:n.id,weekStartDate:i});a&&(T=a,A=a.lessons?.find(l=>l.timetableEntryId===n.id&&(!l.weekStartDate||l.weekStartDate===i))?.id||A,D(a),R(a,f))}catch(i){console.error("Failed to create lesson from timetable slot",i)}finally{s&&s.removeAttribute("disabled")}}async function Ji(e){let t=e.target instanceof Element?e.target.closest("[data-planner-action]"):null;if(!t)return;e.preventDefault();let n=t.getAttribute("data-planner-action"),s=t.getAttribute("data-lesson-id");if(n)switch(n){case"add-detail":sa(s,t);break;case"edit":ia(s,t);break;case"delete":aa(s);break;case"duplicate":await Xi(s,t);break;case"apply-template":{let i=t.getAttribute("data-template-type")||"simple";Oi(s,i);break}case"add-resource":{let i=t.closest("[data-planner-lesson]"),a=i?.querySelector("input[data-resource-label][data-lesson-id]"),o=i?.querySelector("input[data-resource-url][data-lesson-id]");await Wi(s,a,o);break}case"remove-resource":{let i=t.getAttribute("data-resource-id");await zi(s,i);break}case"move-up":In(s,"up",t);break;case"move-down":In(s,"down",t);break;case"create-reminder":await Gi(s,t);break;case"create-slot":{let i=t.getAttribute("data-timetable-entry-id");await Zi(i,t);break}default:break}}async function es(e){if(typeof document>"u"||!ee)return;e?.preventDefault?.();let t=e?.currentTarget instanceof HTMLElement?e.currentTarget:null,n=T?.lessons?.[0]?.dayLabel||"Monday";ee.openAddLesson({defaultDay:n,trigger:t})}async function ea(e){if(!ee)return;e?.preventDefault?.();let t=e?.currentTarget instanceof HTMLElement?e.currentTarget:null,n=getWeekIdFromOffset(f,1);ee.openDuplicatePlan({suggestedWeekId:n,trigger:t})}async function ta(e){if(!f)return;e?.preventDefault?.();let t=e?.currentTarget instanceof HTMLElement?e.currentTarget:null,n=getWeekIdFromOffset(f,-1);if(n){t&&t.setAttribute("disabled","true");try{let s=await duplicateWeekPlan(n,f);s&&(T=s,A=null,D(s),R(s,f),$&&($.textContent="Copied last week into this plan."))}catch(s){console.error("Failed to copy previous planner week",s),typeof window<"u"&&typeof window.alert=="function"&&window.alert("Unable to copy last week right now.")}finally{t&&t.removeAttribute("disabled")}}}async function na(e){if(!f)return;e?.preventDefault?.();let t=!0;if(typeof window<"u"&&typeof window.confirm=="function"&&(t=window.confirm("Clear all lessons for this week?")),!t)return;let n=e?.currentTarget instanceof HTMLElement?e.currentTarget:null;n&&n.setAttribute("disabled","true");try{let s=await clearWeekPlan(f);s&&(T=s,A=null,D(s),R(s,f),$&&($.textContent="Cleared this week's plan."))}catch(s){console.error("Failed to clear planner week",s),typeof window<"u"&&typeof window.alert=="function"&&window.alert("Unable to clear this week right now.")}finally{n&&n.removeAttribute("disabled")}}async function sa(e,t){if(!e||!ee)return;let n=T?.lessons?.find(i=>i.id===e);if(!n)return;let s=t instanceof HTMLElement?t:null;ee.openAddDetail({lesson:n,trigger:s})}async function ia(e,t){if(!e||!ee)return;let n=T?.lessons?.find(i=>i.id===e);if(!n)return;let s=t instanceof HTMLElement?t:null;ee.openEditLesson({lesson:n,trigger:s})}async function In(e,t,n){if(!e||!t)return;let s=f||getPlannerWeekIdFromDate();if(!s)return;let i=n instanceof HTMLElement?n:null;i&&i.setAttribute("disabled","true");try{let a=await movePlannerLesson(s,e,t);a&&(T=a,D(a),R(a,s))}catch(a){console.error("Failed to move planner lesson",a),typeof window<"u"&&typeof window.alert=="function"&&window.alert("Unable to move that lesson right now.")}finally{i&&i.removeAttribute("disabled")}}async function aa(e){if(!e||typeof window>"u")return;let t=T?.lessons?.find(s=>s.id===e);if(window.confirm(t?.title?`Delete "${t.title}" from this week?`:"Delete this lesson?"))try{let s=await deleteLessonFromWeek(f,e);s&&(T=s,D(s),R(s,f))}catch(s){console.error("Failed to delete planner lesson",s),window.alert("Unable to delete that lesson right now.")}}function _t(){if(Ve||!x){Ve&&fe(f);return}Ve=!0,initPlannerStore({ensureFirestore:ke}),x.addEventListener("click",$i),x.addEventListener("click",Ji),x.addEventListener("change",ji),x.addEventListener("input",Qi),x.addEventListener("focusout",Yi),x.addEventListener("toggle",Ki),Le?.addEventListener("click",Hi),J instanceof HTMLTextAreaElement&&J.addEventListener("input",Ui),Xs?.addEventListener("click",es),Gs?.addEventListener("click",ea),Ys?.addEventListener("click",ta),Ks?.addEventListener("click",na),Oe?.addEventListener("change",_i),kt?.addEventListener("click",()=>Ue("list")),vt?.addEventListener("click",()=>Ue("week")),Ws?.addEventListener("click",()=>{let e=getWeekIdFromOffset(f,-1);fe(e)}),zs?.addEventListener("click",()=>{let e=getWeekIdFromOffset(f,1);fe(e)}),Qs?.addEventListener("click",()=>{fe(getPlannerWeekIdFromDate())}),Ue(Qn),fe(f)}var Ba=dn({dailyTab:Fs,dailyView:Rs,dailyListHeader:$s,quickAddForm:_s,quickAddInput:Vs,quickAddVoiceButton:qs,dailyTasksContainer:Us,clearCompletedButton:Os,dailyListPermissionNotice:js,cuesTab:Ps,cuesView:Hs,ensureCueFirestore:()=>ke()}),ts="theme",oa="professional",Dt="memoryCue:theme-change",ra="professional",Mt=document.getElementById("theme-menu"),ns="[data-theme-name],[data-theme-option]",la=new Set(["dark","dracula","synthwave"]);function te(e){return typeof e=="string"?e.trim():""}function ss(e){return e instanceof HTMLElement?te(e.getAttribute("data-theme-name")||e.getAttribute("data-theme-option")||""):""}function ca(e){let t=te(e);t&&(document.documentElement.setAttribute("data-theme",t),document.documentElement.classList.toggle("dark",la.has(t)))}function Dn(e){let t=te(e);if(t)try{localStorage.setItem(ts,t)}catch(n){console.warn("Unable to save theme preference",n)}}function is(e){if(!Mt)return;let t=te(e);Mt.querySelectorAll(ns).forEach(s=>{if(!(s instanceof HTMLElement))return;let i=ss(s),a=t&&i===t;s.setAttribute("aria-checked",a?"true":"false"),s.classList.toggle("active",a)})}function da(e){let t=te(e);if(!(typeof window>"u"||!t))try{window.dispatchEvent(new CustomEvent(Dt,{detail:{theme:t}}))}catch{if(typeof document<"u"&&typeof document.createEvent=="function"){let s=document.createEvent("CustomEvent");s.initCustomEvent(Dt,!0,!0,{theme:t}),window.dispatchEvent(s)}}}function Bt(e,{persist:t=!0,notify:n=!0}={}){let s=te(e);if(!s)return;te(document.documentElement.getAttribute("data-theme"))!==s&&ca(s),t&&Dn(s),is(s),n&&da(s)}function ua(){if(typeof document<"u"&&document.body instanceof HTMLElement&&document.body.classList.contains("desktop-shell")){Bt(ra,{persist:!0,notify:!0});return}let t="";try{t=localStorage.getItem(ts)||""}catch(s){console.warn("Unable to load theme preference",s)}let n=t||document.documentElement.getAttribute("data-theme")||oa;n&&Bt(n,{persist:!1,notify:!0})}Mt?.addEventListener("click",e=>{let t=e.target instanceof HTMLElement?e.target.closest(ns):null;if(!t)return;e.preventDefault();let n=ss(t);n&&Bt(n,{persist:!0,notify:!0})});typeof window<"u"&&window.addEventListener(Dt,e=>{let t=te(e?.detail?.theme);t&&is(t)});ua()});export default ma();
