<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memory Cue ‚Äî Voice Reminders (PWA) + Firebase Sync</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#38bdf8; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b1220 0%,#0a0f1c 100%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji");
    }
    .wrap{max-width:960px;margin:0 auto;padding:16px;}
    header{position:sticky;top:0;background:rgba(10,15,28,.7);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937;z-index:10}
    h1{font-size:22px;margin:0;padding:12px 0;font-weight:700;letter-spacing:.2px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{
      color:var(--text);background:#0f172a;border:1px solid #22304a;border-radius:12px;padding:10px 12px;font-size:14px
    }
    input::placeholder,textarea::placeholder{color:#64748b}
    button{cursor:pointer}
    button.primary{background:var(--accent);border-color:#1e7aa2;color:#001018;font-weight:700}
    button.good{background:var(--ok);border-color:#157a3a;color:#001108;font-weight:700}
    button.warn{background:var(--warn);border-color:#7a5a0f;color:#1b1200;font-weight:700}
    button.ghost{background:#0f172a;border-color:#22304a}
    .panel{background:var(--panel);border:1px solid #22304a;border-radius:16px;padding:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
    .list{display:grid;gap:8px}
    .item{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;padding:10px;border:1px solid #20314b;border-radius:14px;background:#0c1426}
    .item.done .title{text-decoration:line-through;color:#93a3b8}
    .title{font-weight:600}
    .meta{font-size:12px;color:var(--muted)}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #2b3b58;background:#0f1a32}
    .section-title{margin:8px 0 0;font-size:13px;color:#a8b2c2;text-transform:uppercase;letter-spacing:.12em}
    .footer{color:#8aa0b8;font-size:12px;text-align:center;margin:14px 0}
    .sr-only{position:absolute;height:1px;width:1px;clip:rect(1px,1px,1px,1px);overflow:hidden;white-space:nowrap}
    .hidden { display: none; }
    .sync-status{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600}
    .sync-status.online{background:var(--ok);color:#001108}
    .sync-status.offline{background:var(--warn);color:#1b1200}
    .sync-status.error{background:var(--danger);color:#fff}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h1>Memory Cue ‚Äî Voice Reminders (PWA) + Firebase Sync</h1>
        <div id="syncStatus" class="sync-status offline">Offline</div>
      </div>
      <div class="row" style="padding-bottom:12px">
        <input id="q" placeholder="Search reminders or #tags" style="flex:1" />
        <button id="voiceBtn" class="ghost" type="button" title="Voice quick add">üéôÔ∏è Voice add</button>
        <button id="notifBtn" class="ghost" type="button" title="Enable notifications">üîî Enable alerts</button>
        <button id="addQuickBtn" class="primary" type="button" title="Add quick reminder">+ Quick</button>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- Create / Quick add -->
    <section class="panel">
      <div class="row" style="gap:8px;align-items:flex-end">
        <div style="flex:1">
          <label class="sr-only" for="title">Reminder</label>
          <input id="title" placeholder="e.g., Pick up dog at 6pm #home" />
        </div>
        <div>
          <label class="sr-only" for="date">Date</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label class="sr-only" for="time">Time</label>
          <input id="time" type="time" />
        </div>
        <div>
          <select id="priority">
            <option>High</option>
            <option selected>Medium</option>
            <option>Low</option>
          </select>
        </div>
        <button id="saveBtn" class="good" type="button">Save</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="exportBtn" class="ghost" type="button">Export JSON</button>
        <span id="status" class="meta"></span>
      </div>
    </section>

    <!-- List + filters -->
    <section class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <button class="ghost" data-filter="today" type="button">Today</button>
          <button class="ghost" data-filter="overdue" type="button">Overdue</button>
          <button class="ghost" data-filter="all" type="button">All</button>
          <button class="ghost" data-filter="done" type="button">Completed</button>
        </div>
        <div>
          <select id="sort">
            <option value="smart">Smart sort</option>
            <option value="time">Time</option>
            <option value="priority">Priority</option>
          </select>
        </div>
      </div>
      <div class="section-title">Reminders</div>
      <div id="list" class="list" aria-live="polite">
        <div class="meta">Loading...</div>
      </div>
    </section>
  </main>

  <div class="wrap footer">
    Adelaide time. Voice works best in Chrome. Multi-device sync powered by Firebase.
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAmAMiz0zG3dAhZJhOy1DYj8fKVDObL36c",
      authDomain: "memory-cue-app.firebaseapp.com",
      projectId: "memory-cue-app",
      storageBucket: "memory-cue-app.firebasestorage.app",
      messagingSenderId: "751284466633",
      appId: "1:751284466633:web:3b10742970bef1a5d5ee18",
      measurementId: "G-R0V4M7VCE6"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // App state
    let items = [];
    let filter = 'today';
    let sortKey = 'smart';
    let listening = false;
    let recog = null;
    let userId = null;
    let unsubscribe = null;

    const TZ = 'Australia/Adelaide';
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // DOM elements
    const q = $('#q');
    const title = $('#title');
    const date = $('#date');
    const time = $('#time');
    const priority = $('#priority');
    const saveBtn = $('#saveBtn');
    const list = $('#list');
    const statusEl = $('#status');
    const voiceBtn = $('#voiceBtn');
    const notifBtn = $('#notifBtn');
    const addQuickBtn = $('#addQuickBtn');
    const exportBtn = $('#exportBtn');
    const sortSel = $('#sort');
    const syncStatus = $('#syncStatus');

    // Firebase Authentication
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        syncStatus.textContent = 'Online';
        syncStatus.className = 'sync-status online';
        setupFirestoreSync();
      } else {
        signInAnonymously(auth).catch(console.error);
      }
    });

    // Firestore real-time sync
    function setupFirestoreSync() {
      if (!userId) return;

      const userCollection = collection(db, 'users', userId, 'reminders');
      const q = query(userCollection, orderBy('updatedAt', 'desc'));

      unsubscribe = onSnapshot(q, (snapshot) => {
        const remoteItems = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          remoteItems.push({
            id: doc.id,
            title: data.title,
            priority: data.priority,
            notes: data.notes || '',
            done: data.done,
            due: data.due,
            createdAt: data.createdAt,
            updatedAt: data.updatedAt
          });
        });

        // Merge with any pending local changes
        items = mergeWithLocal(remoteItems);
        render();
      }, (error) => {
        console.error('Firestore sync error:', error);
        syncStatus.textContent = 'Sync Error';
        syncStatus.className = 'sync-status error';
      });
    }

    function mergeWithLocal(remoteItems) {
      const localPending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const merged = new Map();

      // Add all remote items
      remoteItems.forEach(item => merged.set(item.id, item));

      // Apply pending local changes
      localPending.forEach(change => {
        if (change.action === 'upsert') {
          merged.set(change.item.id, change.item);
        } else if (change.action === 'delete') {
          merged.delete(change.itemId);
        }
      });

      return Array.from(merged.values());
    }

    // Firebase operations
    async function saveToFirebase(item) {
      if (!userId) return;

      try {
        const docRef = doc(db, 'users', userId, 'reminders', item.id);
        await setDoc(docRef, {
          title: item.title,
          priority: item.priority,
          notes: item.notes,
          done: item.done,
          due: item.due,
          createdAt: item.createdAt,
          updatedAt: item.updatedAt
        });

        // Remove from pending changes
        removePendingChange(item.id);
      } catch (error) {
        console.error('Save failed:', error);
        addPendingChange({ action: 'upsert', item });
        syncStatus.textContent = 'Sync Pending';
        syncStatus.className = 'sync-status offline';
      }
    }

    async function deleteFromFirebase(id) {
      if (!userId) return;

      try {
        const docRef = doc(db, 'users', userId, 'reminders', id);
        await deleteDoc(docRef);
        removePendingChange(id);
      } catch (error) {
        console.error('Delete failed:', error);
        addPendingChange({ action: 'delete', itemId: id });
      }
    }

    function addPendingChange(change) {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      // Remove any existing change for this item
      const filtered = pending.filter(p => 
        (p.action === 'upsert' && p.item.id !== (change.item?.id || change.itemId)) ||
        (p.action === 'delete' && p.itemId !== (change.item?.id || change.itemId))
      );
      filtered.push(change);
      localStorage.setItem('pendingChanges', JSON.stringify(filtered));
    }

    function removePendingChange(itemId) {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const filtered = pending.filter(p => 
        (p.action === 'upsert' && p.item.id !== itemId) ||
        (p.action === 'delete' && p.itemId !== itemId)
      );
      localStorage.setItem('pendingChanges', JSON.stringify(filtered));
    }

    // Retry pending changes when online
    async function retryPendingChanges() {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      for (const change of pending) {
        try {
          if (change.action === 'upsert') {
            await saveToFirebase(change.item);
          } else if (change.action === 'delete') {
            await deleteFromFirebase(change.itemId);
          }
        } catch (error) {
          break; // Stop retrying if still failing
        }
      }
    }

    // Utility functions
    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function toISODatePart(d) { return d.toISOString().slice(0, 10); }
    function todayISO() {
      const d = new Date();
      return toISODatePart(new Date(d.getTime() - d.getTimezoneOffset() * 60000));
    }
    function priorityWeight(p) { return p === 'High' ? 3 : p === 'Medium' ? 2 : 1; }
    function smartCompare(a, b) {
      const pr = priorityWeight(b.priority) - priorityWeight(a.priority); if (pr) return pr;
      const at = +new Date(a.due || 0), bt = +new Date(b.due || 0); if (at !== bt) return at - bt;
      return (a.updatedAt || 0) > (b.updatedAt || 0) ? -1 : 1;
    }
    function fmtDayDate(iso) {
      if (!iso) return '‚Äî';
      try {
        const d = new Date(iso + 'T00:00:00');
        return new Intl.DateTimeFormat('en-AU', { timeZone: TZ, weekday: 'long', day: 'numeric', month: 'long' }).format(d);
      } catch { return iso; }
    }
    function parseQuickWhen(text) {
      text = text.toLowerCase();
      let when = { date: todayISO(), time: '' };
      if (/tomorrow/.test(text)) {
        const d = new Date(); d.setDate(d.getDate() + 1); when.date = toISODatePart(d);
      }
      const mHm = text.match(/\b(\d{1,2}):(\d{2})\b/);
      const m12 = text.match(/\b(\d{1,2})\s*(am|pm)\b/);
      if (mHm) { when.time = `${String(mHm[1]).padStart(2, '0')}:${mHm[2]}`; }
      else if (m12) {
        let h = parseInt(m12[1], 10) % 12; if (m12[2] === 'pm') h += 12; when.time = `${String(h).padStart(2, '0')}:00`;
      }
      return when;
    }

    // CRUD operations
    function addItem(obj) {
      const item = {
        id: uid(),
        title: obj.title.trim(),
        priority: obj.priority || 'Medium',
        notes: obj.notes || '',
        done: false,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        due: obj.due || null
      };

      // Add to local state immediately
      items = [item, ...items];
      render();

      // Save to Firebase
      saveToFirebase(item);
      return item;
    }

    function toggleDone(id) {
      const item = items.find(x => x.id === id);
      if (item) {
        item.done = !item.done;
        item.updatedAt = Date.now();
        render();
        saveToFirebase(item);
      }
    }

    function removeItem(id) {
      items = items.filter(x => x.id !== id);
      render();
      deleteFromFirebase(id);
    }

    // Render function
    function render() {
      const query = q.value.trim().toLowerCase();
      const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
      const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);

      let rows = items.slice();

      if (query) {
        rows = rows.filter(r =>
          r.title.toLowerCase().includes(query) || (r.notes || '').toLowerCase().includes(query)
        );
      }

      rows = rows.filter(r => {
        if (filter === 'done') return r.done;
        if (filter === 'overdue') return !r.done && r.due && new Date(r.due) < new Date();
        if (filter === 'today') {
          if (!r.due) return true;
          const d = new Date(r.due);
          return d >= todayStart && d <= todayEnd;
        }
        return true;
      });

      rows.sort((a, b) => {
        if (sortKey === 'time') return (+new Date(a.due || 0)) - (+new Date(b.due || 0));
        if (sortKey === 'priority') return priorityWeight(b.priority) - priorityWeight(a.priority);
        return smartCompare(a, b);
      });

      list.innerHTML = '';
      if (rows.length === 0) {
        list.innerHTML = '<div class="meta">Nothing here yet.</div>';
        return;
      }

      rows.forEach(r => {
        const div = document.createElement('div');
        div.className = 'item' + (r.done ? ' done' : '');
        const dueTxt = r.due
          ? new Date(r.due).toLocaleString('en-AU', { timeZone: TZ, hour: '2-digit', minute: '2-digit' }) +
          ' ‚Ä¢ ' + fmtDayDate(r.due.slice(0, 10))
          : '‚Äî';
        div.innerHTML = `
          <input type="checkbox" ${r.done ? 'checked' : ''} aria-label="Mark done" />
          <div>
            <div class="title">${escapeHtml(r.title)}</div>
            <div class="meta">${dueTxt} ‚Ä¢ <span class="badge">${r.priority}</span> ${r.notes ? '‚Ä¢ ' + escapeHtml(r.notes) : ''}</div>
          </div>
          <div class="row">
            <button class="ghost" data-del type="button">Delete</button>
          </div>`;
        div.querySelector('input').addEventListener('change', () => toggleDone(r.id));
        div.querySelector('[data-del]').addEventListener('click', () => removeItem(r.id));
        list.appendChild(div);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) =>
        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
      );
    }

    function toast(msg) {
      statusEl.textContent = msg; clearTimeout(toast._t);
      toast._t = setTimeout(() => statusEl.textContent = '', 3000);
    }

    // Event listeners
    saveBtn.addEventListener('click', () => {
      const t = title.value.trim(); if (!t) { toast('Add a reminder title'); return; }
      let due = null;
      if (date.value || time.value) {
        const d = (date.value || todayISO());
        const tm = (time.value || '09:00');
        due = new Date(`${d}T${tm}:00`).toISOString();
      } else {
        const p = parseQuickWhen(t);
        if (p.time) { due = new Date(`${p.date}T${p.time}:00`).toISOString(); }
      }
      addItem({ title: t, priority: priority.value, due });
      title.value = ''; time.value = '';
    });

    addQuickBtn.addEventListener('click', () => {
      if (!title.value.trim()) {
        title.focus(); toast('Type something like "pick up dog at 6pm"'); return;
      }
      saveBtn.click();
    });

    q.addEventListener('input', render);
    sortSel.addEventListener('change', () => { sortKey = sortSel.value; render(); });
    $$('button[data-filter]').forEach(b => b.addEventListener('click', () => {
      filter = b.getAttribute('data-filter'); render();
    }));

    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'memory-cue.json'; a.click();
      URL.revokeObjectURL(url);
    });

    // Voice recognition (simplified)
    try {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SR) {
        recog = new SR();
        recog.lang = 'en-AU';
        recog.interimResults = false;
        recog.onresult = (e) => {
          const t = e.results[0][0].transcript || '';
          title.value = t;
          toast('Heard: ' + t);
        };
        recog.onend = () => { listening = false; voiceBtn.textContent = 'üéôÔ∏è Voice add'; };
      }
    } catch { }

    voiceBtn.addEventListener('click', () => {
      if (!recog) return;
      if (!listening) { try { recog.start(); listening = true; voiceBtn.textContent = 'Listening‚Ä¶'; } catch { } }
      else { try { recog.stop(); } catch { } listening = false; voiceBtn.textContent = 'üéôÔ∏è Voice add'; }
    });

    // Notifications
    notifBtn.addEventListener('click', async () => {
      if (!('Notification' in window)) { toast('Notifications not supported'); return; }
      if (Notification.permission === 'granted') { toast('Notifications enabled'); return; }
      const perm = await Notification.requestPermission();
      toast(perm === 'granted' ? 'Notifications enabled' : 'Notifications blocked');
    });

    // Handle online/offline
    window.addEventListener('online', () => {
      syncStatus.textContent = 'Online';
      syncStatus.className = 'sync-status online';
      retryPendingChanges();
    });

    window.addEventListener('offline', () => {
      syncStatus.textContent = 'Offline';
      syncStatus.className = 'sync-status offline';
    });

    // Initialize
    render();
  </script>
</body>
</html>
