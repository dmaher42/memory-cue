<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memory Cue</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
  <style>
    :root{
      /* Colors */
      --bg-primary: #0b1220;
      --bg-secondary: #0f172a;
      --bg-tertiary: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --accent-hover: #0ea5e9;
      --success: #22c55e;
      --success-hover: #16a34a;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #334155;
      --border-light: #475569;

      /* Spacing (8px grid) */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;

      /* Typography */
      --text-xs: 12px;
      --text-sm: 14px;
      --text-base: 16px;
      --text-lg: 18px;
      --text-xl: 20px;
      --text-2xl: 24px;
      --text-3xl: 30px;

      /* Radius */
      --radius-sm: 6px;
      --radius: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(180deg, var(--bg-primary) 0%, #0a0f1c 100%);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: var(--text-base);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--space-4);
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      background: rgba(11, 18, 32, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      padding: var(--space-4) 0;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    h1 {
      font-size: var(--text-3xl);
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.025em;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-controls {
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
      align-items: center;
    }

    /* Form Elements */
    input, select, button, textarea {
      font-family: inherit;
      font-size: var(--text-sm);
      line-height: 1.5;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: all 0.2s ease;
    }

    input, select, textarea {
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: var(--space-3) var(--space-4);
      box-shadow: var(--shadow-sm);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
    }

    input::placeholder, textarea::placeholder {
      color: var(--text-muted);
    }

    .search-input {
      flex: 1;
      min-width: 200px;
    }

    /* Buttons */
    button {
      cursor: pointer;
      font-weight: 500;
      padding: var(--space-3) var(--space-4);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      white-space: nowrap;
      border: 1px solid transparent;
      transition: all 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
      font-weight: 600;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    .btn-success {
      background: var(--success);
      color: var(--bg-primary);
      border-color: var(--success);
      font-weight: 600;
    }

    .btn-success:hover {
      background: var(--success-hover);
      border-color: var(--success-hover);
    }

    .btn-ghost {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border-color: var(--border);
    }

    .btn-ghost:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--border-light);
    }

    /* Layout */
    .main-content {
      padding: var(--space-8) 0;
    }

    .grid {
      display: grid;
      gap: var(--space-8);
      grid-template-columns: 1fr;
    }

    @media (min-width: 1024px) {
      .grid {
        grid-template-columns: 1.2fr 0.8fr;
      }
    }

    /* Cards/Panels */
    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      padding: var(--space-6);
      border-bottom: 1px solid var(--border);
      background: var(--bg-tertiary);
    }

    .card-content {
      padding: var(--space-6);
    }

    .card-title {
      font-size: var(--text-lg);
      font-weight: 600;
      margin: 0 0 var(--space-2) 0;
      color: var(--text-primary);
    }

    .section-subtitle {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: var(--space-6) 0 var(--space-4) 0;
    }

    /* Form Layout */
    .form-row {
      display: flex;
      gap: var(--space-3);
      align-items: flex-end;
      flex-wrap: wrap;
      margin-bottom: var(--space-4);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .form-group.flex-1 {
      flex: 1;
      min-width: 200px;
    }

    .form-actions {
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
      align-items: center;
      padding-top: var(--space-4);
      border-top: 1px solid var(--border);
    }

    /* Filter Controls */
    .filter-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
    }

    .filter-buttons {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
    }

    .filter-buttons button {
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-sm);
    }

    .filter-buttons button.active {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }

    /* Task List */
    .task-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .task-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: var(--space-4);
      align-items: center;
      padding: var(--space-4);
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
    }

    .task-item:hover {
      border-color: var(--border-light);
      box-shadow: var(--shadow-md);
    }

    .task-item.completed .task-title {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .task-content {
      min-width: 0; /* Allow text to wrap */
    }

    .task-title {
      font-size: var(--text-base);
      font-weight: 500;
      margin: 0 0 var(--space-1) 0;
      color: var(--text-primary);
      line-height: 1.4;
    }

    .task-meta {
      display: flex;
      gap: var(--space-3);
      align-items: center;
      flex-wrap: wrap;
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    .priority-badge {
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: 500;
      border: 1px solid transparent;
    }

    .priority-high {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
      border-color: rgba(239, 68, 68, 0.2);
    }

    .priority-medium {
      background: rgba(245, 158, 11, 0.1);
      color: #fcd34d;
      border-color: rgba(245, 158, 11, 0.2);
    }

    .priority-low {
      background: rgba(34, 197, 94, 0.1);
      color: #86efac;
      border-color: rgba(34, 197, 94, 0.2);
    }

    .task-actions {
      display: flex;
      gap: var(--space-2);
    }

    .task-actions button {
      padding: var(--space-2);
      font-size: var(--text-xs);
      min-width: auto;
    }

    /* Checkbox */
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Status Elements */
    .sync-status {
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius);
      font-size: var(--text-xs);
      font-weight: 600;
      border: 1px solid transparent;
    }

    .sync-status.online {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
      border-color: rgba(34, 197, 94, 0.2);
    }

    .sync-status.offline {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
      border-color: rgba(245, 158, 11, 0.2);
    }

    .sync-status.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border-color: rgba(239, 68, 68, 0.2);
    }

    .google-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
    }

    .status-message {
      font-size: var(--text-sm);
      color: var(--text-muted);
      margin-top: var(--space-2);
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: var(--space-8) 0;
      color: var(--text-muted);
      font-size: var(--text-sm);
      border-top: 1px solid var(--border);
      margin-top: var(--space-12);
    }

    /* Utility Classes */
    .hidden { 
      display: none; 
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .text-muted {
      color: var(--text-muted);
    }

    /* Responsive Design */
    @media (max-width: 640px) {
      .container {
        padding: 0 var(--space-3);
      }
      
      .header-controls {
        width: 100%;
      }
      
      .form-row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .task-item {
        padding: var(--space-3);
      }
      
      h1 {
        font-size: var(--text-2xl);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="header-top">
          <h1>Memory Cue</h1>
          <div id="syncStatus" class="sync-status offline">Offline</div>
        </div>
        <div class="header-controls">
          <input id="q" class="search-input" placeholder="Search reminders or #tags" />
          <button id="voiceBtn" class="btn-ghost" type="button" title="Voice quick add">
            üéôÔ∏è Voice
          </button>
          <button id="notifBtn" class="btn-ghost" type="button" title="Enable notifications">
            üîî Alerts
          </button>
          <button id="addQuickBtn" class="btn-primary" type="button" title="Add quick reminder">
            + Quick Add
          </button>
          <button id="googleSignInBtn" class="btn-ghost" type="button">
            Sign in with Google
          </button>
          <button id="googleSignOutBtn" class="btn-ghost hidden" type="button">
            <img id="googleAvatar" class="google-avatar hidden" />
            Sign out
          </button>
          <span id="googleUserName" class="text-muted"></span>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="container">
      <div class="grid">
        <!-- Create Reminder Card -->
        <section class="card">
          <div class="card-header">
            <h2 class="card-title">Create Reminder</h2>
          </div>
          <div class="card-content">
            <div class="form-row">
              <div class="form-group flex-1">
                <label class="sr-only" for="title">Reminder</label>
                <input id="title" placeholder="e.g., Pick up dog at 6pm #home" />
                <div id="dateFeedback" style="margin-top: 4px; font-size: 12px; color: var(--text-muted); display: none;"></div>
              </div>
              <div class="form-group">
                <label class="sr-only" for="date">Date</label>
                <input id="date" type="date" />
              </div>
              <div class="form-group">
                <label class="sr-only" for="time">Time</label>
                <input id="time" type="time" />
              </div>
              <div class="form-group">
                <select id="priority">
                  <option>High</option>
                  <option selected>Medium</option>
                  <option>Low</option>
                </select>
              </div>
              <button id="saveBtn" class="btn-success" type="button">Save</button>
            </div>
            
            <div class="form-actions">
              <button id="copyMtlBtn" class="btn-ghost" type="button">Copy MTL updates</button>
              <label class="btn-ghost" style="cursor: pointer;">
                Import JSON
                <input id="importFile" type="file" accept="application/json" class="sr-only" />
              </label>
              <button id="exportBtn" class="btn-ghost" type="button">Export JSON</button>
              <button id="openSettings" class="btn-ghost" type="button">‚öôÔ∏è Settings</button>
              <div id="status" class="status-message"></div>
            </div>
          </div>
        </section>

        <!-- Reminders List Card -->
        <section class="card">
          <div class="card-header">
            <div class="filter-controls">
              <div class="filter-buttons">
                <button class="btn-ghost active" data-filter="today" type="button">Today</button>
                <button class="btn-ghost" data-filter="overdue" type="button">Overdue</button>
                <button class="btn-ghost" data-filter="all" type="button">All</button>
                <button class="btn-ghost" data-filter="done" type="button">Completed</button>
              </div>
              <select id="sort">
                <option value="smart">Smart sort</option>
                <option value="time">Time</option>
                <option value="priority">Priority</option>
              </select>
            </div>
          </div>
          <div class="card-content">
            <h3 class="section-subtitle">Reminders</h3>
            <div id="list" class="task-list" aria-live="polite">
              <div class="text-muted">Loading...</div>
            </div>
          </div>
        </section>
      </div>

      <!-- Settings Card (hidden by default) -->
      <section class="card hidden" id="settingsSection" style="margin-top: var(--space-8);">
        <div class="card-header">
          <h2 class="card-title">Calendar Sync Settings</h2>
        </div>
        <div class="card-content">
          <div class="form-row">
            <div class="form-group flex-1">
              <input id="syncUrl" placeholder="https://script.google.com/macros/s/AKfycb.../exec" />
            </div>
            <button id="saveSettings" class="btn-success" type="button">Save settings</button>
            <button id="testSync" class="btn-ghost" type="button">Send test</button>
          </div>
          <div class="text-muted" style="margin-top: var(--space-4);">
            <strong>Tip:</strong> In Google Apps Script, click <strong>Deploy ‚Üí New deployment ‚Üí Web app</strong>,
            set <strong>Execute as: Me</strong>, <strong>Who has access: Anyone with the link</strong>, then copy the URL (ends with <code>/exec</code>).
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      Adelaide time. Voice works best in Chrome. Multi-device sync via Firebase + Calendar sync via Google Apps Script.
    </div>
  </footer>

  <!-- Firebase SDK and JavaScript (same as before) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
    import { GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAmAMiz0zG3dAhZJhOy1DYj8fKVDObL36c",
      authDomain: "memory-cue-app.firebaseapp.com",
      projectId: "memory-cue-app",
      storageBucket: "memory-cue-app.firebasestorage.app",
      messagingSenderId: "751284466633",
      appId: "1:751284466633:web:3b10742970bef1a5d5ee18",
      measurementId: "G-R0V4M7VCE6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // App state
    let items = [];
    let filter = 'today';
    let sortKey = 'smart';
    let listening = false;
    let recog = null;
    let userId = null;
    let unsubscribe = null;
    let currentUser = null;

    const TZ = 'Australia/Adelaide';
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // DOM elements
    const q = $('#q');
    const title = $('#title');
    const dateFeedback = $('#dateFeedback');
    const date = $('#date');
    const time = $('#time');
    const priority = $('#priority');
    const saveBtn = $('#saveBtn');
    const list = $('#list');
    const statusEl = $('#status');
    const voiceBtn = $('#voiceBtn');
    const notifBtn = $('#notifBtn');
    const addQuickBtn = $('#addQuickBtn');
    const copyMtlBtn = $('#copyMtlBtn');
    const importFile = $('#importFile');
    const exportBtn = $('#exportBtn');
    const sortSel = $('#sort');
    const syncStatus = $('#syncStatus');
    const openSettings = $('#openSettings');
    const syncUrlInput = $('#syncUrl');
    const saveSettings = $('#saveSettings');
    const testSync = $('#testSync');
    const settingsSection = $('#settingsSection');
    const googleSignInBtn = $('#googleSignInBtn');
    const googleSignOutBtn = $('#googleSignOutBtn');
    const googleAvatar = $('#googleAvatar');
    const googleUserName = $('#googleUserName');

    // Restore saved Sync URL
    const savedSyncUrl = localStorage.getItem('syncUrl') || '';
    if (savedSyncUrl) syncUrlInput.value = savedSyncUrl;

    // Google Sign-In logic
    googleSignInBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        toast('Google sign-in failed');
        console.error(error);
      }
    });

    googleSignOutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        toast('Signed out');
        items = [];
        render();
      } catch (error) {
        toast('Sign-out failed');
        console.error(error);
      }
    });

    // Firebase Authentication state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        currentUser = user;
        syncStatus.textContent = 'Online';
        syncStatus.className = 'sync-status online';
        googleSignInBtn.classList.add('hidden');
        googleSignOutBtn.classList.remove('hidden');
        if (user.photoURL) {
          googleAvatar.classList.remove('hidden');
          googleAvatar.src = user.photoURL;
        } else {
          googleAvatar.classList.add('hidden');
          googleAvatar.src = '';
        }
        if (user.displayName) {
          googleUserName.textContent = `Hello, ${user.displayName}`;
        } else if (user.email) {
          googleUserName.textContent = user.email;
        } else {
          googleUserName.textContent = '';
        }
        setupFirestoreSync();
      } else {
        googleSignInBtn.classList.remove('hidden');
        googleSignOutBtn.classList.add('hidden');
        googleAvatar.classList.add('hidden');
        googleAvatar.src = '';
        googleUserName.textContent = '';
        items = [];
        render();
      }
    });

    // Firestore real-time sync
    function setupFirestoreSync() {
      if (!userId) {
        items = [];
        render();
        return;
      }
      if (unsubscribe) unsubscribe();
      const userCollection = collection(db, 'users', userId, 'reminders');
      const qSnap = query(userCollection, orderBy('updatedAt', 'desc'));

      unsubscribe = onSnapshot(qSnap, (snapshot) => {
        const remoteItems = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          remoteItems.push({
            id: doc.id,
            title: data.title,
            priority: data.priority,
            notes: data.notes || '',
            done: data.done,
            due: data.due,
            createdAt: data.createdAt,
            updatedAt: data.updatedAt
          });
        });

        items = mergeWithLocal(remoteItems);
        render();
      }, (error) => {
        console.error('Firestore sync error:', error);
        syncStatus.textContent = 'Sync Error';
        syncStatus.className = 'sync-status error';
      });
    }

    function mergeWithLocal(remoteItems) {
      const localPending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const merged = new Map();

      remoteItems.forEach(item => merged.set(item.id, item));

      localPending.forEach(change => {
        if (change.action === 'upsert') {
          merged.set(change.item.id, change.item);
        } else if (change.action === 'delete') {
          merged.delete(change.itemId);
        }
      });

      return Array.from(merged.values());
    }

    async function saveToFirebase(item) {
      if (!userId) return;
      try {
        await setDoc(doc(db, 'users', userId, 'reminders', item.id), {
          title: item.title,
          priority: item.priority,
          notes: item.notes,
          done: item.done,
          due: item.due,
          createdAt: item.createdAt,
          updatedAt: item.updatedAt
        });
        removePendingChange(item.id);
      } catch (error) {
        console.error('Save failed:', error);
        addPendingChange({ action: 'upsert', item });
        syncStatus.textContent = 'Sync Pending';
        syncStatus.className = 'sync-status offline';
      }
    }

    async function deleteFromFirebase(id) {
      if (!userId) return;
      try {
        await deleteDoc(doc(db, 'users', userId, 'reminders', id));
        removePendingChange(id);
      } catch (error) {
        console.error('Delete failed:', error);
        addPendingChange({ action: 'delete', itemId: id });
      }
    }

    function addPendingChange(change) {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const filtered = pending.filter(p => 
        (p.action === 'upsert' && p.item.id !== (change.item?.id || change.itemId)) ||
        (p.action === 'delete' && p.itemId !== (change.item?.id || change.itemId))
      );
      filtered.push(change);
      localStorage.setItem('pendingChanges', JSON.stringify(filtered));
    }

    function removePendingChange(itemId) {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const filtered = pending.filter(p => 
        (p.action === 'upsert' && p.item.id !== itemId) ||
        (p.action === 'delete' && p.itemId !== itemId)
      );
      localStorage.setItem('pendingChanges', JSON.stringify(filtered));
    }

    async function retryPendingChanges() {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      for (const change of pending) {
        try {
          if (change.action === 'upsert') {
            await saveToFirebase(change.item);
          } else if (change.action === 'delete') {
            await deleteFromFirebase(change.itemId);
          }
        } catch (error) {
          break;
        }
      }
    }

    async function tryCalendarSync(task) {
      const url = (localStorage.getItem('syncUrl') || '').trim();
      if (!url) return;
      
      const payload = { 
        title: task.title, 
        dueIso: task.due || null, 
        priority: task.priority || 'Medium' 
      };
      
      try {
        await fetch(url, { 
          method: 'POST', 
          headers: { 'Content-Type': 'text/plain' }, 
          body: JSON.stringify(payload) 
        });
        toast('Synced to Calendar');
      } catch (e) { 
        toast('Calendar sync failed (offline?)'); 
      }
    }

    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    
    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function toISODatePart(d) { return d.toISOString().slice(0, 10); }
    function todayISO() {
      const now = new Date();
      const adelaideDate = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
      return toISODatePart(adelaideDate);
    }
    function priorityWeight(p) { return p === 'High' ? 3 : p === 'Medium' ? 2 : 1; }
    function smartCompare(a, b) {
      const pr = priorityWeight(b.priority) - priorityWeight(a.priority); if (pr) return pr;
      const at = +new Date(a.due || 0), bt = +new Date(b.due || 0); if (at !== bt) return at - bt;
      return (a.updatedAt || 0) > (b.updatedAt || 0) ? -1 : 1;
    }
    function fmtDayDate(iso) {
      if (!iso) return '‚Äî';
      try {
        const d = new Date(iso + 'T00:00:00');
        return new Intl.DateTimeFormat('en-AU', { timeZone: TZ, weekday: 'long', day: 'numeric', month: 'long' }).format(d);
      } catch { return iso; }
    }
    function parseQuickWhen(text) {
      text = text.toLowerCase();
      let when = { date: todayISO(), time: '' };

      // Helper function to get next occurrence of a day
      const getNextDayOfWeek = (dayIndex) => {
        const today = new Date();
        const currentDay = today.getDay();
        const daysUntilTarget = (dayIndex - currentDay + 7) % 7;
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + (daysUntilTarget === 0 ? 7 : daysUntilTarget));
        return targetDate;
      };

      // Helper function to get this occurrence of a day
      const getThisDayOfWeek = (dayIndex) => {
        const today = new Date();
        const currentDay = today.getDay();
        const daysUntilTarget = (dayIndex - currentDay + 7) % 7;
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + daysUntilTarget);
        return targetDate;
      };

      // Day names mapping
      const dayNames = {
        'sunday': 0, 'sun': 0,
        'monday': 1, 'mon': 1,
        'tuesday': 2, 'tue': 2, 'tues': 2,
        'wednesday': 3, 'wed': 3,
        'thursday': 4, 'thu': 4, 'thur': 4, 'thurs': 4,
        'friday': 5, 'fri': 5,
        'saturday': 6, 'sat': 6
      };

      // Month names mapping
      const monthNames = {
        'january': 0, 'jan': 0,
        'february': 1, 'feb': 1,
        'march': 2, 'mar': 2,
        'april': 3, 'apr': 3,
        'may': 4,
        'june': 5, 'jun': 5,
        'july': 6, 'jul': 6,
        'august': 7, 'aug': 7,
        'september': 8, 'sep': 8, 'sept': 8,
        'october': 9, 'oct': 9,
        'november': 10, 'nov': 10,
        'december': 11, 'dec': 11
      };

      // Detect "tomorrow"
      if (/\btomorrow\b/.test(text)) {
        const d = new Date(); d.setDate(d.getDate() + 1); when.date = toISODatePart(d);
      }
      // Detect "today"
      else if (/\btoday\b/.test(text)) {
        when.date = todayISO();
      }
      // Detect "next [day]"
      else if (/\bnext\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\bnext\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getNextDayOfWeek(dayIndex);
        when.date = toISODatePart(targetDate);
      }
      // Detect "this [day]"
      else if (/\bthis\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\bthis\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getThisDayOfWeek(dayIndex);
        when.date = toISODatePart(targetDate);
      }
      // Detect standalone day names (assume next occurrence)
      else if (/\b(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\b(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getNextDayOfWeek(dayIndex);
        when.date = toISODatePart(targetDate);
      }
      // Detect "in X days"
      else if (/\bin\s+(\d+)\s+days?\b/.test(text)) {
        const match = text.match(/\bin\s+(\d+)\s+days?\b/);
        const days = parseInt(match[1], 10);
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + days);
        when.date = toISODatePart(targetDate);
      }
      // Detect "this weekend" (assume Saturday)
      else if (/\bthis\s+weekend\b/.test(text)) {
        const targetDate = getThisDayOfWeek(6); // Saturday
        when.date = toISODatePart(targetDate);
      }
      // Detect "next weekend"
      else if (/\bnext\s+weekend\b/.test(text)) {
        const targetDate = getNextDayOfWeek(6); // Saturday
        when.date = toISODatePart(targetDate);
      }
      // Detect "next week"
      else if (/\bnext\s+week\b/.test(text)) {
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + 7);
        when.date = toISODatePart(targetDate);
      }
      // Detect specific dates like "september 15" or "sep 15"
      else if (/\b(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)\s+(\d{1,2})(st|nd|rd|th)?\b/.test(text)) {
        const match = text.match(/\b(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)\s+(\d{1,2})(st|nd|rd|th)?\b/);
        const monthIndex = monthNames[match[1]];
        const day = parseInt(match[2], 10);
        const targetDate = new Date();
        targetDate.setMonth(monthIndex, day);
        // If the date has passed this year, assume next year
        if (targetDate < new Date()) {
          targetDate.setFullYear(targetDate.getFullYear() + 1);
        }
        when.date = toISODatePart(targetDate);
      }
      // Detect date formats like "15/09" or "09/15" or "15/09/2025"
      else if (/\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/.test(text)) {
        const match = text.match(/\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/);
        const first = parseInt(match[1], 10);
        const second = parseInt(match[2], 10);
        let year = match[3] ? parseInt(match[3], 10) : new Date().getFullYear();
        
        // Handle 2-digit years
        if (year < 100) {
          year += year < 50 ? 2000 : 1900;
        }
        
        // Assume DD/MM format (common in AU)
        if (first <= 12 && second <= 12) {
          // If both could be month or day, prefer DD/MM format
          const targetDate = new Date(year, second - 1, first);
          when.date = toISODatePart(targetDate);
        } else if (first <= 31 && second <= 12) {
          // DD/MM format
          const targetDate = new Date(year, second - 1, first);
          when.date = toISODatePart(targetDate);
        } else if (first <= 12 && second <= 31) {
          // MM/DD format
          const targetDate = new Date(year, first - 1, second);
          when.date = toISODatePart(targetDate);
        }
      }

      const mHm = text.match(/\b(\d{1,2}):(\d{2})\b/);
      const m12 = text.match(/\b(\d{1,2})\s*(am|pm)\b/);
      if (mHm) { when.time = `${String(mHm[1]).padStart(2, '0')}:${mHm[2]}`; }
      else if (m12) {
        let h = parseInt(m12[1], 10) % 12; if (m12[2] === 'pm') h += 12; when.time = `${String(h).padStart(2, '0')}:00`;
      }
      return when;
    }

    function addItem(obj) {
      if (!userId) { toast('Sign in to add reminders'); return; }
      const item = {
        id: uid(),
        title: obj.title.trim(),
        priority: obj.priority || 'Medium',
        notes: obj.notes || '',
        done: false,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        due: obj.due || null
      };

      items = [item, ...items];
      render();

      saveToFirebase(item);
      tryCalendarSync(item);
      
      return item;
    }

    function toggleDone(id) {
      const item = items.find(x => x.id === id);
      if (item) {
        item.done = !item.done;
        item.updatedAt = Date.now();
        render();
        saveToFirebase(item);
      }
    }

    function removeItem(id) {
      items = items.filter(x => x.id !== id);
      render();
      deleteFromFirebase(id);
    }

    function render() {
      const query = q.value.trim().toLowerCase();

      const now = new Date();
      const adelaideNow = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
      const todayStart = new Date(adelaideNow);
      todayStart.setHours(0, 0, 0, 0);
      const todayEnd = new Date(adelaideNow);
      todayEnd.setHours(23, 59, 59, 999);

      let rows = items.slice();

      if (query) {
        rows = rows.filter(r =>
          r.title.toLowerCase().includes(query) || (r.notes || '').toLowerCase().includes(query)
        );
      }

      rows = rows.filter(r => {
        if (filter === 'done') return r.done;
        if (filter === 'overdue') return !r.done && r.due && new Date(r.due) < adelaideNow;
        if (filter === 'today') {
          if (!r.due) return true;
          const dueDate = new Date(r.due);
          const dueDateAdelaide = new Date(dueDate.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
          return dueDateAdelaide >= todayStart && dueDateAdelaide <= todayEnd;
        }
        return true;
      });

      rows.sort((a, b) => {
        if (sortKey === 'time') return (+new Date(a.due || 0)) - (+new Date(b.due || 0));
        if (sortKey === 'priority') return priorityWeight(b.priority) - priorityWeight(a.priority);
        return smartCompare(a, b);
      });

      // Update filter button states
      $$('[data-filter]').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
      });

      list.innerHTML = '';
      if (rows.length === 0) {
        list.innerHTML = '<div class="text-muted">No reminders found.</div>';
        return;
      }

      rows.forEach(r => {
        const div = document.createElement('div');
        div.className = 'task-item' + (r.done ? ' completed' : '');
        
        const dueTxt = r.due
          ? new Date(r.due).toLocaleString('en-AU', { timeZone: TZ, hour: '2-digit', minute: '2-digit' }) +
            ' ‚Ä¢ ' + fmtDayDate(r.due.slice(0, 10))
          : 'No due date';

        const priorityClass = `priority-${r.priority.toLowerCase()}`;
        
        div.innerHTML = `
          <input type="checkbox" ${r.done ? 'checked' : ''} aria-label="Mark complete" />
          <div class="task-content">
            <div class="task-title">${escapeHtml(r.title)}</div>
            <div class="task-meta">
              <span>${dueTxt}</span>
              <span class="priority-badge ${priorityClass}">${r.priority}</span>
              ${r.notes ? `<span>${escapeHtml(r.notes)}</span>` : ''}
            </div>
          </div>
          <div class="task-actions">
            <button class="btn-ghost" data-del type="button">Delete</button>
          </div>`;
        
        div.querySelector('input').addEventListener('change', () => toggleDone(r.id));
        div.querySelector('[data-del]').addEventListener('click', () => removeItem(r.id));
        list.appendChild(div);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) =>
        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
      );
    }

    function toast(msg) {
      console.log('Toast:', msg);
      statusEl.textContent = msg; 
      clearTimeout(toast._t);
      toast._t = setTimeout(() => statusEl.textContent = '', 3000);
    }

    // Event Listeners
    saveBtn.addEventListener('click', () => {
      const t = title.value.trim(); 
      if (!t) { 
        toast('Add a reminder title'); 
        return; 
      }
      let due = null;
      if (date.value || time.value) {
        const d = (date.value || todayISO());
        const tm = (time.value || '09:00');
        due = new Date(`${d}T${tm}:00`).toISOString();
      } else {
        const p = parseQuickWhen(t);
        if (p.time) { 
          due = new Date(`${p.date}T${p.time}:00`).toISOString(); 
        }
      }
      addItem({ title: t, priority: priority.value, due });
      title.value = ''; 
      time.value = '';
    });

    // Add real-time date feedback
    function updateDateFeedback() {
      const text = title.value.trim();
      if (!text) {
        dateFeedback.style.display = 'none';
        return;
      }
      
      try {
        const parsed = parseQuickWhen(text);
        const today = todayISO();
        
        if (parsed.date !== today || parsed.time) {
          let feedback = '';
          
          if (parsed.date !== today) {
            const dateObj = new Date(parsed.date + 'T00:00:00');
            feedback += `üìÖ ${fmtDayDate(parsed.date)}`;
          }
          
          if (parsed.time) {
            feedback += `${feedback ? ' ' : ''}üïê ${parsed.time}`;
          }
          
          if (feedback) {
            dateFeedback.textContent = `Parsed: ${feedback}`;
            dateFeedback.style.display = 'block';
          } else {
            dateFeedback.style.display = 'none';
          }
        } else {
          dateFeedback.style.display = 'none';
        }
      } catch (e) {
        dateFeedback.style.display = 'none';
      }
    }
    
    title.addEventListener('input', debounce(updateDateFeedback, 300));

    addQuickBtn.addEventListener('click', () => {
      if (!title.value.trim()) {
        title.focus(); 
        toast('Type something like "pick up dog at 6pm"'); 
        return;
      }
      saveBtn.click();
    });

    q.addEventListener('input', render);
    sortSel.addEventListener('change', () => { 
      sortKey = sortSel.value; 
      render(); 
    });
    
    $$('button[data-filter]').forEach(b => b.addEventListener('click', () => {
      filter = b.getAttribute('data-filter'); 
      render();
    }));

    copyMtlBtn.addEventListener('click', () => {
      const lines = items.filter(x => !x.done).map(x => {
        const datePart = x.due ? fmtDayDate(x.due.slice(0, 10)) : '';
        const timePart = x.due ? new Date(x.due).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' }) : '';
        const pieces = [
          'mtl ' + x.title,
          x.due ? `Due Date: ${datePart}` : '',
          x.due ? `Time: ${timePart}` : '',
          `Status: Not started`,
        ].filter(Boolean);
        return pieces.join('\n');
      });
      if (lines.length === 0) { 
        toast('No active tasks to copy'); 
        return; 
      }
      navigator.clipboard.writeText(lines.join('\n\n')).then(() => {
        toast('Copied for Master Task List');
      }).catch(() => toast('Copy failed'));
    });

    importFile.addEventListener('change', () => {
      const f = importFile.files[0]; 
      if (!f) return;
      const rd = new FileReader();
      rd.onload = () => {
        try { 
          const importedItems = JSON.parse(String(rd.result) || '[]'); 
          importedItems.forEach(item => {
            item.id = uid();
            items = [item, ...items];
            saveToFirebase(item);
          });
          render();
          toast('Import successful');
        }
        catch (err) { 
          toast('Invalid JSON'); 
        }
      };
      rd.readAsText(f);
      importFile.value = '';
    });

    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'memory-cue.json'; 
      a.click();
      URL.revokeObjectURL(url);
    });

    openSettings.addEventListener('click', () => {
      if (settingsSection) {
        settingsSection.classList.remove('hidden');
        settingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });

    saveSettings.addEventListener('click', () => {
      const url = syncUrlInput.value.trim();
      localStorage.setItem('syncUrl', url);
      toast('Calendar sync settings saved');
    });

    testSync.addEventListener('click', async () => {
      const url = syncUrlInput.value.trim();
      if (!url) { 
        toast('Enter Google Apps Script URL first'); 
        return; 
      }
      try {
        const r = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ title: 'Test from Memory Cue', dueIso: null, priority: 'Low' })
        });
        toast(r.ok ? 'Calendar test sent successfully' : 'Calendar sync error');
      } catch (e) { 
        toast('Calendar sync failed (check URL & deploy)'); 
      }
    });

    // Voice recognition
    try {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SR) {
        recog = new SR();
        recog.lang = 'en-AU';
        recog.interimResults = false;
        recog.onresult = (e) => {
          const t = e.results[0][0].transcript || '';
          title.value = t;
          toast('Heard: ' + t);
        };
        recog.onend = () => { 
          listening = false; 
          voiceBtn.textContent = 'üéôÔ∏è Voice'; 
        };
      }
    } catch { }

    voiceBtn.addEventListener('click', () => {
      if (!recog) return;
      if (!listening) { 
        try { 
          recog.start(); 
          listening = true; 
          voiceBtn.textContent = 'üëÇ Listening...'; 
        } catch { } 
      } else { 
        try { 
          recog.stop(); 
        } catch { } 
        listening = false; 
        voiceBtn.textContent = 'üéôÔ∏è Voice'; 
      }
    });

    notifBtn.addEventListener('click', async () => {
      if (!('Notification' in window)) { 
        toast('Notifications not supported'); 
        return; 
      }
      if (Notification.permission === 'granted') { 
        toast('Notifications enabled'); 
        return; 
      }
      const perm = await Notification.requestPermission();
      toast(perm === 'granted' ? 'Notifications enabled' : 'Notifications blocked');
    });

    window.addEventListener('online', () => {
      syncStatus.textContent = 'Online';
      syncStatus.className = 'sync-status online';
      retryPendingChanges();
    });

    window.addEventListener('offline', () => {
      syncStatus.textContent = 'Offline';
      syncStatus.className = 'sync-status offline';
    });

    render();
  </script>

  <!-- Non-module scripts (same as before) -->
  <script>
    (function(){
      function setStatus(el, state, label){
        if (!el) return;
        el.classList.remove('online','offline','error');
        el.classList.add(state);
        el.textContent = label;
      }
      function updateNetworkBadge(){
        var el = document.getElementById('syncStatus');
        if (!el) return;
        if (navigator.onLine) {
          setStatus(el, 'online', 'Online');
        } else {
          setStatus(el, 'offline', 'Offline');
        }
      }
      window.addEventListener('online', updateNetworkBadge);
      window.addEventListener('offline', updateNetworkBadge);
      if (document.readyState !== 'loading') updateNetworkBadge();
      else document.addEventListener('DOMContentLoaded', updateNetworkBadge);

      var testBtn = document.getElementById('testSync');
      var urlInput = document.getElementById('syncUrl');
      async function pingSync(){
        var el = document.getElementById('syncStatus');
        try {
          var url = (urlInput && urlInput.value) || urlInput?.getAttribute('value') || '';
          if (!url) { updateNetworkBadge(); return; }
          const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'ping=1', { method: 'GET', cache:'no-store' });
          if (res.ok) setStatus(el, 'online', 'Online');
          else setStatus(el, 'error', 'Sync Error');
        } catch (e) {
          if (!navigator.onLine) setStatus(el, 'offline', 'Offline');
          else setStatus(el, 'error', 'Sync Error');
        }
      }
      if (testBtn) testBtn.addEventListener('click', function(e){ e.preventDefault(); pingSync(); });
      if (navigator.onLine) setTimeout(pingSync, 800);
    })();
  </script>

  <script>
    (function(){
      function getSyncUrl(){
        var el = document.getElementById('syncUrl');
        var url = (el && (el.value || el.getAttribute('value'))) ? (el.value || el.getAttribute('value')) : '';
        url = (url || '').trim();
        if (!url) throw new Error('Missing sync URL. Add your Google Apps Script Web App URL in Settings.');
        if (!/^https:\/\//i.test(url)) throw new Error('Sync URL must start with https://');
        return url;
      }
      window.__getSyncUrl = getSyncUrl;
    })();
  </script>

  <script>
    (function(){
      async function loadFromServer(opts){
        opts = opts || {};
        const maxRetries = 2;
        const backoff = [300, 900];
        const statusEl = document.getElementById('syncStatus');
        function setStatus(cls, label){
          if (!statusEl) return;
          statusEl.classList.remove('online','offline','error');
          statusEl.classList.add(cls);
          statusEl.textContent = label;
        }
        let url;
        try {
          url = (window.__getSyncUrl && window.__getSyncUrl()) || '';
        } catch(e) {
          console.warn(e.message);
          setStatus('error', 'Sync URL missing');
          return { ok:false, error:e.message };
        }

        async function attempt(i){
          try {
            const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'list=1', {
              method: 'GET',
              headers: { 'Accept': 'application/json' },
              cache: 'no-store',
              redirect: 'follow',
            });
            if (!res.ok) throw new Error('Server responded ' + res.status);
            const data = await res.json();
            setStatus('online', 'Online');
            return { ok:true, data };
          } catch (err) {
            if (i < maxRetries) {
              await new Promise(r => setTimeout(r, backoff[i]));
              return attempt(i+1);
            }
            console.error('loadFromServer failed', err);
            if (!navigator.onLine) setStatus('offline', 'Offline');
            else setStatus('error', 'Sync Error');
            return { ok:false, error: String(err && err.message || err) };
          }
        }
        return attempt(0);
      }
      window.loadFromServer = loadFromServer;
    })();
  </script>
</body>
</html>
