<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memory Cue</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
  <link rel="stylesheet" href="css/teacher.css" />
  <style>
    /* Critical inline styles for immediate rendering */
    .app-layout { display: flex; height: 100vh; overflow: hidden; }
    .content-panel { display: none; }
    .content-panel.active { display: block; }
    .hidden { display: none; }
    .login-view { display:flex; align-items:center; justify-content:center; height:100vh; }
    .login-box { max-width:320px; width:100%; display:flex; flex-direction:column; }
    .login-box input { margin-bottom:0.5rem; padding:0.5rem; }
  </style>
</head>
<body>
  <div id="loginView" class="login-view">
    <form id="loginForm" class="login-box">
      <h2>Login</h2>
      <input type="password" id="loginPassword" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  </div>

  <div id="app" class="app-layout hidden">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
      <div class="sidebar-header">
        <div class="sidebar-logo">Memory Cue</div>
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
          ☰
        </button>
      </div>
      <nav class="sidebar-nav">
        <button class="nav-item active" data-panel="dashboard" aria-selected="true">
          <span class="nav-icon">📊</span>
          <span class="nav-label">Dashboard</span>
        </button>
        <button class="nav-item" data-panel="reminders" aria-selected="false">
          <span class="nav-icon">🔔</span>
          <span class="nav-label">Reminders</span>
        </button>
        <button class="nav-item" data-panel="planner" aria-selected="false">
          <span class="nav-icon">📅</span>
          <span class="nav-label">Planner</span>
        </button>
        <button class="nav-item" data-panel="notes" aria-selected="false">
          <span class="nav-icon">📝</span>
          <span class="nav-label">Notes</span>
        </button>
        <button class="nav-item" data-panel="resources" aria-selected="false">
          <span class="nav-icon">📚</span>
          <span class="nav-label">Resources</span>
        </button>
        <button class="nav-item" data-panel="templates" aria-selected="false">
          <span class="nav-icon">📋</span>
          <span class="nav-label">Templates</span>
        </button>
        <button class="nav-item" data-panel="settings" aria-selected="false">
          <span class="nav-icon">⚙️</span>
          <span class="nav-label">Settings</span>
        </button>
      </nav>
    </aside>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content Area -->
    <div class="main-area">
      <!-- Top Bar -->
      <header class="topbar" role="banner">
        <div class="topbar-left">
          <div class="search-container">
            <input 
              id="q" 
              class="search-input" 
              placeholder="Search reminders, resources, notes..." 
              aria-label="Search"
            />
          </div>
        </div>
        <div class="topbar-right">
          <button class="topbar-btn" id="themeToggle" title="Toggle theme" aria-label="Toggle theme">
            🌙
          </button>
          <div id="syncStatus" class="sync-status offline">Offline</div>
          <button id="voiceBtn" class="topbar-btn" type="button" title="Voice quick add">
            🎙️
          </button>
          <button id="notifBtn" class="topbar-btn" type="button" title="Enable notifications">
            🔔
          </button>
          <div class="quick-add-container">
            <input 
              id="quickAddInput" 
              class="quick-add-input" 
              placeholder="Quick add reminder..." 
              style="display: none;"
            />
          </div>
          <button id="addQuickBtn" class="topbar-btn primary" type="button" title="Add quick reminder">
            + Add
          </button>
          <button id="googleSignInBtn" class="topbar-btn" type="button">
            Sign in
          </button>
          <button id="googleSignOutBtn" class="topbar-btn hidden" type="button">
            <img id="googleAvatar" class="user-avatar hidden" />
            Sign out
          </button>
          <span id="googleUserName" class="text-muted"></span>
        </div>
      </header>

      <!-- Content Panels -->
      <main class="content-area" role="main">
        <!-- Dashboard Panel -->
        <div class="content-panel active" id="dashboardPanel">
          <div class="panel-header">
            <div>
              <h1 class="panel-title">Dashboard</h1>
              <p class="panel-subtitle">Your daily overview and quick agenda</p>
            </div>
          </div>

          <div class="grid grid-2">
            <!-- Today's Agenda -->
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Today's Agenda</h2>
              </div>
              <div class="card-content">
                <div id="todayAgenda" class="agenda-list">
                  <div class="empty-state">
                    <div class="empty-icon">📅</div>
                    <div class="empty-title">No agenda for today</div>
                    <div class="empty-description">Add lessons and reminders to see them here</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Stats -->
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Quick Stats</h2>
              </div>
              <div class="card-content">
                <div class="grid grid-2">
                  <div class="stat-item">
                    <div class="stat-number" id="subjectCount">0</div>
                    <div class="stat-label">Subjects</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-number" id="reminderCount">0</div>
                    <div class="stat-label">Active Reminders</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-number" id="lessonCount">0</div>
                    <div class="stat-label">This Week's Lessons</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-number" id="templateCount">0</div>
                    <div class="stat-label">Templates</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Reminders Panel -->
        <div class="content-panel" id="remindersPanel">
          <div class="panel-header">
            <div>
              <h1 class="panel-title">Reminders</h1>
              <p class="panel-subtitle">Manage your reminders and sync with Firebase</p>
            </div>
            <div class="panel-actions">
              <button id="copyMtlBtn" class="btn-ghost" type="button">Copy MTL</button>
              <label class="btn-ghost" style="cursor: pointer;">
                Import JSON
                <input id="importFile" type="file" accept="application/json" class="sr-only" />
              </label>
              <button id="exportBtn" class="btn-ghost" type="button">Export JSON</button>
            </div>
          </div>

          <div class="grid">
            <!-- Create Reminder Form -->
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Create Reminder</h2>
              </div>
              <div class="card-content">
                <div class="form-row">
                  <div class="form-group flex-1">
                    <label class="sr-only" for="title">Reminder</label>
                    <input id="title" placeholder="e.g., Pick up dog at 6pm #home" />
                    <div id="dateFeedback" style="margin-top: 4px; font-size: 12px; color: var(--text-muted); display: none;"></div>
                  </div>
                  <div class="form-group">
                    <label class="sr-only" for="date">Date</label>
                    <input id="date" type="date" />
                  </div>
                  <div class="form-group">
                    <label class="sr-only" for="time">Time</label>
                    <input id="time" type="time" />
                  </div>
                  <div class="form-group">
                    <select id="priority">
                      <option>High</option>
                      <option selected>Medium</option>
                      <option>Low</option>
                    </select>
                  </div>
                  <button id="saveBtn" class="btn-success" type="button">Save</button>
                </div>
                <div id="status" class="status-message"></div>
              </div>
            </div>

            <!-- Reminders List -->
            <div class="card">
              <div class="card-header">
                <div class="filter-controls">
                  <div class="filter-buttons">
                    <button class="btn-ghost active" data-filter="today" type="button">Today</button>
                    <button class="btn-ghost" data-filter="overdue" type="button">Overdue</button>
                    <button class="btn-ghost" data-filter="all" type="button">All</button>
                    <button class="btn-ghost" data-filter="done" type="button">Completed</button>
                  </div>
                  <select id="sort">
                    <option value="smart">Smart sort</option>
                    <option value="time">Time</option>
                    <option value="priority">Priority</option>
                  </select>
                </div>
              </div>
              <div class="card-content">
                <div id="list" class="task-list" aria-live="polite">
                  <div class="text-muted">Loading...</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Lesson Planner Panel -->
        <div class="content-panel" id="plannerPanel">
          <div class="panel-header">
            <div>
              <h1 class="panel-title">Weekly Lesson Planner</h1>
              <p class="panel-subtitle">Plan and organize your weekly lessons</p>
            </div>
            <div class="panel-actions">
              <button class="btn-ghost" id="manageSubjectsBtn">Manage Subjects</button>
              <button class="btn-primary" id="addLessonBtn">+ Add Lesson</button>
            </div>
          </div>

          <!-- Week Navigation -->
          <div class="week-nav">
            <button class="btn-ghost" id="prevWeekBtn">← Previous</button>
            <div class="week-info">
              <div class="week-title" id="weekTitle">Week of September 9, 2024</div>
              <div class="week-range" id="weekRange">Sep 9 - Sep 13</div>
            </div>
            <button class="btn-ghost" id="nextWeekBtn">Next →</button>
            <button class="btn-ghost" id="todayBtn">Today</button>
          </div>

          <!-- Planner Grid -->
          <div class="card">
            <div class="card-content">
              <div class="planner-grid" id="plannerGrid">
                <!-- Grid will be generated by JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <!-- Notes Panel -->
        <div class="content-panel" id="notesPanel">
          <div class="panel-header">
            <div>
              <h1 class="panel-title">Lesson Notes</h1>
              <p class="panel-subtitle">Rich text notes for your subjects and general scratch pad</p>
            </div>
            <div class="panel-actions">
              <select id="notesSubjectSelect">
                <option value="global">Global Scratch Pad</option>
              </select>
            </div>
          </div>

          <div class="card">
            <div class="card-content">
              <div class="notes-editor">
                <div class="notes-toolbar">
                  <button data-command="bold" title="Bold">B</button>
                  <button data-command="italic" title="Italic">I</button>
                  <button data-command="insertUnorderedList" title="Bullet List">•</button>
                  <button data-command="insertOrderedList" title="Numbered List">1.</button>
                  <button data-command="removeFormat" title="Clear Formatting">Clear</button>
                </div>
                <div 
                  class="notes-content" 
                  id="notesContent" 
                  contenteditable="true" 
                  data-placeholder="Start typing your notes..."
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Resources Panel -->
        <div class="content-panel" id="resourcesPanel">
          <div class="panel-header">
            <div>
              <h1 class="panel-title">Resource Library</h1>
              <p class="panel-subtitle">Save and organize links and files for your lessons</p>
            </div>
            <div class="panel-actions">
              <button class="btn-primary" id="addResourceBtn">+ Add Resource</button>
            </div>
          </div>

          <div class="card">
            <div class="card-content">
              <div id="resourcesList">
                <div class="empty-state">
                  <div class="empty-icon">📚</div>
                  <div class="empty-title">No resources yet</div>
                  <div class="empty-description">Add links, files, and other resources for your lessons</div>
                  <button class="btn-primary mt-4" onclick="document.getElementById('addResourceBtn').click()">
                    Add First Resource
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Templates Panel -->
        <div class="content-panel" id="templatesPanel">
          <div class="panel-header">
            <div>
              <h1 class="panel-title">Lesson Templates</h1>
              <p class="panel-subtitle">Save and reuse lesson structures</p>
            </div>
            <div class="panel-actions">
              <button class="btn-primary" id="createTemplateBtn">+ Create Template</button>
            </div>
          </div>

          <div class="card">
            <div class="card-content">
              <div id="templateGrid" class="template-grid">
                <div class="empty-state">
                  <div class="empty-icon">📋</div>
                  <div class="empty-title">No templates yet</div>
                  <div class="empty-description">Create lesson templates to quickly add structured lessons to your planner</div>
                  <button class="btn-primary mt-4" onclick="document.getElementById('createTemplateBtn').click()">
                    Create First Template
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings Panel -->
        <div class="content-panel" id="settingsPanel">
          <div class="panel-header">
            <div>
              <h1 class="panel-title">Settings</h1>
              <p class="panel-subtitle">Configure your preferences and sync settings</p>
            </div>
          </div>

          <div class="grid">
            <!-- Calendar Sync Settings -->
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Calendar Sync Settings</h2>
              </div>
              <div class="card-content">
                <div class="form-row">
                  <div class="form-group flex-1">
                    <label class="form-label" for="syncUrl">Google Apps Script URL</label>
                    <input id="syncUrl" placeholder="https://script.google.com/macros/s/AKfycb.../exec" />
                  </div>
                  <button id="saveSettings" class="btn-success" type="button">Save</button>
                  <button id="testSync" class="btn-ghost" type="button">Test</button>
                </div>
                <div class="text-muted" style="margin-top: var(--space-4);">
                  <strong>Tip:</strong> In Google Apps Script, click <strong>Deploy → New deployment → Web app</strong>,
                  set <strong>Execute as: Me</strong>, <strong>Who has access: Anyone with the link</strong>, then copy the URL (ends with <code>/exec</code>).
                </div>
              </div>
            </div>

            <!-- Teacher Data Management -->
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Teacher Data</h2>
              </div>
              <div class="card-content">
                <div class="form-row">
                  <button id="exportTeacherDataBtn" class="btn-ghost" type="button">Export Teacher Data</button>
                  <label class="btn-ghost" style="cursor: pointer;">
                    Import Teacher Data
                    <input id="importTeacherDataFile" type="file" accept="application/json" class="sr-only" />
                  </label>
                  <button id="clearTeacherDataBtn" class="btn-ghost" type="button" style="color: var(--danger);">Clear All Data</button>
                </div>
                <div class="text-muted" style="margin-top: var(--space-4);">
                  Export/import includes subjects, lesson plans, notes, resources, and templates. Reminders are managed separately via Firebase.
                </div>
              </div>
            </div>

            <!-- Theme Settings -->
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Appearance</h2>
              </div>
              <div class="card-content">
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label" for="themeSelect">Theme</label>
                    <select id="themeSelect">
                      <option value="auto">Auto (System)</option>
                      <option value="dark">Dark</option>
                      <option value="light">Light</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Teacher App JavaScript (without Firebase dependencies) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAmAMiz0zG3dAhZJhOy1DYj8fKVDObL36c",
      authDomain: "memory-cue-app.firebaseapp.com",
      projectId: "memory-cue-app",
      storageBucket: "memory-cue-app.firebasestorage.app",
      messagingSenderId: "751284466633",
      appId: "1:751284466633:web:3b10742970bef1a5d5ee18",
      measurementId: "G-R0V4M7VCE6"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(err => { console.warn('Firestore persistence not enabled:', err?.code || err); });
    const auth = getAuth(app);

    // App state
    let items = [];
    let filter = 'today';
    let sortKey = 'smart';
    let listening = false;
    let recog = null;
    let userId = null;
    let unsubscribe = null;
    let currentUser = null;
    let currentPanel = 'dashboard';
    let currentWeek = new Date();
    let currentSubjectForNotes = 'global';

    // Teacher data state
    let subjects = [];
    let lessonPlans = {};
    let notes = { globalScratch: '', subjects: {} };
    let resources = [];
    let templates = [];

    const TZ = 'Australia/Adelaide';
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // Utility Functions
    function generateISOWeekKey(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const start = new Date(year, 0, 1);
      const days = Math.floor((d - start) / (24 * 60 * 60 * 1000));
      const week = Math.ceil((days + start.getDay() + 1) / 7);
      return `${year}-W${String(week).padStart(2, '0')}`;
    }

    function loadTeacherData() {
      try {
        subjects = JSON.parse(localStorage.getItem('tcSubjects') || '[]');
        lessonPlans = JSON.parse(localStorage.getItem('tcLessonPlans') || '{}');
        notes = JSON.parse(localStorage.getItem('tcNotes') || '{"globalScratch":"","subjects":{}}');
        resources = JSON.parse(localStorage.getItem('tcResources') || '[]');
        templates = JSON.parse(localStorage.getItem('tcTemplates') || '[]');
      } catch (e) {
        console.error('Error loading teacher data:', e);
        // Reset to defaults if corrupted
        subjects = [];
        lessonPlans = {};
        notes = { globalScratch: '', subjects: {} };
        resources = [];
        templates = [];
      }
    }

    function saveTeacherData() {
      try {
        localStorage.setItem('tcSubjects', JSON.stringify(subjects));
        localStorage.setItem('tcLessonPlans', JSON.stringify(lessonPlans));
        localStorage.setItem('tcNotes', JSON.stringify(notes));
        localStorage.setItem('tcResources', JSON.stringify(resources));
        localStorage.setItem('tcTemplates', JSON.stringify(templates));
      } catch (e) {
        console.error('Error saving teacher data:', e);
        toast('Failed to save data - storage may be full');
      }
    }

    function loadTheme() {
      const saved = localStorage.getItem('mcTheme');
      const theme = saved || 'auto';
      applyTheme(theme);
      const themeSelect = $('#themeSelect');
      if (themeSelect) themeSelect.value = theme;
    }

    function applyTheme(theme) {
      const html = document.documentElement;
      if (theme === 'light') {
        html.setAttribute('data-theme', 'light');
      } else if (theme === 'dark') {
        html.setAttribute('data-theme', 'dark');
      } else {
        // Auto mode - use system preference
        if (window.matchMedia('(prefers-color-scheme: light)').matches) {
          html.setAttribute('data-theme', 'light');
        } else {
          html.setAttribute('data-theme', 'dark');
        }
      }
      localStorage.setItem('mcTheme', theme);
      updateThemeToggle();
    }

    function updateThemeToggle() {
      const toggle = $('#themeToggle');
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      if (toggle) toggle.textContent = isDark ? '☀️' : '🌙';
    }

    // Panel Navigation
    function showPanel(panelId) {
      // Hide all panels
      $$('.content-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      
      // Show target panel
      const targetPanel = $(`#${panelId}Panel`);
      if (targetPanel) {
        targetPanel.classList.add('active');
        currentPanel = panelId;
      }

      // Update navigation
      $$('.nav-item').forEach(item => {
        item.classList.remove('active');
        item.setAttribute('aria-selected', 'false');
      });
      
      const activeNavItem = $(`.nav-item[data-panel="${panelId}"]`);
      if (activeNavItem) {
        activeNavItem.classList.add('active');
        activeNavItem.setAttribute('aria-selected', 'true');
      }

      // Initialize panel-specific content
      if (panelId === 'planner') {
        initializePlanner();
      } else if (panelId === 'notes') {
        initializeNotes();
      } else if (panelId === 'resources') {
        renderResources();
      } else if (panelId === 'templates') {
        renderTemplates();
      } else if (panelId === 'dashboard') {
        updateDashboard();
      } else if (panelId === 'reminders') {
        render();
      }
    }

    // Dashboard Functions
    function updateDashboard() {
      updateQuickStats();
      renderTodayAgenda();
    }

    function updateQuickStats() {
      const subjectCountEl = $('#subjectCount');
      const reminderCountEl = $('#reminderCount');
      const lessonCountEl = $('#lessonCount');
      const templateCountEl = $('#templateCount');
      
      if (subjectCountEl) subjectCountEl.textContent = subjects.length;
      if (reminderCountEl) reminderCountEl.textContent = items.filter(item => !item.done).length;
      
      const currentWeekKey = generateISOWeekKey(new Date());
      const weekLessons = lessonPlans[currentWeekKey] || [];
      if (lessonCountEl) lessonCountEl.textContent = weekLessons.length;
      if (templateCountEl) templateCountEl.textContent = templates.length;
    }

    function renderTodayAgenda() {
      const agendaContainer = $('#todayAgenda');
      if (!agendaContainer) return;
      
      const today = new Date().toISOString().split('T')[0];
      
      // Get today's lessons
      const currentWeekKey = generateISOWeekKey(new Date());
      const weekLessons = lessonPlans[currentWeekKey] || [];
      const todayLessons = weekLessons.filter(lesson => {
        const lessonDate = new Date(currentWeek);
        const dayOffset = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].indexOf(lesson.day);
        lessonDate.setDate(lessonDate.getDate() - lessonDate.getDay() + 1 + dayOffset);
        return lessonDate.toISOString().split('T')[0] === today;
      });

      // Get today's reminders
      const todayReminders = items.filter(item => {
        if (!item.due) return false;
        return item.due.split('T')[0] === today && !item.done;
      });

      const agendaItems = [];

      // Add lessons
      todayLessons.forEach(lesson => {
        const subject = subjects.find(s => s.id === lesson.subjectId);
        agendaItems.push({
          time: lesson.slot,
          title: lesson.title,
          type: 'lesson',
          meta: subject ? subject.name : 'Unknown Subject',
          color: subject ? subject.color : 'blue'
        });
      });

      // Add reminders
      todayReminders.forEach(reminder => {
        const time = reminder.due ? new Date(reminder.due).toLocaleTimeString('en-AU', { 
          hour: '2-digit', 
          minute: '2-digit' 
        }) : '';
        agendaItems.push({
          time,
          title: reminder.title,
          type: 'reminder',
          meta: `${reminder.priority} priority`,
          color: reminder.priority === 'High' ? 'red' : reminder.priority === 'Medium' ? 'orange' : 'green'
        });
      });

      // Sort by time
      agendaItems.sort((a, b) => {
        if (a.time < b.time) return -1;
        if (a.time > b.time) return 1;
        return 0;
      });

      if (agendaItems.length === 0) {
        agendaContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">📅</div>
            <div class="empty-title">No agenda for today</div>
            <div class="empty-description">Add lessons and reminders to see them here</div>
          </div>
        `;
        return;
      }

      agendaContainer.innerHTML = agendaItems.map(item => `
        <div class="agenda-item">
          <div class="agenda-time">${item.time}</div>
          <div class="agenda-content">
            <div class="agenda-title">${escapeHtml(item.title)}</div>
            <div class="agenda-meta">${item.meta}</div>
          </div>
          <div class="subject-dot subject-color-${item.color}"></div>
        </div>
      `).join('');
    }

    // Initialize teacher app
    function initializeTeacherApp() {
      loadTeacherData();
      loadTheme();
      setupEventListeners();
      
      // Load demo reminders
      try {
        const demoReminders = localStorage.getItem('demoReminders');
        if (demoReminders) {
          items = JSON.parse(demoReminders);
        }
      } catch (e) {
        console.error('Error loading demo reminders:', e);
        items = [];
      }
      
      showPanel('dashboard');
    }

    function setupEventListeners() {
      // Navigation
      $$('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const panel = item.getAttribute('data-panel');
          showPanel(panel);
        });
      });

      // Sidebar toggle
      $('#sidebarToggle')?.addEventListener('click', () => {
        const sidebar = $('#sidebar');
        if (window.innerWidth <= 1024) {
          // Mobile behavior
          sidebar.classList.toggle('open');
          $('#sidebarOverlay').classList.toggle('open');
        } else {
          // Desktop behavior
          sidebar.classList.toggle('collapsed');
        }
      });

      // Mobile sidebar overlay
      $('#sidebarOverlay')?.addEventListener('click', () => {
        $('#sidebar').classList.remove('open');
        $('#sidebarOverlay').classList.remove('open');
      });

      // Theme toggle
      $('#themeToggle')?.addEventListener('click', () => {
        const current = localStorage.getItem('mcTheme') || 'auto';
        const next = current === 'dark' ? 'light' : current === 'light' ? 'auto' : 'dark';
        applyTheme(next);
      });

      $('#themeSelect')?.addEventListener('change', (e) => {
        applyTheme(e.target.value);
      });

      // Teacher data export/import
      $('#exportTeacherDataBtn')?.addEventListener('click', exportTeacherData);
      $('#importTeacherDataFile')?.addEventListener('change', importTeacherData);
      $('#clearTeacherDataBtn')?.addEventListener('click', clearTeacherData);

      // Search functionality
      q?.addEventListener('input', handleSearch);
    }

    function handleSearch() {
      const query = q.value.trim().toLowerCase();
      
      if (currentPanel === 'reminders') {
        render(); // Existing reminder search
      } else if (currentPanel === 'resources') {
        renderResources();
      } else if (currentPanel === 'notes') {
        // Could implement note search in the future
      }
    }

    function exportTeacherData() {
      const teacherData = {
        subjects,
        lessonPlans,
        notes,
        resources,
        templates,
        exportedAt: new Date().toISOString(),
        version: '1.0'
      };

      const blob = new Blob([JSON.stringify(teacherData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `memory-cue-teacher-data-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      toast('Teacher data exported successfully');
    }

    function importTeacherData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          if (data.subjects) subjects = data.subjects;
          if (data.lessonPlans) lessonPlans = data.lessonPlans;
          if (data.notes) notes = data.notes;
          if (data.resources) resources = data.resources;
          if (data.templates) templates = data.templates;

          saveTeacherData();
          
          // Refresh current panel
          if (currentPanel === 'planner') initializePlanner();
          if (currentPanel === 'notes') initializeNotes();
          if (currentPanel === 'resources') renderResources();
          if (currentPanel === 'templates') renderTemplates();
          if (currentPanel === 'dashboard') updateDashboard();

          toast('Teacher data imported successfully');
        } catch (error) {
          console.error('Import error:', error);
          toast('Failed to import data - invalid file format');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function clearTeacherData() {
      if (!confirm('Are you sure you want to clear all teacher data? This cannot be undone.')) {
        return;
      }

      subjects = [];
      lessonPlans = {};
      notes = { globalScratch: '', subjects: {} };
      resources = [];
      templates = [];

      saveTeacherData();
      
      // Refresh current panel
      showPanel(currentPanel);
      toast('All teacher data cleared');
    }

    // Placeholder functions for new features (to be implemented)
    function initializePlanner() {
      toast('Planner feature coming soon');
    }

    function initializeNotes() {
      toast('Notes feature coming soon');
    }

    function renderResources() {
      toast('Resources feature coming soon');
    }

    function renderTemplates() {
      toast('Templates feature coming soon');
    }

    // DOM elements
    const q = $('#q');
    const title = $('#title');
    const dateFeedback = $('#dateFeedback');
    const date = $('#date');
    const time = $('#time');
    const priority = $('#priority');
    const saveBtn = $('#saveBtn');
    const list = $('#list');
    const statusEl = $('#status');
    const voiceBtn = $('#voiceBtn');
    const notifBtn = $('#notifBtn');
    const addQuickBtn = $('#addQuickBtn');
    const copyMtlBtn = $('#copyMtlBtn');
    const importFile = $('#importFile');
    const exportBtn = $('#exportBtn');
    const sortSel = $('#sort');
    const syncStatus = $('#syncStatus');
    const openSettings = $('#openSettings');
    const syncUrlInput = $('#syncUrl');
    const saveSettings = $('#saveSettings');
    const testSync = $('#testSync');
    const settingsSection = $('#settingsSection');
    const googleSignInBtn = $('#googleSignInBtn');
    const googleSignOutBtn = $('#googleSignOutBtn');
    const googleAvatar = $('#googleAvatar');
    const googleUserName = $('#googleUserName');

    // Restore saved Sync URL
    const savedSyncUrl = localStorage.getItem('syncUrl') || '';
    if (savedSyncUrl) syncUrlInput.value = savedSyncUrl;

    // Authentication
    googleSignInBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try { await signInWithPopup(auth, provider); }
      catch { toast('Google sign-in failed'); }
    });

    googleSignOutBtn.addEventListener('click', async () => {
      try { await signOut(auth); toast('Signed out'); }
      catch { toast('Sign-out failed'); }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        syncStatus.textContent = 'Online';
        syncStatus.className = 'sync-status online';
        googleSignInBtn.classList.add('hidden');
        googleSignOutBtn.classList.remove('hidden');
        if (user.photoURL) {
          googleAvatar.classList.remove('hidden');
          googleAvatar.src = user.photoURL;
        } else {
          googleAvatar.classList.add('hidden');
          googleAvatar.src = '';
        }
        googleUserName.textContent = user.displayName || user.email || '';
        setupFirestoreSync();
      } else {
        googleSignInBtn.classList.remove('hidden');
        googleSignOutBtn.classList.add('hidden');
        googleAvatar.classList.add('hidden');
        googleAvatar.src = '';
        googleUserName.textContent = '';
        syncStatus.textContent = 'Offline';
        syncStatus.className = 'sync-status offline';
        items = [];
        render();
      }
    });

    // Firestore real-time sync
    function setupFirestoreSync() {
      if (!userId) {
        items = [];
        render();
        return;
      }
      if (unsubscribe) unsubscribe();
      const userCollection = collection(db, 'users', userId, 'reminders');
      const qSnap = query(userCollection, orderBy('updatedAt', 'desc'));

      unsubscribe = onSnapshot(qSnap, (snapshot) => {
        const remoteItems = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          remoteItems.push({
            id: doc.id,
            title: data.title,
            priority: data.priority,
            notes: data.notes || '',
            done: data.done,
            due: data.due,
            createdAt: data.createdAt,
            updatedAt: data.updatedAt
          });
        });

        items = mergeWithLocal(remoteItems);
        render();
      }, (error) => {
        console.error('Firestore sync error:', error);
        syncStatus.textContent = 'Sync Error';
        syncStatus.className = 'sync-status error';
      });
    }

    function mergeWithLocal(remoteItems) {
      const localPending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const merged = new Map();

      remoteItems.forEach(item => merged.set(item.id, item));

      localPending.forEach(change => {
        if (change.action === 'upsert') {
          merged.set(change.item.id, change.item);
        } else if (change.action === 'delete') {
          merged.delete(change.itemId);
        }
      });

      return Array.from(merged.values());
    }

    async function saveToFirebase(item) {
      if (!userId) return;
      try {
        await setDoc(doc(db, 'users', userId, 'reminders', item.id), {
          title: item.title,
          priority: item.priority,
          notes: item.notes,
          done: item.done,
          due: item.due,
          createdAt: item.createdAt,
          updatedAt: item.updatedAt
        });
        removePendingChange(item.id);
      } catch (error) {
        console.error('Save failed:', error);
        addPendingChange({ action: 'upsert', item });
        syncStatus.textContent = 'Sync Pending';
        syncStatus.className = 'sync-status offline';
      }
    }

    async function deleteFromFirebase(id) {
      if (!userId) return;
      try {
        await deleteDoc(doc(db, 'users', userId, 'reminders', id));
        removePendingChange(id);
      } catch (error) {
        console.error('Delete failed:', error);
        addPendingChange({ action: 'delete', itemId: id });
      }
    }

    function addPendingChange(change) {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const filtered = pending.filter(p => 
        (p.action === 'upsert' && p.item.id !== (change.item?.id || change.itemId)) ||
        (p.action === 'delete' && p.itemId !== (change.item?.id || change.itemId))
      );
      filtered.push(change);
      localStorage.setItem('pendingChanges', JSON.stringify(filtered));
    }

    function removePendingChange(itemId) {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const filtered = pending.filter(p => 
        (p.action === 'upsert' && p.item.id !== itemId) ||
        (p.action === 'delete' && p.itemId !== itemId)
      );
      localStorage.setItem('pendingChanges', JSON.stringify(filtered));
    }

    async function retryPendingChanges() {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      for (const change of pending) {
        try {
          if (change.action === 'upsert') {
            await saveToFirebase(change.item);
          } else if (change.action === 'delete') {
            await deleteFromFirebase(change.itemId);
          }
        } catch (error) {
          break;
        }
      }
    }

    async function tryCalendarSync(task) {
      const url = (localStorage.getItem('syncUrl') || '').trim();
      if (!url) return;
      
      const payload = { 
        title: task.title, 
        dueIso: task.due || null, 
        priority: task.priority || 'Medium' 
      };
      
      try {
        await fetch(url, { 
          method: 'POST', 
          headers: { 'Content-Type': 'text/plain' }, 
          body: JSON.stringify(payload) 
        });
        toast('Synced to Calendar');
      } catch (e) { 
        toast('Calendar sync failed (offline?)'); 
      }
    }

    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    
    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function toISODatePart(d) { return d.toISOString().slice(0, 10); }
    function todayISO() {
      const now = new Date();
      const adelaideDate = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
      return toISODatePart(adelaideDate);
    }
    function priorityWeight(p) { return p === 'High' ? 3 : p === 'Medium' ? 2 : 1; }
    function smartCompare(a, b) {
      const pr = priorityWeight(b.priority) - priorityWeight(a.priority); if (pr) return pr;
      const at = +new Date(a.due || 0), bt = +new Date(b.due || 0); if (at !== bt) return at - bt;
      return (a.updatedAt || 0) > (b.updatedAt || 0) ? -1 : 1;
    }
    function fmtDayDate(iso) {
      if (!iso) return '—';
      try {
        const d = new Date(iso + 'T00:00:00');
        return new Intl.DateTimeFormat('en-AU', { timeZone: TZ, weekday: 'long', day: 'numeric', month: 'long' }).format(d);
      } catch { return iso; }
    }
    function parseQuickWhen(text) {
      text = text.toLowerCase();
      let when = { date: todayISO(), time: '' };

      // Helper function to get next occurrence of a day
      const getNextDayOfWeek = (dayIndex) => {
        const today = new Date();
        const currentDay = today.getDay();
        const daysUntilTarget = (dayIndex - currentDay + 7) % 7;
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + (daysUntilTarget === 0 ? 7 : daysUntilTarget));
        return targetDate;
      };

      // Helper function to get this occurrence of a day
      const getThisDayOfWeek = (dayIndex) => {
        const today = new Date();
        const currentDay = today.getDay();
        const daysUntilTarget = (dayIndex - currentDay + 7) % 7;
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + daysUntilTarget);
        return targetDate;
      };

      // Day names mapping
      const dayNames = {
        'sunday': 0, 'sun': 0,
        'monday': 1, 'mon': 1,
        'tuesday': 2, 'tue': 2, 'tues': 2,
        'wednesday': 3, 'wed': 3,
        'thursday': 4, 'thu': 4, 'thur': 4, 'thurs': 4,
        'friday': 5, 'fri': 5,
        'saturday': 6, 'sat': 6
      };

      // Month names mapping
      const monthNames = {
        'january': 0, 'jan': 0,
        'february': 1, 'feb': 1,
        'march': 2, 'mar': 2,
        'april': 3, 'apr': 3,
        'may': 4,
        'june': 5, 'jun': 5,
        'july': 6, 'jul': 6,
        'august': 7, 'aug': 7,
        'september': 8, 'sep': 8, 'sept': 8,
        'october': 9, 'oct': 9,
        'november': 10, 'nov': 10,
        'december': 11, 'dec': 11
      };

      // Detect "tomorrow"
      if (/\btomorrow\b/.test(text)) {
        const d = new Date(); d.setDate(d.getDate() + 1); when.date = toISODatePart(d);
      }
      // Detect "today"
      else if (/\btoday\b/.test(text)) {
        when.date = todayISO();
      }
      // Detect "next [day]"
      else if (/\bnext\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\bnext\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getNextDayOfWeek(dayIndex);
        when.date = toISODatePart(targetDate);
      }
      // Detect "this [day]"
      else if (/\bthis\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\bthis\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getThisDayOfWeek(dayIndex);
        when.date = toISODatePart(targetDate);
      }
      // Detect standalone day names (assume next occurrence)
      else if (/\b(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\b(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getNextDayOfWeek(dayIndex);
        when.date = toISODatePart(targetDate);
      }
      // Detect "in X days"
      else if (/\bin\s+(\d+)\s+days?\b/.test(text)) {
        const match = text.match(/\bin\s+(\d+)\s+days?\b/);
        const days = parseInt(match[1], 10);
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + days);
        when.date = toISODatePart(targetDate);
      }
      // Detect "this weekend" (assume Saturday)
      else if (/\bthis\s+weekend\b/.test(text)) {
        const targetDate = getThisDayOfWeek(6); // Saturday
        when.date = toISODatePart(targetDate);
      }
      // Detect "next weekend"
      else if (/\bnext\s+weekend\b/.test(text)) {
        const targetDate = getNextDayOfWeek(6); // Saturday
        when.date = toISODatePart(targetDate);
      }
      // Detect "next week"
      else if (/\bnext\s+week\b/.test(text)) {
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + 7);
        when.date = toISODatePart(targetDate);
      }
      // Detect specific dates like "september 15" or "sep 15"
      else if (/\b(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)\s+(\d{1,2})(st|nd|rd|th)?\b/.test(text)) {
        const match = text.match(/\b(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)\s+(\d{1,2})(st|nd|rd|th)?\b/);
        const monthIndex = monthNames[match[1]];
        const day = parseInt(match[2], 10);
        const targetDate = new Date();
        targetDate.setMonth(monthIndex, day);
        // If the date has passed this year, assume next year
        if (targetDate < new Date()) {
          targetDate.setFullYear(targetDate.getFullYear() + 1);
        }
        when.date = toISODatePart(targetDate);
      }
      // Detect date formats like "15/09" or "09/15" or "15/09/2025"
      else if (/\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/.test(text)) {
        const match = text.match(/\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/);
        const first = parseInt(match[1], 10);
        const second = parseInt(match[2], 10);
        let year = match[3] ? parseInt(match[3], 10) : new Date().getFullYear();
        
        // Handle 2-digit years
        if (year < 100) {
          year += year < 50 ? 2000 : 1900;
        }
        
        // Assume DD/MM format (common in AU)
        if (first <= 12 && second <= 12) {
          // If both could be month or day, prefer DD/MM format
          const targetDate = new Date(year, second - 1, first);
          when.date = toISODatePart(targetDate);
        } else if (first <= 31 && second <= 12) {
          // DD/MM format
          const targetDate = new Date(year, second - 1, first);
          when.date = toISODatePart(targetDate);
        } else if (first <= 12 && second <= 31) {
          // MM/DD format
          const targetDate = new Date(year, first - 1, second);
          when.date = toISODatePart(targetDate);
        }
      }

      const mHm = text.match(/\b(\d{1,2}):(\d{2})\b/);
      const m12 = text.match(/\b(\d{1,2})\s*(am|pm)\b/);
      if (mHm) { when.time = `${String(mHm[1]).padStart(2, '0')}:${mHm[2]}`; }
      else if (m12) {
        let h = parseInt(m12[1], 10) % 12; if (m12[2] === 'pm') h += 12; when.time = `${String(h).padStart(2, '0')}:00`;
      }
      return when;
    }

    function addItem(obj) {
      const item = {
        id: uid(),
        title: obj.title.trim(),
        priority: obj.priority || 'Medium',
        notes: obj.notes || '',
        done: false,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        due: obj.due || null
      };

      items = [item, ...items];
      render();

      // In demo mode, just save to localStorage
      localStorage.setItem('demoReminders', JSON.stringify(items));
      toast('Reminder added (demo mode)');
      
      return item;
    }

    function toggleDone(id) {
      const item = items.find(x => x.id === id);
      if (item) {
        item.done = !item.done;
        item.updatedAt = Date.now();
        render();
        saveToFirebase(item);
      }
    }

    function removeItem(id) {
      items = items.filter(x => x.id !== id);
      render();
      deleteFromFirebase(id);
    }

    function render() {
      const query = q.value.trim().toLowerCase();

      const now = new Date();
      const adelaideNow = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
      const todayStart = new Date(adelaideNow);
      todayStart.setHours(0, 0, 0, 0);
      const todayEnd = new Date(adelaideNow);
      todayEnd.setHours(23, 59, 59, 999);

      let rows = items.slice();

      if (query) {
        rows = rows.filter(r =>
          r.title.toLowerCase().includes(query) || (r.notes || '').toLowerCase().includes(query)
        );
      }

      rows = rows.filter(r => {
        if (filter === 'done') return r.done;
        if (filter === 'overdue') return !r.done && r.due && new Date(r.due) < adelaideNow;
        if (filter === 'today') {
          if (!r.due) return true;
          const dueDate = new Date(r.due);
          const dueDateAdelaide = new Date(dueDate.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
          return dueDateAdelaide >= todayStart && dueDateAdelaide <= todayEnd;
        }
        return true;
      });

      rows.sort((a, b) => {
        if (sortKey === 'time') return (+new Date(a.due || 0)) - (+new Date(b.due || 0));
        if (sortKey === 'priority') return priorityWeight(b.priority) - priorityWeight(a.priority);
        return smartCompare(a, b);
      });

      // Update filter button states
      $$('[data-filter]').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
      });

      list.innerHTML = '';
      if (rows.length === 0) {
        list.innerHTML = '<div class="text-muted">No reminders found.</div>';
        return;
      }

      rows.forEach(r => {
        const div = document.createElement('div');
        div.className = 'task-item' + (r.done ? ' completed' : '');
        
        const dueTxt = r.due
          ? new Date(r.due).toLocaleString('en-AU', { timeZone: TZ, hour: '2-digit', minute: '2-digit' }) +
            ' • ' + fmtDayDate(r.due.slice(0, 10))
          : 'No due date';

        const priorityClass = `priority-${r.priority.toLowerCase()}`;
        
        div.innerHTML = `
          <input type="checkbox" ${r.done ? 'checked' : ''} aria-label="Mark complete" />
          <div class="task-content">
            <div class="task-title">${escapeHtml(r.title)}</div>
            <div class="task-meta">
              <span>${dueTxt}</span>
              <span class="priority-badge ${priorityClass}">${r.priority}</span>
              ${r.notes ? `<span>${escapeHtml(r.notes)}</span>` : ''}
            </div>
          </div>
          <div class="task-actions">
            <button class="btn-ghost" data-del type="button">Delete</button>
          </div>`;
        
        div.querySelector('input').addEventListener('change', () => toggleDone(r.id));
        div.querySelector('[data-del]').addEventListener('click', () => removeItem(r.id));
        list.appendChild(div);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) =>
        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
      );
    }

    function toast(msg) {
      console.log('Toast:', msg);
      statusEl.textContent = msg; 
      clearTimeout(toast._t);
      toast._t = setTimeout(() => statusEl.textContent = '', 3000);
    }

    // Event Listeners
    saveBtn.addEventListener('click', () => {
      const t = title.value.trim(); 
      if (!t) { 
        toast('Add a reminder title'); 
        return; 
      }
      let due = null;
      if (date.value || time.value) {
        const d = (date.value || todayISO());
        const tm = (time.value || '09:00');
        due = new Date(`${d}T${tm}:00`).toISOString();
      } else {
        const p = parseQuickWhen(t);
        if (p.time) { 
          due = new Date(`${p.date}T${p.time}:00`).toISOString(); 
        }
      }
      addItem({ title: t, priority: priority.value, due });
      title.value = ''; 
      time.value = '';
    });

    // Add real-time date feedback
    function updateDateFeedback() {
      const text = title.value.trim();
      if (!text) {
        dateFeedback.style.display = 'none';
        return;
      }
      
      try {
        const parsed = parseQuickWhen(text);
        const today = todayISO();
        
        if (parsed.date !== today || parsed.time) {
          let feedback = '';
          
          if (parsed.date !== today) {
            const dateObj = new Date(parsed.date + 'T00:00:00');
            feedback += `📅 ${fmtDayDate(parsed.date)}`;
          }
          
          if (parsed.time) {
            feedback += `${feedback ? ' ' : ''}🕐 ${parsed.time}`;
          }
          
          if (feedback) {
            dateFeedback.textContent = `Parsed: ${feedback}`;
            dateFeedback.style.display = 'block';
          } else {
            dateFeedback.style.display = 'none';
          }
        } else {
          dateFeedback.style.display = 'none';
        }
      } catch (e) {
        dateFeedback.style.display = 'none';
      }
    }
    
    title.addEventListener('input', debounce(updateDateFeedback, 300));

    addQuickBtn.addEventListener('click', () => {
      if (!title.value.trim()) {
        title.focus(); 
        toast('Type something like "pick up dog at 6pm"'); 
        return;
      }
      saveBtn.click();
    });

    q.addEventListener('input', render);
    sortSel.addEventListener('change', () => { 
      sortKey = sortSel.value; 
      render(); 
    });
    
    $$('button[data-filter]').forEach(b => b.addEventListener('click', () => {
      filter = b.getAttribute('data-filter'); 
      render();
    }));

    copyMtlBtn.addEventListener('click', () => {
      const lines = items.filter(x => !x.done).map(x => {
        const datePart = x.due ? fmtDayDate(x.due.slice(0, 10)) : '';
        const timePart = x.due ? new Date(x.due).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' }) : '';
        const pieces = [
          'mtl ' + x.title,
          x.due ? `Due Date: ${datePart}` : '',
          x.due ? `Time: ${timePart}` : '',
          `Status: Not started`,
        ].filter(Boolean);
        return pieces.join('\n');
      });
      if (lines.length === 0) { 
        toast('No active tasks to copy'); 
        return; 
      }
      navigator.clipboard.writeText(lines.join('\n\n')).then(() => {
        toast('Copied for Master Task List');
      }).catch(() => toast('Copy failed'));
    });

    importFile.addEventListener('change', () => {
      const f = importFile.files[0]; 
      if (!f) return;
      const rd = new FileReader();
      rd.onload = () => {
        try { 
          const importedItems = JSON.parse(String(rd.result) || '[]'); 
          importedItems.forEach(item => {
            item.id = uid();
            items = [item, ...items];
            saveToFirebase(item);
          });
          render();
          toast('Import successful');
        }
        catch (err) { 
          toast('Invalid JSON'); 
        }
      };
      rd.readAsText(f);
      importFile.value = '';
    });

    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'memory-cue.json'; 
      a.click();
      URL.revokeObjectURL(url);
    });

    openSettings?.addEventListener('click', () => {
      if (settingsSection) {
        settingsSection.classList.remove('hidden');
        settingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });

    saveSettings.addEventListener('click', () => {
      const url = syncUrlInput.value.trim();
      localStorage.setItem('syncUrl', url);
      toast('Calendar sync settings saved');
    });

    testSync.addEventListener('click', async () => {
      const url = syncUrlInput.value.trim();
      if (!url) { 
        toast('Enter Google Apps Script URL first'); 
        return; 
      }
      try {
        const r = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ title: 'Test from Memory Cue', dueIso: null, priority: 'Low' })
        });
        toast(r.ok ? 'Calendar test sent successfully' : 'Calendar sync error');
      } catch (e) { 
        toast('Calendar sync failed (check URL & deploy)'); 
      }
    });

    // Voice recognition
    try {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SR) {
        recog = new SR();
        recog.lang = 'en-AU';
        recog.interimResults = false;
        recog.onresult = (e) => {
          const t = e.results[0][0].transcript || '';
          title.value = t;
          toast('Heard: ' + t);
        };
        recog.onend = () => { 
          listening = false; 
          voiceBtn.textContent = '🎙️ Voice'; 
        };
      }
    } catch { }

    voiceBtn.addEventListener('click', () => {
      if (!recog) return;
      if (!listening) { 
        try { 
          recog.start(); 
          listening = true; 
          voiceBtn.textContent = '👂 Listening...'; 
        } catch { } 
      } else { 
        try { 
          recog.stop(); 
        } catch { } 
        listening = false; 
        voiceBtn.textContent = '🎙️ Voice'; 
      }
    });

    notifBtn.addEventListener('click', async () => {
      if (!('Notification' in window)) { 
        toast('Notifications not supported'); 
        return; 
      }
      if (Notification.permission === 'granted') { 
        toast('Notifications enabled'); 
        return; 
      }
      const perm = await Notification.requestPermission();
      toast(perm === 'granted' ? 'Notifications enabled' : 'Notifications blocked');
    });

    window.addEventListener('online', () => {
      syncStatus.textContent = 'Online';
      syncStatus.className = 'sync-status online';
      retryPendingChanges();
    });

    window.addEventListener('offline', () => {
      syncStatus.textContent = 'Offline';
      syncStatus.className = 'sync-status offline';
    });

    function setupLogin() {
      const app = document.getElementById('app');
      const loginView = document.getElementById('loginView');
      const form = document.getElementById('loginForm');
      if (localStorage.getItem('mcLoggedIn') === 'true') {
        loginView.classList.add('hidden');
        app.classList.remove('hidden');
        initializeTeacherApp();
      } else {
        loginView.classList.remove('hidden');
        app.classList.add('hidden');
      }
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const pwd = document.getElementById('loginPassword').value;
        if (pwd === 'teacher') {
          localStorage.setItem('mcLoggedIn', 'true');
          loginView.classList.add('hidden');
          app.classList.remove('hidden');
          initializeTeacherApp();
        } else {
          toast('Invalid password');
        }
      });
    }

    setupLogin();
  </script>

  <!-- Non-module scripts (same as before) -->
  <script>
    (function(){
      function setStatus(el, state, label){
        if (!el) return;
        el.classList.remove('online','offline','error');
        el.classList.add(state);
        el.textContent = label;
      }
      function updateNetworkBadge(){
        var el = document.getElementById('syncStatus');
        if (!el) return;
        if (navigator.onLine) {
          setStatus(el, 'online', 'Online');
        } else {
          setStatus(el, 'offline', 'Offline');
        }
      }
      window.addEventListener('online', updateNetworkBadge);
      window.addEventListener('offline', updateNetworkBadge);
      if (document.readyState !== 'loading') updateNetworkBadge();
      else document.addEventListener('DOMContentLoaded', updateNetworkBadge);

      var testBtn = document.getElementById('testSync');
      var urlInput = document.getElementById('syncUrl');
      async function pingSync(){
        var el = document.getElementById('syncStatus');
        try {
          var url = (urlInput && urlInput.value) || urlInput?.getAttribute('value') || '';
          if (!url) { updateNetworkBadge(); return; }
          const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'ping=1', { method: 'GET', cache:'no-store' });
          if (res.ok) setStatus(el, 'online', 'Online');
          else setStatus(el, 'error', 'Sync Error');
        } catch (e) {
          if (!navigator.onLine) setStatus(el, 'offline', 'Offline');
          else setStatus(el, 'error', 'Sync Error');
        }
      }
      if (testBtn) testBtn.addEventListener('click', function(e){ e.preventDefault(); pingSync(); });
      if (navigator.onLine) setTimeout(pingSync, 800);
    })();
  </script>

  <script>
    (function(){
      function getSyncUrl(){
        var el = document.getElementById('syncUrl');
        var url = (el && (el.value || el.getAttribute('value'))) ? (el.value || el.getAttribute('value')) : '';
        url = (url || '').trim();
        if (!url) throw new Error('Missing sync URL. Add your Google Apps Script Web App URL in Settings.');
        if (!/^https:\/\//i.test(url)) throw new Error('Sync URL must start with https://');
        return url;
      }
      window.__getSyncUrl = getSyncUrl;
    })();
  </script>

  <script>
    (function(){
      async function loadFromServer(opts){
        opts = opts || {};
        const maxRetries = 2;
        const backoff = [300, 900];
        const statusEl = document.getElementById('syncStatus');
        function setStatus(cls, label){
          if (!statusEl) return;
          statusEl.classList.remove('online','offline','error');
          statusEl.classList.add(cls);
          statusEl.textContent = label;
        }
        let url;
        try {
          url = (window.__getSyncUrl && window.__getSyncUrl()) || '';
        } catch(e) {
          console.warn(e.message);
          setStatus('error', 'Sync URL missing');
          return { ok:false, error:e.message };
        }

        async function attempt(i){
          try {
            const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'list=1', {
              method: 'GET',
              headers: { 'Accept': 'application/json' },
              cache: 'no-store',
              redirect: 'follow',
            });
            if (!res.ok) throw new Error('Server responded ' + res.status);
            const data = await res.json();
            setStatus('online', 'Online');
            return { ok:true, data };
          } catch (err) {
            if (i < maxRetries) {
              await new Promise(r => setTimeout(r, backoff[i]));
              return attempt(i+1);
            }
            console.error('loadFromServer failed', err);
            if (!navigator.onLine) setStatus('offline', 'Offline');
            else setStatus('error', 'Sync Error');
            return { ok:false, error: String(err && err.message || err) };
          }
        }
        return attempt(0);
      }
      window.loadFromServer = loadFromServer;
    })();
  </script>
</body>
</html>
