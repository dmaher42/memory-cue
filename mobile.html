<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memory Cue (Mobile)</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
  <style>
    :root{
      /* Colors */
      --bg-primary: #0b1220;
      --bg-secondary: #0f172a;
      --bg-tertiary: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --accent-hover: #0ea5e9;
      --success: #22c55e;
      --success-hover: #16a34a;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #334155;
      --border-light: #475569;

      /* Mobile-optimized spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;

      /* Mobile typography */
      --text-xs: 11px;
      --text-sm: 13px;
      --text-base: 15px;
      --text-lg: 17px;
      --text-xl: 19px;
      --text-2xl: 22px;

      /* Mobile-friendly radius */
      --radius-sm: 6px;
      --radius: 8px;
      --radius-md: 12px;
      --radius-lg: 14px;

      /* Touch-friendly sizes */
      --touch-target: 44px;
      --button-height: 42px;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(180deg, var(--bg-primary) 0%, #0a0f1c 100%);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      font-size: var(--text-base);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-tap-highlight-color: transparent;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 0 var(--space-3);
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      background: rgba(11, 18, 32, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      padding: var(--space-3) 0;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    h1 {
      font-size: var(--text-2xl);
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.025em;
      background: linear-gradient(135deg, var(--text-primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-controls {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
      align-items: center;
    }

    /* Form Elements */
    input, select, button, textarea {
      font-family: inherit;
      font-size: var(--text-sm);
      line-height: 1.4;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: all 0.2s ease;
      -webkit-appearance: none;
      appearance: none;
    }

    input, select, textarea {
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: var(--space-3);
      min-height: var(--button-height);
      box-shadow: var(--shadow-sm);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.1);
    }

    input::placeholder, textarea::placeholder {
      color: var(--text-muted);
    }

    .search-input {
      flex: 1;
      min-width: 140px;
    }

    /* Buttons */
    button {
      cursor: pointer;
      font-weight: 500;
      padding: var(--space-3);
      min-height: var(--touch-target);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-1);
      white-space: nowrap;
      border: 1px solid transparent;
      transition: all 0.2s ease;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    button:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
      font-weight: 600;
    }

    .btn-primary:hover, .btn-primary:focus {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    .btn-success {
      background: var(--success);
      color: var(--bg-primary);
      border-color: var(--success);
      font-weight: 600;
    }

    .btn-success:hover, .btn-success:focus {
      background: var(--success-hover);
      border-color: var(--success-hover);
    }

    .btn-ghost {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border-color: var(--border);
    }

    .btn-ghost:hover, .btn-ghost:focus {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-color: var(--border-light);
    }

    .btn-compact {
      padding: var(--space-2) var(--space-3);
      min-height: 36px;
      font-size: var(--text-xs);
    }

    /* Layout */
    .main-content {
      padding: var(--space-4) 0;
    }

    .section {
      margin-bottom: var(--space-6);
    }

    /* Cards/Panels */
    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      padding: var(--space-4);
      border-bottom: 1px solid var(--border);
      background: var(--bg-tertiary);
    }

    .card-content {
      padding: var(--space-4);
    }

    .card-title {
      font-size: var(--text-lg);
      font-weight: 600;
      margin: 0;
      color: var(--text-primary);
    }

    .section-subtitle {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: var(--space-4) 0 var(--space-3) 0;
    }

    /* Form Layout */
    .form-stack {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .form-row {
      display: flex;
      gap: var(--space-2);
      align-items: flex-end;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .form-group.flex-1 {
      flex: 1;
    }

    .form-actions {
      display: flex;
      gap: var(--space-2);
      flex-wrap: wrap;
      padding-top: var(--space-4);
      border-top: 1px solid var(--border);
    }

    .form-actions button {
      flex: 1;
      min-width: 80px;
    }

    /* Filter Controls */
    .filter-controls {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }

    .filter-buttons {
      display: flex;
      gap: var(--space-1);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: var(--space-1);
    }

    .filter-buttons button {
      flex-shrink: 0;
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-sm);
      min-height: 36px;
    }

    .filter-buttons button.active {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }

    .sort-control {
      align-self: flex-start;
    }

    /* Task List */
    .task-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .task-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: var(--space-3);
      align-items: flex-start;
      padding: var(--space-4);
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      transition: all 0.2s ease;
    }

    .task-item:active {
      transform: scale(0.99);
    }

    .task-item.completed .task-title {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .task-content {
      min-width: 0;
      padding-top: 2px; /* Align with checkbox */
    }

    .task-title {
      font-size: var(--text-base);
      font-weight: 500;
      margin: 0 0 var(--space-1) 0;
      color: var(--text-primary);
      line-height: 1.3;
      word-wrap: break-word;
    }

    .task-meta {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    .task-meta-row {
      display: flex;
      gap: var(--space-2);
      align-items: center;
      flex-wrap: wrap;
    }

    .priority-badge {
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: 500;
      border: 1px solid transparent;
      flex-shrink: 0;
    }

    .priority-high {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
      border-color: rgba(239, 68, 68, 0.2);
    }

    .priority-medium {
      background: rgba(245, 158, 11, 0.1);
      color: #fcd34d;
      border-color: rgba(245, 158, 11, 0.2);
    }

    .priority-low {
      background: rgba(34, 197, 94, 0.1);
      color: #86efac;
      border-color: rgba(34, 197, 94, 0.2);
    }

    .task-actions {
      padding-top: 2px; /* Align with checkbox */
    }

    .task-actions button {
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
      min-height: 32px;
      min-width: auto;
    }

    /* Checkbox */
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      margin-top: 2px;
    }

    /* Status Elements */
    .sync-status {
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: 600;
      border: 1px solid transparent;
    }

    .sync-status.online {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
      border-color: rgba(34, 197, 94, 0.2);
    }

    .sync-status.offline {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
      border-color: rgba(245, 158, 11, 0.2);
    }

    .sync-status.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border-color: rgba(239, 68, 68, 0.2);
    }

    .google-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: var(--space-1);
    }

    .auth-info {
      font-size: var(--text-xs);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .status-message {
      font-size: var(--text-xs);
      color: var(--text-muted);
      margin-top: var(--space-2);
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: var(--space-6) 0;
      color: var(--text-muted);
      font-size: var(--text-xs);
      border-top: 1px solid var(--border);
      margin-top: var(--space-8);
    }

    /* Utility Classes */
    .hidden { 
      display: none; 
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .text-muted {
      color: var(--text-muted);
    }

    /* Mobile-specific optimizations */
    @media (max-width: 400px) {
      .container {
        padding: 0 var(--space-2);
      }
      
      .header-controls {
        gap: var(--space-1);
      }
      
      .task-item {
        padding: var(--space-3);
        gap: var(--space-2);
      }
      
      .btn-compact {
        padding: var(--space-1);
        min-width: 60px;
      }
    }

    /* Landscape orientation adjustments */
    @media (orientation: landscape) and (max-height: 500px) {
      .header-content {
        padding: var(--space-2) 0;
      }
      
      .main-content {
        padding: var(--space-3) 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="header-top">
          <h1>Memory Cue</h1>
          <div id="syncStatus" class="sync-status offline">Offline</div>
        </div>
        <div class="header-controls">
          <input id="q" class="search-input" placeholder="Search reminders or #tags" />
          <button id="voiceBtn" class="btn-ghost btn-compact" type="button" title="Voice quick add">
            üéôÔ∏è
          </button>
          <button id="notifBtn" class="btn-ghost btn-compact" type="button" title="Enable notifications">
            üîî
          </button>
          <button id="addQuickBtn" class="btn-primary btn-compact" type="button" title="Add quick reminder">
            +
          </button>
        </div>
        <!-- Auth controls -->
        <div class="header-controls" style="margin-top: var(--space-2);">
          <button id="googleSignInBtn" class="btn-ghost" type="button">
            Sign in with Google
          </button>
          <button id="googleSignOutBtn" class="btn-ghost hidden" type="button">
            <img id="googleAvatar" class="google-avatar hidden" />
            Sign out
          </button>
          <div id="googleUserName" class="auth-info"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="container">
      <!-- Create Reminder Card -->
      <section class="card section">
        <div class="card-header">
          <h2 class="card-title">Create Reminder</h2>
        </div>
        <div class="card-content">
          <div class="form-stack">
            <div class="form-group">
              <label class="sr-only" for="title">Reminder</label>
              <input id="title" placeholder="e.g., Pick up dog at 6pm #home" />
            </div>
            
            <div class="form-row">
              <div class="form-group flex-1">
                <label class="sr-only" for="date">Date</label>
                <input id="date" type="date" />
              </div>
              <div class="form-group flex-1">
                <label class="sr-only" for="time">Time</label>
                <input id="time" type="time" />
              </div>
              <div class="form-group">
                <select id="priority">
                  <option>High</option>
                  <option selected>Medium</option>
                  <option>Low</option>
                </select>
              </div>
            </div>
            
            <button id="saveBtn" class="btn-success" type="button">Save Reminder</button>
          </div>
          
          <div class="form-actions">
            <button id="copyMtlBtn" class="btn-ghost" type="button">Copy MTL</button>
            <label class="btn-ghost" style="cursor: pointer;">
              Import
              <input id="importFile" type="file" accept="application/json" class="sr-only" />
            </label>
            <button id="exportBtn" class="btn-ghost" type="button">Export</button>
            <button id="openSettings" class="btn-ghost" type="button">‚öôÔ∏è</button>
          </div>
          <div id="status" class="status-message"></div>
        </div>
      </section>

      <!-- Reminders List Card -->
      <section class="card section">
        <div class="card-header">
          <div class="filter-controls">
            <div class="filter-buttons">
              <button class="btn-ghost active" data-filter="today" type="button">Today</button>
              <button class="btn-ghost" data-filter="overdue" type="button">Overdue</button>
              <button class="btn-ghost" data-filter="all" type="button">All</button>
              <button class="btn-ghost" data-filter="done" type="button">Done</button>
            </div>
            <div class="sort-control">
              <select id="sort">
                <option value="smart">Smart sort</option>
                <option value="time">Time</option>
                <option value="priority">Priority</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card-content">
          <h3 class="section-subtitle">Reminders</h3>
          <div id="list" class="task-list" aria-live="polite">
            <div class="text-muted">Loading...</div>
          </div>
        </div>
      </section>

      <!-- Settings Card (hidden by default) -->
      <section class="card section hidden" id="settingsSection">
        <div class="card-header">
          <h2 class="card-title">Calendar Sync Settings</h2>
        </div>
        <div class="card-content">
          <div class="form-stack">
            <div class="form-group">
              <input id="syncUrl" placeholder="https://script.google.com/macros/s/AKfycb.../exec" />
            </div>
            <div class="form-row">
              <button id="saveSettings" class="btn-success flex-1" type="button">Save</button>
              <button id="testSync" class="btn-ghost flex-1" type="button">Test</button>
            </div>
          </div>
          <div class="text-muted" style="margin-top: var(--space-3); font-size: var(--text-xs);">
            <strong>Tip:</strong> In Google Apps Script, click <strong>Deploy ‚Üí New deployment ‚Üí Web app</strong>,
            set <strong>Execute as: Me</strong>, <strong>Who has access: Anyone with the link</strong>, then copy the URL.
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      Mobile optimized. Voice works best in Chrome. Multi-device sync via Firebase + Calendar sync via Google Apps Script.
    </div>
  </footer>

  <!-- Firebase SDK and JavaScript -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
    import { GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAmAMiz0zG3dAhZJhOy1DYj8fKVDObL36c",
      authDomain: "memory-cue-app.firebaseapp.com",
      projectId: "memory-cue-app",
      storageBucket: "memory-cue-app.firebasestorage.app",
      messagingSenderId: "751284466633",
      appId: "1:751284466633:web:3b10742970bef1a5d5ee18",
      measurementId: "G-R0V4M7VCE6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let items = [];
    let filter = 'today';
    let sortKey = 'smart';
    let listening = false;
    let recog = null;
    let userId = null;
    let unsubscribe = null;
    let currentUser = null;

    const TZ = 'Australia/Adelaide';
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // DOM elements
    const q = $('#q');
    const title = $('#title');
    const date = $('#date');
    const time = $('#time');
    const priority = $('#priority');
    const saveBtn = $('#saveBtn');
    const list = $('#list');
    const statusEl = $('#status');
    const voiceBtn = $('#voiceBtn');
    const notifBtn = $('#notifBtn');
    const addQuickBtn = $('#addQuickBtn');
    const copyMtlBtn = $('#copyMtlBtn');
    const importFile = $('#importFile');
    const exportBtn = $('#exportBtn');
    const sortSel = $('#sort');
    const syncStatus = $('#syncStatus');
    const googleSignInBtn = $('#googleSignInBtn');
    const googleSignOutBtn = $('#googleSignOutBtn');
    const googleAvatar = $('#googleAvatar');
    const googleUserName = $('#googleUserName');
    const openSettings = $('#openSettings');
    const settingsSection = $('#settingsSection');
    const syncUrlInput = $('#syncUrl');
    const saveSettings = $('#saveSettings');
    const testSync = $('#testSync');

    // Restore saved Sync URL
    const savedSyncUrl = localStorage.getItem('syncUrl') || '';
    if (savedSyncUrl) syncUrlInput.value = savedSyncUrl;

    // Google Auth
    googleSignInBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        toast('Google sign-in failed');
        console.error(error);
      }
    });

    googleSignOutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        toast('Signed out');
        items = [];
        render();
      } catch (error) {
        toast('Sign-out failed');
        console.error(error);
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        currentUser = user;
        syncStatus.textContent = 'Online';
        syncStatus.className = 'sync-status online';
        googleSignInBtn.classList.add('hidden');
        googleSignOutBtn.classList.remove('hidden');
        if (user.photoURL) {
          googleAvatar.classList.remove('hidden');
          googleAvatar.src = user.photoURL;
        } else {
          googleAvatar.classList.add('hidden');
          googleAvatar.src = '';
        }
        if (user.displayName) {
          googleUserName.textContent = `Hello, ${user.displayName}`;
        } else if (user.email) {
          googleUserName.textContent = user.email;
        } else {
          googleUserName.textContent = '';
        }
        setupFirestoreSync();
      } else {
        googleSignInBtn.classList.remove('hidden');
        googleSignOutBtn.classList.add('hidden');
        googleAvatar.classList.add('hidden');
        googleAvatar.src = '';
        googleUserName.textContent = '';
        items = [];
        render();
      }
    });

    function setupFirestoreSync() {
      if (!userId) {
        items = [];
        render();
        return;
      }
      if (unsubscribe) unsubscribe();
      const userCollection = collection(db, 'users', userId, 'reminders');
      const qSnap = query(userCollection, orderBy('updatedAt', 'desc'));

      unsubscribe = onSnapshot(qSnap, (snapshot) => {
        const remoteItems = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          remoteItems.push({
            id: doc.id,
            title: data.title,
            priority: data.priority,
            notes: data.notes || '',
            done: data.done,
            due: data.due,
            createdAt: data.createdAt,
            updatedAt: data.updatedAt
          });
        });

        items = mergeWithLocal(remoteItems);
        render();
      }, (error) => {
        console.error('Firestore sync error:', error);
        syncStatus.textContent = 'Sync Error';
        syncStatus.className = 'sync-status error';
      });
    }

    function mergeWithLocal(remoteItems) {
      const localPending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const merged = new Map();

      remoteItems.forEach(item => merged.set(item.id, item));
      localPending.forEach(change => {
        if (change.action === 'upsert') {
          merged.set(change.item.id, change.item);
        } else if (change.action === 'delete') {
          merged.delete(change.itemId);
        }
      });

      return Array.from(merged.values());
    }

    async function saveToFirebase(item) {
      if (!userId) return;
      try {
        await setDoc(doc(db, 'users', userId, 'reminders', item.id), {
          title: item.title,
          priority: item.priority,
          notes: item.notes,
          done: item.done,
          due: item.due,
          createdAt: item.createdAt,
          updatedAt: item.updatedAt
        });
        removePendingChange(item.id);
      } catch (error) {
        console.error('Save failed:', error);
        addPendingChange({ action: 'upsert', item });
        syncStatus.textContent = 'Sync Pending';
        syncStatus.className = 'sync-status offline';
      }
    }

    async function deleteFromFirebase(id) {
      if (!userId) return;
      try {
        await deleteDoc(doc(db, 'users', userId, 'reminders', id));
        removePendingChange(id);
      } catch (error) {
        console.error('Delete failed:', error);
        addPendingChange({ action: 'delete', itemId: id });
      }
    }

    function addPendingChange(change) {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const filtered = pending.filter(p => 
        (p.action === 'upsert' && p.item.id !== (change.item?.id || change.itemId)) ||
        (p.action === 'delete' && p.itemId !== (change.item?.id || change.itemId))
      );
      filtered.push(change);
      localStorage.setItem('pendingChanges', JSON.stringify(filtered));
    }

    function removePendingChange(itemId) {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const filtered = pending.filter(p => 
        (p.action === 'upsert' && p.item.id !== itemId) ||
        (p.action === 'delete' && p.itemId !== itemId)
      );
      localStorage.setItem('pendingChanges', JSON.stringify(filtered));
    }

    async function retryPendingChanges() {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      for (const change of pending) {
        try {
          if (change.action === 'upsert') {
            await saveToFirebase(change.item);
          } else if (change.action === 'delete') {
            await deleteFromFirebase(change.itemId);
          }
        } catch (error) {
          break;
        }
      }
    }

    async function tryCalendarSync(task) {
      const url = (localStorage.getItem('syncUrl') || '').trim();
      if (!url) return;
      const payload = { 
        title: task.title, 
        dueIso: task.due || null, 
        priority: task.priority || 'Medium' 
      };
      try {
        await fetch(url, { 
          method: 'POST', 
          headers: { 'Content-Type': 'text/plain' }, 
          body: JSON.stringify(payload) 
        });
        toast('Synced to Calendar');
      } catch (e) { 
        toast('Calendar sync failed (offline?)'); 
      }
    }

    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function toISODatePart(d) { return d.toISOString().slice(0, 10); }
    function todayISO() {
      const now = new Date();
      const adelaideDate = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
      return toISODatePart(adelaideDate);
    }
    function priorityWeight(p) { return p === 'High' ? 3 : p === 'Medium' ? 2 : 1; }
    function smartCompare(a, b) {
      const pr = priorityWeight(b.priority) - priorityWeight(a.priority); if (pr) return pr;
      const at = +new Date(a.due || 0), bt = +new Date(b.due || 0); if (at !== bt) return at - bt;
      return (a.updatedAt || 0) > (b.updatedAt || 0) ? -1 : 1;
    }
    function fmtDayDate(iso) {
      if (!iso) return '‚Äî';
      try {
        const d = new Date(iso + 'T00:00:00');
        return new Intl.DateTimeFormat('en-AU', { timeZone: TZ, weekday: 'long', day: 'numeric', month: 'long' }).format(d);
      } catch { return iso; }
    }
    function parseQuickWhen(text) {
      text = text.toLowerCase();
      let when = { date: todayISO(), time: '' };
      if (/tomorrow/.test(text)) {
        const d = new Date(); d.setDate(d.getDate() + 1); when.date = toISODatePart(d);
      }
      const mHm = text.match(/\b(\d{1,2}):(\d{2})\b/);
      const m12 = text.match(/\b(\d{1,2})\s*(am|pm)\b/);
      if (mHm) { when.time = `${String(mHm[1]).padStart(2, '0')}:${mHm[2]}`; }
      else if (m12) {
        let h = parseInt(m12[1], 10) % 12; if (m12[2] === 'pm') h += 12; when.time = `${String(h).padStart(2, '0')}:00`;
      }
      return when;
    }

    function addItem(obj) {
      if (!userId) { toast('Sign in to add reminders'); return; }
      const item = {
        id: uid(),
        title: obj.title.trim(),
        priority: obj.priority || 'Medium',
        notes: obj.notes || '',
        done: false,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        due: obj.due || null
      };

      items = [item, ...items];
      render();

      saveToFirebase(item);
      tryCalendarSync(item);
      return item;
    }

    function toggleDone(id) {
      const item = items.find(x => x.id === id);
      if (item) {
        item.done = !item.done;
        item.updatedAt = Date.now();
        render();
        saveToFirebase(item);
      }
    }

    function removeItem(id) {
      items = items.filter(x => x.id !== id);
      render();
      deleteFromFirebase(id);
    }

    function render() {
      const query = q.value.trim().toLowerCase();
      const now = new Date();
      const adelaideNow = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
      const todayStart = new Date(adelaideNow);
      todayStart.setHours(0, 0, 0, 0);
      const todayEnd = new Date(adelaideNow);
      todayEnd.setHours(23, 59, 59, 999);

      let rows = items.slice();
      if (query) {
        rows = rows.filter(r =>
          r.title.toLowerCase().includes(query) || (r.notes || '').toLowerCase().includes(query)
        );
      }

      rows = rows.filter(r => {
        if (filter === 'done') return r.done;
        if (filter === 'overdue') return !r.done && r.due && new Date(r.due) < adelaideNow;
        if (filter === 'today') {
          if (!r.due) return true;
          const dueDate = new Date(r.due);
          const dueDateAdelaide = new Date(dueDate.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
          return dueDateAdelaide >= todayStart && dueDateAdelaide <= todayEnd;
        }
        return true;
      });

      rows.sort((a, b) => {
        if (sortKey === 'time') return (+new Date(a.due || 0)) - (+new Date(b.due || 0));
        if (sortKey === 'priority') return priorityWeight(b.priority) - priorityWeight(a.priority);
        return smartCompare(a, b);
      });

      // Update filter button states
      $$('[data-filter]').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
      });

      list.innerHTML = '';
      if (rows.length === 0) {
        list.innerHTML = '<div class="text-muted">No reminders found.</div>';
        return;
      }

      rows.forEach(r => {
        const div = document.createElement('div');
        div.className = 'task-item' + (r.done ? ' completed' : '');
        
        const dueTxt = r.due
          ? new Date(r.due).toLocaleString('en-AU', { timeZone: TZ, hour: '2-digit', minute: '2-digit' }) +
            ' ‚Ä¢ ' + fmtDayDate(r.due.slice(0, 10))
          : 'No due date';

        const priorityClass = `priority-${r.priority.toLowerCase()}`;
        
        div.innerHTML = `
          <input type="checkbox" ${r.done ? 'checked' : ''} aria-label="Mark complete" />
          <div class="task-content">
            <div class="task-title">${escapeHtml(r.title)}</div>
            <div class="task-meta">
              <div class="task-meta-row">
                <span>${dueTxt}</span>
                <span class="priority-badge ${priorityClass}">${r.priority}</span>
              </div>
              ${r.notes ? `<div class="task-meta-row"><span>${escapeHtml(r.notes)}</span></div>` : ''}
            </div>
          </div>
          <div class="task-actions">
            <button class="btn-ghost" data-del type="button">Del</button>
          </div>`;
        
        div.querySelector('input').addEventListener('change', () => toggleDone(r.id));
        div.querySelector('[data-del]').addEventListener('click', () => removeItem(r.id));
        list.appendChild(div);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) =>
        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
      );
    }

    function toast(msg) {
      statusEl.textContent = msg; 
      clearTimeout(toast._t);
      toast._t = setTimeout(() => statusEl.textContent = '', 3000);
    }

    // Event Listeners
    saveBtn.addEventListener('click', () => {
      const t = title.value.trim(); 
      if (!t) { 
        toast('Add a reminder title'); 
        return; 
      }
      let due = null;
      if (date.value || time.value) {
        const d = (date.value || todayISO());
        const tm = (time.value || '09:00');
        due = new Date(`${d}T${tm}:00`).toISOString();
      } else {
        const p = parseQuickWhen(t);
        if (p.time) { 
          due = new Date(`${p.date}T${p.time}:00`).toISOString(); 
        }
      }
      addItem({ title: t, priority: priority.value, due });
      title.value = ''; 
      time.value = '';
    });

    addQuickBtn.addEventListener('click', () => {
      if (!title.value.trim()) {
        title.focus(); 
        toast('Type something like "pick up dog at 6pm"'); 
        return;
      }
      saveBtn.click();
    });

    q.addEventListener('input', render);
    sortSel.addEventListener('change', () => { 
      sortKey = sortSel.value; 
      render(); 
    });
    
    $$('button[data-filter]').forEach(b => b.addEventListener('click', () => {
      filter = b.getAttribute('data-filter'); 
      render();
    }));

    copyMtlBtn.addEventListener('click', () => {
      const lines = items.filter(x => !x.done).map(x => {
        const datePart = x.due ? fmtDayDate(x.due.slice(0, 10)) : '';
        const timePart = x.due ? new Date(x.due).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' }) : '';
        const pieces = [
          'mtl ' + x.title,
          x.due ? `Due Date: ${datePart}` : '',
          x.due ? `Time: ${timePart}` : '',
          `Status: Not started`,
        ].filter(Boolean);
        return pieces.join('\n');
      });
      if (lines.length === 0) { 
        toast('No active tasks to copy'); 
        return; 
      }
      navigator.clipboard.writeText(lines.join('\n\n')).then(() => {
        toast('Copied for Master Task List');
      }).catch(() => toast('Copy failed'));
    });

    importFile.addEventListener('change', () => {
      const f = importFile.files[0]; 
      if (!f) return;
      const rd = new FileReader();
      rd.onload = () => {
        try { 
          const importedItems = JSON.parse(String(rd.result) || '[]'); 
          importedItems.forEach(item => {
            item.id = uid();
            items = [item, ...items];
            saveToFirebase(item);
          });
          render();
          toast('Import successful');
        }
        catch (err) { 
          toast('Invalid JSON'); 
        }
      };
      rd.readAsText(f);
      importFile.value = '';
    });

    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'memory-cue-mobile.json'; 
      a.click();
      URL.revokeObjectURL(url);
    });

    openSettings.addEventListener('click', () => {
      if (settingsSection) {
        settingsSection.classList.remove('hidden');
        settingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });

    saveSettings.addEventListener('click', () => {
      const url = syncUrlInput.value.trim();
      localStorage.setItem('syncUrl', url);
      toast('Calendar sync settings saved');
    });

    testSync.addEventListener('click', async () => {
      const url = syncUrlInput.value.trim();
      if (!url) { 
        toast('Enter Google Apps Script URL first'); 
        return; 
      }
      try {
        const r = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ title: 'Test from Memory Cue Mobile', dueIso: null, priority: 'Low' })
        });
        toast(r.ok ? 'Calendar test sent successfully' : 'Calendar sync error');
      } catch (e) { 
        toast('Calendar sync failed (check URL & deploy)'); 
      }
    });

    // Voice recognition
    try {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SR) {
        recog = new SR();
        recog.lang = 'en-AU';
        recog.interimResults = false;
        recog.onresult = (e) => {
          const t = e.results[0][0].transcript || '';
          title.value = t;
          toast('Heard: ' + t);
        };
        recog.onend = () => { 
          listening = false; 
          voiceBtn.textContent = 'üéôÔ∏è'; 
        };
      }
    } catch { }

    voiceBtn.addEventListener('click', () => {
      if (!recog) return;
      if (!listening) { 
        try { 
          recog.start(); 
          listening = true; 
          voiceBtn.textContent = 'üëÇ'; 
        } catch { } 
      } else { 
        try { 
          recog.stop(); 
        } catch { } 
        listening = false; 
        voiceBtn.textContent = 'üéôÔ∏è'; 
      }
    });

    notifBtn.addEventListener('click', async () => {
      if (!('Notification' in window)) { 
        toast('Notifications not supported'); 
        return; 
      }
      if (Notification.permission === 'granted') { 
        toast('Notifications enabled'); 
        return; 
      }
      const perm = await Notification.requestPermission();
      toast(perm === 'granted' ? 'Notifications enabled' : 'Notifications blocked');
    });

    window.addEventListener('online', () => {
      syncStatus.textContent = 'Online';
      syncStatus.className = 'sync-status online';
      retryPendingChanges();
    });

    window.addEventListener('offline', () => {
      syncStatus.textContent = 'Offline';
      syncStatus.className = 'sync-status offline';
    });

    render();
  </script>
</body>
</html>
