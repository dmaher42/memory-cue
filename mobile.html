<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Memory Cue Mobile</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root {
      --bg: #0b1220; --panel: #0f172a; --muted: #94a3b8; --text: #e5e7eb;
      --accent: #38bdf8; --ok: #22c55e; --warn: #f59e0b; --danger: #ef4444;
    }
    html,body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, "Noto Sans";
      touch-action: manipulation;
    }
    .wrap { max-width: 420px; margin: 0 auto; padding: 0 3vw; }
    header { position: sticky; top: 0; background: rgba(10,15,28,.9); backdrop-filter: blur(6px); z-index: 10; }
    h1 { font-size: 18px; margin: 0; padding: 10px 0 2px 0; font-weight: 700; text-align: center;}
    .row { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    input,select,button,textarea {
      color: var(--text); background: var(--panel); border: 1px solid #22304a; border-radius: 8px; padding: 10px; font-size: 16px; outline: none;
    }
    input,select,textarea { width: 100%; }
    input::placeholder,textarea::placeholder { color: #64748b; }
    button { cursor: pointer; }
    button.primary { background: var(--accent); border-color: #1e7aa2; color: #001018; font-weight: 700; }
    button.good { background: var(--ok); color: #001108; font-weight: 700; }
    button.ghost { background: var(--panel); border-color: #22304a; }
    .icon-btn { background: none; border: none; font-size: 24px; padding: 8px; color: var(--accent); cursor: pointer;}
    .panel { background: var(--panel); border-radius: 12px; padding: 12px; margin-bottom: 12px;}
    .list { display: grid; gap: 9px; }
    .item { display: grid; grid-template-columns: auto 1fr auto; gap: 6px; align-items: center; padding: 10px; border-radius: 10px; background: #101a2d;}
    .item.done .title { text-decoration: line-through; color: #93a3b8; }
    .title { font-weight: 600; font-size: 15px; }
    .meta { font-size: 13px; color: var(--muted);}
    .badge { font-size: 12px; padding: 4px 9px; border-radius: 999px; border: 1px solid #2b3b58; background: #0f1a32; }
    .footer { color: #8aa0b8; font-size: 12px; text-align: center; margin: 16px 0;}
    .sync-status { padding: 4px 12px; border-radius: 7px; font-size: 13px; font-weight: 600; margin: 0 auto;}
    .sync-status.online { background: var(--ok); color: #001108; }
    .sync-status.offline { background: var(--warn); color: #1b1200;}
    .sync-status.error { background: var(--danger); color: #fff; }
    @media (max-width: 500px) {
      .wrap { max-width: 100vw; padding: 0 1vw;}
      .panel { padding: 8px; border-radius: 8px;}
      .item { padding: 7px; border-radius: 8px;}
      .title { font-size: 14px;}
      .meta, .badge { font-size: 11px;}
      .sync-status { font-size: 11px; }
    }
    .hidden { display: none; }
    .sr-only { position: absolute; height: 1px; width: 1px; clip: rect(1px,1px,1px,1px); overflow: hidden; white-space: nowrap; }
    /* Floating add button */
    #fab { position: fixed; bottom: 24px; right: 24px; z-index: 99; background: var(--accent); color: #001018; border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; font-size: 32px; box-shadow: 0 2px 8px #22304a40; border: none; cursor: pointer;}
    #fab:active { background: #2b9ad3;}
  </style>
</head>
<body>
  <header>
    <h1>Memory Cue</h1>
    <div id="syncStatus" class="sync-status offline">Offline</div>
    <div class="row" style="margin-top:4px;">
      <input id="q" placeholder="Search reminders or #tags" />
      <button id="voiceBtn" class="icon-btn" type="button" title="Voice add">üéôÔ∏è</button>
      <button id="notifBtn" class="icon-btn" type="button" title="Enable notifications">üîî</button>
    </div>
  </header>

  <main class="wrap">
    <section class="panel" id="quickAddSection">
      <form id="quickAddForm" class="row" style="flex-direction:column;gap:8px;">
        <input id="title" placeholder="e.g., Pick up dog at 6pm #home" autocomplete="off" />
        <div class="row" style="gap:6px;">
          <input id="date" type="date" style="flex:1;" />
          <input id="time" type="time" style="flex:1;" />
          <select id="priority" style="flex:1;">
            <option>High</option>
            <option selected>Medium</option>
            <option>Low</option>
          </select>
        </div>
        <button id="saveBtn" class="good" type="submit" style="width:100%;">Save</button>
        <span id="status" class="meta"></span>
      </form>
    </section>

    <section class="panel">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <button class="icon-btn" data-filter="today" type="button" title="Today">üìÖ</button>
          <button class="icon-btn" data-filter="overdue" type="button" title="Overdue">‚è∞</button>
          <button class="icon-btn" data-filter="all" type="button" title="All">üóÇ</button>
          <button class="icon-btn" data-filter="done" type="button" title="Done">‚úÖ</button>
        </div>
        <select id="sort" style="width:90px;">
          <option value="smart">Sort</option>
          <option value="time">Time</option>
          <option value="priority">Priority</option>
        </select>
      </div>
      <div id="list" class="list" aria-live="polite" style="margin-top:8px;">
        <div class="meta">Loading...</div>
      </div>
    </section>
  </main>

  <!-- Floating action button for quick add -->
  <button id="fab" title="Add Reminder">Ôºã</button>

  <div class="footer">
    Multi-device sync via Firebase. Voice works best in Chrome. <br>
    <span style="font-size:11px;">Adelaide time. PWA installable.</span>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAmAMiz0zG3dAhZJhOy1DYj8fKVDObL36c",
      authDomain: "memory-cue-app.firebaseapp.com",
      projectId: "memory-cue-app",
      storageBucket: "memory-cue-app.appspot.com",
      messagingSenderId: "751284466633",
      appId: "1:751284466633:web:3b10742970bef1a5d5ee18",
      measurementId: "G-R0V4M7VCE6"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let items = [], filter = 'today', sortKey = 'smart', userId = null, unsubscribe = null;
    const TZ = 'Australia/Adelaide';
    const $ = (sel) => document.querySelector(sel);

    // DOM
    const q = $('#q'), title = $('#title'), date = $('#date'), time = $('#time');
    const priority = $('#priority'), saveBtn = $('#saveBtn'), list = $('#list');
    const statusEl = $('#status'), voiceBtn = $('#voiceBtn'), notifBtn = $('#notifBtn');
    const sortSel = $('#sort'), syncStatus = $('#syncStatus'), fab = $('#fab');
    const quickAddSection = $('#quickAddSection'), quickAddForm = $('#quickAddForm');

    // Auth + sync
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        syncStatus.textContent = 'Online';
        syncStatus.className = 'sync-status online';
        setupFirestoreSync();
      } else {
        signInAnonymously(auth).catch(console.error);
      }
    });

    function setupFirestoreSync() {
      if (!userId) return;
      const userCollection = collection(db, 'users', userId, 'reminders');
      const qSnap = query(userCollection, orderBy('updatedAt', 'desc'));
      if (unsubscribe) unsubscribe();
      unsubscribe = onSnapshot(qSnap, (snapshot) => {
        items = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          items.push({
            id: doc.id, title: data.title, priority: data.priority,
            notes: data.notes || '', done: data.done,
            due: data.due, createdAt: data.createdAt, updatedAt: data.updatedAt
          });
        });
        render();
      }, (error) => {
        syncStatus.textContent = 'Sync Error';
        syncStatus.className = 'sync-status error';
      });
    }

    // CRUD
    async function saveToFirebase(item) {
      if (!userId) return;
      try {
        await setDoc(doc(db, 'users', userId, 'reminders', item.id), {
          title: item.title, priority: item.priority, notes: item.notes,
          done: item.done, due: item.due, createdAt: item.createdAt, updatedAt: item.updatedAt
        });
      } catch (error) {
        toast('Save failed (offline?)');
      }
    }
    async function deleteFromFirebase(id) {
      if (!userId) return;
      try { await deleteDoc(doc(db, 'users', userId, 'reminders', id)); }
      catch (error) { toast('Delete failed'); }
    }
    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function todayISO() {
      const now = new Date();
      const adelaideDate = new Date(now.toLocaleString("en-US", {timeZone: TZ}));
      return adelaideDate.toISOString().slice(0, 10);
    }
    function priorityWeight(p) { return p === 'High' ? 3 : p === 'Medium' ? 2 : 1; }
    function smartCompare(a, b) {
      const pr = priorityWeight(b.priority) - priorityWeight(a.priority); if (pr) return pr;
      const at = +new Date(a.due || 0), bt = +new Date(b.due || 0); if (at !== bt) return at - bt;
      return (a.updatedAt || 0) > (b.updatedAt || 0) ? -1 : 1;
    }
    function fmtDayDate(iso) {
      if (!iso) return '‚Äî';
      try {
        const d = new Date(iso + 'T00:00:00');
        return new Intl.DateTimeFormat('en-AU', { timeZone: TZ, weekday: 'short', day: 'numeric', month: 'short' }).format(d);
      } catch { return iso; }
    }

    function addItem(obj) {
      const item = {
        id: uid(),
        title: obj.title.trim(),
        priority: obj.priority || 'Medium',
        notes: obj.notes || '',
        done: false,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        due: obj.due || null
      };
      items = [item, ...items];
      render();
      saveToFirebase(item);
      return item;
    }

    function toggleDone(id) {
      const item = items.find(x => x.id === id);
      if (item) {
        item.done = !item.done;
        item.updatedAt = Date.now();
        render();
        saveToFirebase(item);
      }
    }

    function removeItem(id) {
      items = items.filter(x => x.id !== id);
      render();
      deleteFromFirebase(id);
    }

    // Render
    function render() {
      const query = q.value.trim().toLowerCase();
      const now = new Date();
      const adelaideNow = new Date(now.toLocaleString("en-US", {timeZone: TZ}));
      const todayStart = new Date(adelaideNow); todayStart.setHours(0,0,0,0);
      const todayEnd = new Date(adelaideNow); todayEnd.setHours(23,59,59,999);

      let rows = items.slice();
      if (query) {
        rows = rows.filter(r =>
          r.title.toLowerCase().includes(query) || (r.notes || '').toLowerCase().includes(query)
        );
      }
      rows = rows.filter(r => {
        if (filter === 'done') return r.done;
        if (filter === 'overdue') return !r.done && r.due && new Date(r.due) < adelaideNow;
        if (filter === 'today') {
          if (!r.due) return true;
          const dueDate = new Date(r.due);
          const dueDateAdelaide = new Date(dueDate.toLocaleString("en-US", {timeZone: TZ}));
          return dueDateAdelaide >= todayStart && dueDateAdelaide <= todayEnd;
        }
        return true;
      });
      rows.sort((a, b) => {
        if (sortKey === 'time') return (+new Date(a.due || 0)) - (+new Date(b.due || 0));
        if (sortKey === 'priority') return priorityWeight(b.priority) - priorityWeight(a.priority);
        return smartCompare(a, b);
      });

      list.innerHTML = '';
      if (rows.length === 0) {
        list.innerHTML = '<div class="meta">Nothing here yet.</div>';
        return;
      }
      rows.forEach(r => {
        const div = document.createElement('div');
        div.className = 'item' + (r.done ? ' done' : '');
        const dueTxt = r.due ? new Date(r.due).toLocaleString('en-AU', { timeZone: TZ, hour: '2-digit', minute: '2-digit' }) + ' ‚Ä¢ ' + fmtDayDate(r.due.slice(0, 10)) : '‚Äî';
        div.innerHTML = `
          <input type="checkbox" ${r.done ? 'checked' : ''} aria-label="Mark done" />
          <div>
            <div class="title">${escapeHtml(r.title)}</div>
            <div class="meta">${dueTxt} ‚Ä¢ <span class="badge">${r.priority}</span> ${r.notes ? '‚Ä¢ ' + escapeHtml(r.notes) : ''}</div>
          </div>
          <button class="icon-btn" data-del title="Delete">üóëÔ∏è</button>`;
        div.querySelector('input').addEventListener('change', () => toggleDone(r.id));
        div.querySelector('[data-del]').addEventListener('click', () => removeItem(r.id));
        list.appendChild(div);
      });
    }
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) =>
        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
      );
    }
    function toast(msg) {
      statusEl.textContent = msg; clearTimeout(toast._t);
      toast._t = setTimeout(() => statusEl.textContent = '', 2500);
    }

    // Event listeners
    quickAddForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const t = title.value.trim(); if (!t) { toast('Add a reminder title'); return; }
      let due = null;
      if (date.value || time.value) {
        const d = (date.value || todayISO());
        const tm = (time.value || '09:00');
        due = new Date(`${d}T${tm}:00`).toISOString();
      }
      addItem({ title: t, priority: priority.value, due });
      title.value = ''; time.value = ''; date.value = '';
    });

    q.addEventListener('input', render);
    sortSel.addEventListener('change', () => { sortKey = sortSel.value; render(); });
    document.querySelectorAll('button[data-filter]').forEach(b => b.addEventListener('click', () => {
      filter = b.getAttribute('data-filter'); render();
    }));

    // Show/hide quick add (floating button)
    fab.addEventListener('click', () => {
      quickAddSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      title.focus();
    });

    // Voice recognition
    let recog = null, listening = false;
    try {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SR) {
        recog = new SR();
        recog.lang = 'en-AU';
        recog.interimResults = false;
        recog.onresult = (e) => {
          const t = e.results[0][0].transcript || '';
          title.value = t;
          toast('Heard: ' + t);
        };
        recog.onend = () => { listening = false; voiceBtn.textContent = 'üéôÔ∏è'; };
      }
    } catch { }
    voiceBtn.addEventListener('click', () => {
      if (!recog) return;
      if (!listening) { try { recog.start(); listening = true; voiceBtn.textContent = 'üé§'; } catch { } }
      else { try { recog.stop(); } catch { } listening = false; voiceBtn.textContent = 'üéôÔ∏è'; }
    });

    // Notifications
    notifBtn.addEventListener('click', async () => {
      if (!('Notification' in window)) { toast('Notifications not supported'); return; }
      if (Notification.permission === 'granted') { toast('Notifications enabled'); return; }
      const perm = await Notification.requestPermission();
      toast(perm === 'granted' ? 'Notifications enabled' : 'Notifications blocked');
    });

    // Online/offline
    window.addEventListener('online', () => {
      syncStatus.textContent = 'Online';
      syncStatus.className = 'sync-status online';
    });
    window.addEventListener('offline', () => {
      syncStatus.textContent = 'Offline';
      syncStatus.className = 'sync-status offline';
    });

    // Initial render
    render();
  </script>

  <!-- Manifest for installability -->
  <link rel="manifest" href="manifest.webmanifest" />
</body>
</html>
