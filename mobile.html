<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memory Cue (Mobile) — Inline + Edit + Sync All</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="#" id="manifestLink" />
  <style>
    :root{
      --bg-primary:#0b1220; --bg-secondary:#0f172a; --bg-tertiary:#1e293b;
      --text-primary:#f8fafc; --text-secondary:#cbd5e1; --text-muted:#94a3b8;
      --accent:#38bdf8; --accent-hover:#0ea5e9;
      --success:#22c55e; --success-hover:#16a34a;
      --warning:#f59e0b; --danger:#ef4444;
      --border:#334155; --border-light:#475569;
      --space-1:4px; --space-2:8px; --space-3:12px; --space-4:16px; --space-5:20px; --space-6:24px; --space-8:32px;
      --text-xs:11px; --text-sm:13px; --text-base:15px; --text-lg:17px; --text-xl:19px; --text-2xl:22px;
      --radius-sm:8px; --radius:10px; --radius-md:12px; --radius-lg:14px;
      --touch-target:44px; --button-height:42px;
      --shadow-sm:0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-md:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    *{box-sizing:border-box} html,body{height:100%;margin:0;padding:0}
    body{background:linear-gradient(180deg,var(--bg-primary) 0%,#0a0f1c 100%);color:var(--text-primary);
         font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
         font-size:var(--text-base);line-height:1.5;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
         -webkit-tap-highlight-color:transparent;}
    .container{max-width:520px;margin:0 auto;padding:0 var(--space-3)}
    header{position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);
z-index:100;box-shadow:var(--shadow-sm)}
    .header-content{padding:var(--space-3) 0}
    .header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-4)}
    h1{font-size:var(--text-2xl);font-weight:700;margin:0;letter-spacing:-.025em;background:linear-gradient(135deg,var(--text-primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header-controls{display:flex;gap:var(--space-2);flex-wrap:wrap;align-items:center}
    input,select,button,textarea{font-family:inherit;font-size:var(--text-sm);line-height:1.4;border:1px solid var(--border);border-radius:var(--radius);transition:.2s all;-webkit-appearance:none;appearance:none}
    input,select,textarea{background:var(--bg-secondary);color:var(--text-primary);padding:var(--space-3);min-height:var(--button-height);box-shadow:var(--shadow-sm)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(56,189,248,.1)}
    input::placeholder,textarea::placeholder{color:var(--text-muted)}
    .search-input{flex:1;min-width:160px}
    button{cursor:pointer;font-weight:500;padding:var(--space-3);min-height:var(--touch-target);display:inline-flex;align-items:center;justify-content:center;gap:var(--space-1);white-space:nowrap;border:1px solid transparent;transition:.2s all;user-select:none;-webkit-user-select:none;touch-action:manipulation}
    button:active{transform:scale(.98)}
    .btn-primary{background:var(--accent);color:var(--bg-primary);border-color:var(--accent);font-weight:600}
    .btn-primary:hover,.btn-primary:focus{background:var(--accent-hover);border-color:var(--accent-hover)}
    .btn-success{background:var(--success);color:var(--bg-primary);border-color:var(--success);font-weight:600}
    .btn-success:hover,.btn-success:focus{background:var(--success-hover);border-color:var(--success-hover)}
    .btn-ghost{background:var(--bg-secondary);color:var(--text-secondary);border-color:var(--border)}
    .btn-ghost:hover,.btn-ghost:focus{background:var(--bg-tertiary);color:var(--text-primary);border-color:var(--border-light)}
    .btn-compact{padding:var(--space-2) var(--space-3);min-height:36px;font-size:var(--text-xs)}
    .tabs{display:flex;border-bottom:1px solid var(--border);}
    .tab-btn{flex:1;background:var(--bg-secondary);color:var(--text-secondary);border:0;border-bottom:2px solid transparent;padding:var(--space-3);font-weight:600}
    .tab-btn.active{color:var(--text-primary);background:var(--bg-tertiary);border-bottom-color:var(--accent)}
    .main-content{padding:var(--space-4) 0}
    .section{margin-bottom:var(--space-6)}
    .card{background:var(--bg-secondary);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow);overflow:hidden}
    .card-header{padding:var(--space-4);border-bottom:1px solid var(--border);background:var(--bg-tertiary)}
    .card-content{padding:var(--space-4)}
    .card-title{font-size:var(--text-lg);font-weight:600;margin:0;color:var(--text-primary)}
    .section-subtitle{font-size:var(--text-xs);font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin:var(--space-4) 0 var(--space-3)}
    .form-stack{display:flex;flex-direction:column;gap:var(--space-3)}
    .form-row{display:flex;gap:var(--space-2);align-items:flex-end}
    .form-group{display:flex;flex-direction:column;gap:var(--space-1)}
    .form-group.flex-1{flex:1}
    .task-list{display:flex;flex-direction:column;gap:var(--space-3)}
    .task-item{display:grid;grid-template-columns:auto 1fr auto;gap:var(--space-3);align-items:flex-start;padding:var(--space-4);background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-md);transition:.2s all}
    .task-item:active{transform:scale(.99)}
    .task-item.completed .task-title{text-decoration:line-through;color:var(--text-muted)}
    .task-content{min-width:0;padding-top:2px}
    .task-title{font-size:var(--text-base);font-weight:500;margin:0 0 var(--space-1);color:var(--text-primary)}
    .task-meta{display:flex;flex-direction:column;gap:var(--space-1);font-size:var(--text-xs);color:var(--text-muted)}
    .task-meta-row{display:flex;gap:var(--space-2);align-items:center;flex-wrap:wrap}
    .priority-badge{padding:2px var(--space-2);border-radius:var(--radius-sm);font-size:var(--text-xs);font-weight:500;border:1px solid transparent;flex-shrink:0}
    .priority-high{background:rgba(239,68,68,.1);color:#fca5a5;border-color:rgba(239,68,68,.2)}
    .priority-medium{background:rgba(245,158,11,.1);color:#fcd34d;border-color:rgba(245,158,11,.2)}
    .priority-low{background:rgba(34,197,94,.1);color:#86efac;border-color:rgba(34,197,94,.2)}
    input[type="checkbox"]{width:18px;height:18px;cursor:pointer;margin-top:2px}
    .sync-status{padding:var(--space-1) var(--space-2);border-radius:var(--radius-sm);font-size:var(--text-xs);font-weight:600;border:1px solid transparent}
    .sync-status.online{background:rgba(34,197,94,.1);color:var(--success);border-color:rgba(34,197,94,.2)}
    .sync-status.offline{background:rgba(245,158,11,.1);color:var(--warning);border-color:rgba(245,158,11,.2)}
    .sync-status.error{background:rgba(239,68,68,.1);color:var(--danger);border-color:rgba(239,68,68,.2)}
    .google-avatar{width:20px;height:20px;border-radius:50%;object-fit:cover;margin-right:var(--space-1)}
    .auth-info{font-size:var(--text-xs);color:var(--text-muted);display:flex;align-items:center;gap:var(--space-1)}
    .status-message{font-size:var(--text-xs);color:var(--text-muted);margin-top:var(--space-2)}
    .footer{text-align:center;padding:var(--space-6) 0;color:var(--text-muted);font-size:var(--text-xs);border-top:1px solid var(--border);margin-top:var(--space-8)}

    /* Utils */
    .hidden{display:none !important;}

    /* Header tools menu */
    .menu-wrap { position: relative; margin-left: auto; }
    .menu { position: absolute; right: 0; top: calc(100% + 6px); background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow-md); min-width: 200px; padding: 6px; z-index: 200; }
    .menu.hidden { display: none; }
    .menu-item { width: 100%; text-align: left; background: transparent; border: 0; padding: 10px 12px; border-radius: var(--radius-sm); font-size: var(--text-sm); color: var(--text-primary); }
    .menu-item:hover, .menu-item:focus { background: var(--bg-tertiary); outline: none; }
    .menu-sep { height: 1px; background: var(--border); margin: 6px 0; }

    /* Inline agenda counters */
    .panel-header { display:grid; grid-template-columns: 1fr auto; gap: var(--space-3); align-items:center; }
    .summary-pills { display:flex; gap: var(--space-2); align-items:center; }
    .pill { display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); background:var(--bg-tertiary); border-radius: var(--radius-sm); }
    .pill .count { font-weight:700; font-size: 18px; line-height: 1; }
    .filters { display:flex; gap: var(--space-2); alignments:center; flex-wrap:wrap; justify-content:flex-end; }
    .filter-buttons { display:flex; gap: var(--space-2); }
    .filter-buttons .btn-ghost.active { outline:2px solid rgba(56,189,248,.35); outline-offset:0; }
    .sort-control select { min-width: 120px; }

    @media (max-width: 430px){
      .panel-header { grid-template-columns: 1fr; gap: var(--space-2); }
      .filters { justify-content: flex-start; }
    }
  /* Visually hidden but accessible */
    .sr-only {
      position: absolute !important;
      width: 1px !important;
      height: 1px !important;
      padding: 0 !important;
      margin: -1px !important;
      overflow: hidden !important;
      clip: rect(0, 0, 1px, 1px) !important;
      white-space: nowrap !important;
      border: 0 !important;
    }

    /* Notebook Layout */
    .notebook-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: var(--space-4);
      height: calc(100vh - 200px);
      min-height: 500px;
    }

    @media (max-width: 768px) {
      .notebook-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        height: auto;
        min-height: auto;
      }
    }

    /* Notes Sidebar */
    .notes-sidebar {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--space-3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .notes-header {
      margin-bottom: var(--space-3);
    }

    .notes-stats {
      margin-top: var(--space-2);
      font-size: var(--text-sm);
      color: var(--text-muted);
      display: flex;
      gap: var(--space-3);
    }

    .notes-list {
      flex: 1;
      overflow-y: auto;
      margin: 0 calc(-1 * var(--space-3));
      padding: 0 var(--space-3);
    }

    .note-item {
      padding: var(--space-3);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-tertiary);
      margin-bottom: var(--space-2);
      cursor: pointer;
      transition: all 0.2s;
    }

    .note-item:hover {
      background: var(--bg-primary);
      border-color: var(--border-light);
    }

    .note-item.active {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }

    .note-item-title {
      font-weight: 600;
      font-size: var(--text-sm);
      margin-bottom: var(--space-1);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .note-item-snippet {
      font-size: var(--text-xs);
      color: var(--text-muted);
      margin-bottom: var(--space-2);
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      line-height: 1.3;
    }

    .note-item.active .note-item-snippet {
      color: rgba(11, 18, 32, 0.7);
    }

    .note-item-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    .note-item.active .note-item-meta {
      color: rgba(11, 18, 32, 0.6);
    }

    .note-item-tags {
      display: flex;
      gap: var(--space-1);
      flex-wrap: wrap;
    }

    .note-tag {
      background: var(--bg-primary);
      color: var(--text-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: var(--text-xs);
      border: 1px solid var(--border);
    }

    .note-item.active .note-tag {
      background: rgba(11, 18, 32, 0.2);
      color: var(--bg-primary);
      border-color: rgba(11, 18, 32, 0.3);
    }

    .empty-notes {
      text-align: center;
      color: var(--text-muted);
      font-style: italic;
      padding: var(--space-6);
    }

    /* Note Editor */
    .note-editor {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--space-4);
      display: flex;
      flex-direction: column;
      min-height: 500px;
    }

    .note-editor-header {
      display: flex;
      gap: var(--space-3);
      align-items: flex-start;
      margin-bottom: var(--space-3);
    }

    @media (max-width: 640px) {
      .note-editor-header {
        flex-direction: column;
        gap: var(--space-2);
      }
    }

    .note-title-input {
      flex: 1;
      font-size: var(--text-lg);
      font-weight: 600;
      background: var(--bg-tertiary);
    }

    .note-actions {
      display: flex;
      gap: var(--space-2);
    }

    @media (max-width: 640px) {
      .note-actions {
        width: 100%;
        justify-content: space-between;
      }
    }

    .note-tags-line {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-3);
      min-height: 24px;
    }

    .tags-label {
      font-size: var(--text-sm);
      color: var(--text-muted);
      font-weight: 500;
    }

    .note-tags {
      display: flex;
      gap: var(--space-1);
      flex-wrap: wrap;
    }

    .note-content {
      flex: 1;
      background: var(--bg-tertiary);
      resize: none;
      font-family: inherit;
      line-height: 1.6;
      min-height: 300px;
    }

    .note-status {
      margin-top: var(--space-3);
      font-size: var(--text-sm);
      color: var(--text-muted);
      min-height: 20px;
      display: flex;
      align-items: center;
    }

    .note-status.success {
      color: var(--success);
    }

    .note-status.error {
      color: var(--danger);
    }

    @media (max-width: 768px) {
      .notes-sidebar {
        max-height: 300px;
        margin-bottom: var(--space-4);
      }
      
      .note-editor {
        min-height: 400px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="header-top">
          <h1>Memory Cue</h1>
          <div id="syncStatus" class="sync-status offline" aria-live="polite">Offline</div>
        </div>
        <div class="header-controls">
          <input id="q" class="search-input" placeholder="Search reminders or #tags" aria-label="Search reminders" />
          <button id="voiceBtn" class="btn-ghost btn-compact" type="button" title="Voice quick add" aria-label="Start voice input">🎙️</button>
          <button id="notifBtn" class="btn-ghost btn-compact" type="button" title="Enable notifications" aria-label="Enable notifications">🔔</button>
          <button id="addQuickBtn" class="btn-primary btn-compact" type="button" title="Add quick reminder" aria-label="Add quick reminder">+</button>
          <div class="menu-wrap">
            <button id="moreBtn" class="btn-ghost btn-compact" aria-haspopup="true" aria-expanded="false" aria-controls="moreMenu" title="More actions" aria-label="More actions">⋯</button>
            <div id="moreMenu" class="menu hidden" role="menu" aria-label="More actions">
              <button id="copyMtlBtn" class="menu-item" role="menuitem">Copy MTL</button>
              <label class="menu-item" role="menuitem" for="importFile" style="display:flex; align-items:center; gap:8px; cursor:pointer;">Import<input id="importFile" type="file" accept="application/json" class="sr-only" /></label>
              <button id="exportBtn" class="menu-item" role="menuitem">Export</button>
              <button id="syncAllBtn" class="menu-item" role="menuitem">Sync All Now</button>
              <div class="menu-sep"></div>
              <button id="openSettings" class="menu-item" role="menuitem">Settings</button>
            </div>
          </div>
        </div>
        <div class="header-controls" style="margin-top: var(--space-2);">
          <button id="googleSignInBtn" class="btn-ghost" type="button" aria-label="Sign in with Google">Sign in with Google</button>
          <button id="googleSignOutBtn" class="btn-ghost hidden" type="button" aria-label="Sign out">
            <img id="googleAvatar" class="google-avatar hidden" alt="Google avatar" />
            Sign out
          </button>
          <div id="googleUserName" class="auth-info" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </header>
  <nav class="tabs">
    <button class="tab-btn active" data-target="tasksTab">Reminders</button>
    <button class="tab-btn" data-target="notebookTab">Notebook</button>
  </nav>

  <div id="tasksTab" class="tab-panel">
    <main class="main-content">
    <div class="container">
      <!-- Create Reminder Card -->
      <section class="card section">
        <div class="card-header"><h2 class="card-title">Create Reminder</h2></div>
        <div class="card-content">
          <div class="form-stack">
            <div class="form-group">
              <label class="sr-only" for="title">Reminder</label>
              <input id="title" placeholder="e.g., Email parents about camp #admin" aria-label="Reminder title" />
              <div id="dateFeedback" style="margin-top: 4px; font-size: 12px; color: var(--text-muted); display: none;"></div>
            </div>
            <div class="form-row">
              <div class="form-group flex-1">
                <label class="sr-only" for="date">Date</label>
                <input id="date" type="date" aria-label="Due date" />
              </div>
              <div class="form-group flex-1">
                <label class="sr-only" for="time">Time</label>
                <input id="time" type="time" aria-label="Due time" />
              </div>
              <div class="form-group">
                <label class="sr-only" for="priority">Priority</label>
                <select id="priority" aria-label="Priority">
                  <option>High</option><option selected>Medium</option><option>Low</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <button id="saveBtn" class="btn-success flex-1" type="button">Save Reminder</button>
              <button id="cancelEditBtn" class="btn-ghost flex-1 hidden" type="button">Cancel</button>
            </div>
          </div>
          <div id="status" class="status-message" aria-live="polite"></div>
        </div>
      </section>

      <!-- Reminders List with inline counters -->
      <section class="card section">
        <div class="card-header">
          <div class="panel-header">
            <div class="summary-pills">
              <div class="pill" title="Tasks due today">
                <span>Today</span>
                <span class="count" id="inlineTodayCount">0</span>
              </div>
              <div class="pill" title="Tasks due this week">
                <span>This Week</span>
                <span class="count" id="inlineWeekCount">0</span>
              </div>
            </div>
            <div class="filters">
              <div class="filter-buttons">
                <button class="btn-ghost active" data-filter="today" type="button">Today</button>
                <button class="btn-ghost" data-filter="overdue" type="button">Overdue</button>
                <button class="btn-ghost" data-filter="all" type="button">All</button>
                <button class="btn-ghost" data-filter="done" type="button">Done</button>
              </div>
              <div class="sort-control">
                <label class="sr-only" for="sort">Sort</label>
                <select id="sort">
                  <option value="smart">Smart sort</option>
                  <option value="time">Time</option>
                  <option value="priority">Priority</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="card-content">
          <div id="list" class="task-list" aria-live="polite">
            <div class="text-muted">No reminders yet.</div>
          </div>
        </div>
      </section>

      <!-- Settings (hidden by default) -->
      <section class="card section hidden" id="settingsSection">
        <div class="card-header"><h2 class="card-title">Sync Settings</h2></div>
        <div class="card-content">
          <div class="form-stack">
            <div class="form-group"><input id="syncUrl" placeholder="https://script.google.com/macros/s/AKfycb.../exec" aria-label="Google Apps Script URL" /></div>
            <div class="form-row"><button id="saveSettings" class="btn-success flex-1" type="button">Save</button><button id="testSync" class="btn-ghost flex-1" type="button">Test</button></div>
          </div>
          <div class="text-muted" style="margin-top: var(--space-3); font-size: var(--text-xs);">
            <strong>Tip:</strong> In Google Apps Script, click <strong>Deploy → New deployment → Web app</strong>,
            set <strong>Execute as: Me</strong>, <strong>Who has access: Anyone with the link</strong>, then copy the URL.
          </div>
        </div>
      </section>
    </div>
  </main>
  </div>

  <div id="notebookTab" class="tab-panel hidden">
    <div class="container">
      <div class="notebook-layout">
        <!-- Notes Archive Sidebar -->
        <div class="notes-sidebar">
          <div class="notes-header">
            <input type="text" id="notesSearch" class="search-input" placeholder="Search notes or #tags..." />
            <div class="notes-stats">
              <span id="notesCount">0 notes</span>
              <span id="filteredCount"></span>
            </div>
          </div>
          <div id="notesList" class="notes-list">
            <div class="empty-notes">No notes yet. Create your first note!</div>
          </div>
        </div>

        <!-- Note Editor -->
        <div class="note-editor">
          <div class="note-editor-header">
            <input type="text" id="noteTitle" class="note-title-input" placeholder="Note title..." />
            <div class="note-actions">
              <button id="saveNoteBtn" class="btn-success btn-compact" type="button" title="Save note (Ctrl+S)">Save Note</button>
              <button id="newNoteBtn" class="btn-primary btn-compact" type="button" title="New note (Ctrl+Shift+N)">New Note</button>
              <button id="deleteNoteBtn" class="btn-ghost btn-compact" type="button" title="Delete note">Delete Note</button>
            </div>
          </div>
          <div class="note-tags-line">
            <span class="tags-label">Tags:</span>
            <div id="noteTags" class="note-tags"></div>
          </div>
          <textarea id="noteContent" class="note-content" placeholder="Start writing your note..."></textarea>
          <div id="noteStatus" class="note-status" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase imports with fallbacks for offline testing
    let initializeApp, getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, enableIndexedDbPersistence, serverTimestamp;
    let getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut;
    let app, db, auth;
    let firebaseAvailable = false;

    try {
      ({ initializeApp } = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js'));
      ({ getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, enableIndexedDbPersistence, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js'));
      ({ getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut } = await import('https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js'));
      firebaseAvailable = true;
    } catch (error) {
      console.warn('Firebase unavailable, running in offline mode:', error);
      // Mock Firebase functions for offline testing
      initializeApp = () => ({});
      getFirestore = () => ({});
      doc = () => ({});
      setDoc = () => Promise.resolve();
      deleteDoc = () => Promise.resolve();
      onSnapshot = () => () => {};
      collection = () => ({});
      query = () => ({});
      orderBy = () => ({});
      enableIndexedDbPersistence = () => Promise.resolve();
      serverTimestamp = () => new Date();
      getAuth = () => ({});
      onAuthStateChanged = () => {};
      GoogleAuthProvider = class {};
      signInWithPopup = () => Promise.reject(new Error('Offline'));
      signInWithRedirect = () => Promise.reject(new Error('Offline'));
      getRedirectResult = () => Promise.resolve();
      signOut = () => Promise.resolve();
    }

    // Firebase initialization
    if (firebaseAvailable) {
      const firebaseConfig = {
        apiKey: "AIzaSyAmAMiz0zG3dAhZJhOy1DYj8fKVDObL36c",
        authDomain: "memory-cue-app.firebaseapp.com",
        projectId: "memory-cue-app",
        storageBucket: "memory-cue-app.firebasestorage.app",
        messagingSenderId: "751284466633",
        appId: "1:751284466633:web:3b10742970bef1a5d5ee18",
        measurementId: "G-R0V4M7VCE6"
      };
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      enableIndexedDbPersistence(db).catch(err => { console.warn('Firestore persistence not enabled:', err?.code || err); });
      auth = getAuth(app);
    } else {
      app = {};
      db = {};
      auth = {};
    }

    // State
    let items = [];
    let filter = 'today';
    let sortKey = 'smart';
    let listening = false;
    let recog = null;
    let userId = null;
    let unsubscribe = null;

    // Notebook state
    let notes = [];
    let currentNote = null;
    let notesFilter = '';
    let autoSaveTimeout = null;
    let notesUnsubscribe = null;

    // ---- Edit state ----
    let editingId = null;

    const TZ = 'Australia/Adelaide';
    const timeFmt = new Intl.DateTimeFormat('en-AU', { timeZone: TZ, hour:'2-digit', minute:'2-digit' });
    const dayFmt  = new Intl.DateTimeFormat('en-AU', { timeZone: TZ, weekday:'long', day:'numeric', month:'long' });
    // --- TZ-safe helpers (Australia/Adelaide) ---
    const dateOnlyFmt = new Intl.DateTimeFormat('en-CA', { timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit' }); // YYYY-MM-DD
    function formatDateLocal(d){ // returns 'YYYY-MM-DD' in TZ
      const parts = dateOnlyFmt.formatToParts(d);
      const y = parts.find(p=>p.type==='year').value;
      const m = parts.find(p=>p.type==='month').value;
      const da = parts.find(p=>p.type==='day').value;
      return `${y}-${m}-${da}`;
    }
    function localDateTimeToISO(dstr, tstr){ // build a Date using local wall time, then toISOString()
      const [Y,M,D] = dstr.split('-').map(n=>parseInt(n,10));
      const [h,m] = tstr.split(':').map(n=>parseInt(n,10));
      const dt = new Date();
      dt.setFullYear(Y, (M||1)-1, D||1);
      dt.setHours(h||0, m||0, 0, 0);
      return dt.toISOString();
    }

    const datePartsFmt = new Intl.DateTimeFormat('en-AU', { timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit' });
    const timePartsFmt = new Intl.DateTimeFormat('en-AU', { timeZone: TZ, hour: '2-digit', minute: '2-digit', hour12: false });

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // Elements
    const q = $('#q'), title = $('#title'), date = $('#date'), time = $('#time'), priority = $('#priority'), saveBtn = $('#saveBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const list = $('#list'), statusEl = $('#status'), syncStatus = $('#syncStatus');
    const voiceBtn = $('#voiceBtn'), notifBtn = $('#notifBtn'), addQuickBtn = $('#addQuickBtn');
    const copyMtlBtn = $('#copyMtlBtn'), importFile = $('#importFile'), exportBtn = $('#exportBtn');
    const dateFeedback = $('#dateFeedback');
    const sortSel = $('#sort'), openSettings = $('#openSettings'), settingsSection = $('#settingsSection');
    const syncAllBtn = document.getElementById('syncAllBtn');
    const syncUrlInput = $('#syncUrl'), saveSettings = $('#saveSettings'), testSync = $('#testSync');
    const googleSignInBtn = $('#googleSignInBtn'), googleSignOutBtn = $('#googleSignOutBtn'), googleAvatar = $('#googleAvatar'), googleUserName = $('#googleUserName');
    const moreBtn = $('#moreBtn'), moreMenu = $('#moreMenu');
    const inlineTodayCount = $('#inlineTodayCount'), inlineWeekCount = $('#inlineWeekCount');
    // Notebook elements
    const notesSearch = $('#notesSearch'), notesList = $('#notesList'), notesCount = $('#notesCount'), filteredCount = $('#filteredCount');
    const noteTitle = $('#noteTitle'), noteContent = $('#noteContent'), noteTags = $('#noteTags'), noteStatus = $('#noteStatus');
    const saveNoteBtn = $('#saveNoteBtn'), newNoteBtn = $('#newNoteBtn'), deleteNoteBtn = $('#deleteNoteBtn');
    const tabBtns = $$('.tab-btn');
    const tabPanels = $$('.tab-panel');

    tabBtns.forEach(btn => btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('active'));
      tabPanels.forEach(p => p.classList.add('hidden'));
      btn.classList.add('active');
      const target = btn.getAttribute('data-target');
      document.getElementById(target).classList.remove('hidden');
      
      // Initialize notebook on first view
      if (target === 'notebookTab' && notes.length === 0) {
        initializeNotebook();
      }
    }));

    // ========================
    // NOTEBOOK FUNCTIONALITY
    // ========================

    function initializeNotebook() {
      loadNotesFromStorage();
      migrateLegacyNotes();
      renderNotesList();
      setupNotesSync();
      
      if (notes.length === 0) {
        createNewNote();
      } else {
        selectNote(notes[0]);
      }
    }

    function loadNotesFromStorage() {
      try {
        const stored = localStorage.getItem('mobileNotesArchive');
        notes = stored ? JSON.parse(stored) : [];
      } catch (error) {
        console.error('Failed to load notes from storage:', error);
        notes = [];
      }
    }

    function saveNotesToStorage() {
      try {
        localStorage.setItem('mobileNotesArchive', JSON.stringify(notes));
      } catch (error) {
        console.error('Failed to save notes to storage:', error);
      }
    }

    function migrateLegacyNotes() {
      const legacyContent = localStorage.getItem('mobileNotes');
      if (legacyContent && legacyContent.trim() && notes.length === 0) {
        const migratedNote = {
          id: generateId(),
          title: 'Migrated Note',
          content: legacyContent.trim(),
          tags: extractTags(legacyContent),
          createdAt: Date.now(),
          updatedAt: Date.now(),
          synced: false
        };
        notes.push(migratedNote);
        saveNotesToStorage();
        localStorage.removeItem('mobileNotes'); // Clean up legacy data
      }
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function extractTags(text) {
      const tagPattern = /#([a-zA-Z0-9_-]+)/g;
      const tags = new Set();
      let match;
      while ((match = tagPattern.exec(text)) !== null) {
        tags.add(match[1].toLowerCase());
      }
      return Array.from(tags);
    }

    function createNewNote() {
      const newNote = {
        id: generateId(),
        title: '',
        content: '',
        tags: [],
        createdAt: Date.now(),
        updatedAt: Date.now(),
        synced: false
      };
      
      notes.unshift(newNote);
      saveNotesToStorage();
      selectNote(newNote);
      renderNotesList();
      
      // Focus title input
      setTimeout(() => noteTitle.focus(), 100);
      showStatus('New note created');
    }

    function selectNote(note) {
      currentNote = note;
      noteTitle.value = note.title;
      noteContent.value = note.content;
      renderNoteTags(note.tags);
      renderNotesList(); // Re-render to update active state
      
      // Clear any pending auto-save
      if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = null;
      }
    }

    function saveCurrentNote() {
      if (!currentNote) return;
      
      const title = noteTitle.value.trim();
      const content = noteContent.value.trim();
      
      // Don't save empty notes
      if (!title && !content) {
        showStatus('Cannot save empty note', 'error');
        return;
      }
      
      // Extract tags from title and content
      const allText = title + ' ' + content;
      const tags = extractTags(allText);
      
      // Update note
      currentNote.title = title || 'Untitled';
      currentNote.content = content;
      currentNote.tags = tags;
      currentNote.updatedAt = Date.now();
      currentNote.synced = false;
      
      // Move to top of list (most recently updated)
      const index = notes.indexOf(currentNote);
      if (index > 0) {
        notes.splice(index, 1);
        notes.unshift(currentNote);
      }
      
      saveNotesToStorage();
      renderNoteTags(tags);
      renderNotesList();
      
      // Sync to Firestore if signed in
      if (userId) {
        saveNoteToFirestore(currentNote);
      }
      
      showStatus('Saved', 'success');
    }

    function deleteCurrentNote() {
      if (!currentNote) return;
      
      if (!confirm('Are you sure you want to delete this note?')) {
        return;
      }
      
      const index = notes.indexOf(currentNote);
      if (index !== -1) {
        // Delete from Firestore if signed in
        if (userId && currentNote.synced) {
          deleteNoteFromFirestore(currentNote.id);
        }
        
        notes.splice(index, 1);
        saveNotesToStorage();
        
        // Select another note or create new one
        if (notes.length > 0) {
          const nextNote = notes[Math.min(index, notes.length - 1)];
          selectNote(nextNote);
        } else {
          createNewNote();
        }
        
        renderNotesList();
        showStatus('Note deleted');
      }
    }

    function renderNotesList() {
      let filteredNotes = notes;
      
      // Apply search filter
      if (notesFilter.trim()) {
        const query = notesFilter.toLowerCase();
        const isTagSearch = query.startsWith('#');
        
        if (isTagSearch) {
          const tagQuery = query.slice(1);
          filteredNotes = notes.filter(note => 
            note.tags.some(tag => tag.includes(tagQuery))
          );
        } else {
          filteredNotes = notes.filter(note => 
            note.title.toLowerCase().includes(query) ||
            note.content.toLowerCase().includes(query) ||
            note.tags.some(tag => tag.includes(query))
          );
        }
      }
      
      // Update stats
      notesCount.textContent = `${notes.length} note${notes.length !== 1 ? 's' : ''}`;
      if (notesFilter.trim() && filteredNotes.length !== notes.length) {
        filteredCount.textContent = `(${filteredNotes.length} shown)`;
      } else {
        filteredCount.textContent = '';
      }
      
      // Render list
      if (filteredNotes.length === 0) {
        notesList.innerHTML = '<div class="empty-notes">No notes match your search.</div>';
        return;
      }
      
      const html = filteredNotes.map(note => {
        const isActive = currentNote && currentNote.id === note.id;
        const snippet = note.content.slice(0, 100);
        const timeAgo = formatTimeAgo(note.updatedAt);
        
        return `
          <div class="note-item ${isActive ? 'active' : ''}" data-note-id="${note.id}">
            <div class="note-item-title">${escapeHtml(note.title || 'Untitled')}</div>
            <div class="note-item-snippet">${escapeHtml(snippet)}</div>
            <div class="note-item-meta">
              <div class="note-item-tags">
                ${note.tags.slice(0, 3).map(tag => `<span class="note-tag">#${tag}</span>`).join('')}
                ${note.tags.length > 3 ? `<span class="note-tag">+${note.tags.length - 3}</span>` : ''}
              </div>
              <span>${timeAgo}</span>
            </div>
          </div>
        `;
      }).join('');
      
      notesList.innerHTML = html;
      
      // Add click handlers
      notesList.querySelectorAll('.note-item').forEach(item => {
        item.addEventListener('click', () => {
          const noteId = item.dataset.noteId;
          const note = notes.find(n => n.id === noteId);
          if (note) {
            selectNote(note);
          }
        });
      });
    }

    function renderNoteTags(tags) {
      if (tags.length === 0) {
        noteTags.innerHTML = '<span style="color: var(--text-muted); font-style: italic;">No tags</span>';
      } else {
        noteTags.innerHTML = tags.map(tag => `<span class="note-tag">#${tag}</span>`).join('');
      }
    }

    function formatTimeAgo(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return new Date(timestamp).toLocaleDateString();
    }

    function showStatus(message, type = '') {
      noteStatus.textContent = message;
      noteStatus.className = `note-status ${type}`;
      
      if (message) {
        setTimeout(() => {
          noteStatus.textContent = '';
          noteStatus.className = 'note-status';
        }, 3000);
      }
    }

    function scheduleAutoSave() {
      if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
      }
      
      autoSaveTimeout = setTimeout(() => {
        if (currentNote) {
          saveCurrentNote();
        }
      }, 800);
    }

    // Firestore integration for notes
    function setupNotesSync() {
      if (!userId) return;
      
      if (notesUnsubscribe) {
        notesUnsubscribe();
      }
      
      const notesCollection = collection(db, 'users', userId, 'notes');
      const notesQuery = query(notesCollection, orderBy('updatedAt', 'desc'));
      
      notesUnsubscribe = onSnapshot(notesQuery, (snapshot) => {
        const remoteNotes = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          remoteNotes.push({
            id: doc.id,
            title: data.title || '',
            content: data.content || '',
            tags: data.tags || [],
            createdAt: data.createdAt?.toMillis?.() || 0,
            updatedAt: data.updatedAt?.toMillis?.() || 0,
            synced: true
          });
        });
        
        // Merge with local notes
        mergeNotesWithRemote(remoteNotes);
        renderNotesList();
      }, (error) => {
        console.error('Notes sync error:', error);
        showStatus('Sync error', 'error');
      });
      
      // Upload unsynced local notes
      uploadUnsyncedNotes();
    }

    function mergeNotesWithRemote(remoteNotes) {
      const merged = new Map();
      
      // Add remote notes first
      remoteNotes.forEach(note => merged.set(note.id, note));
      
      // Add local notes, keeping local if newer
      notes.forEach(localNote => {
        const remoteNote = merged.get(localNote.id);
        if (!remoteNote || localNote.updatedAt > remoteNote.updatedAt) {
          merged.set(localNote.id, localNote);
        }
      });
      
      notes = Array.from(merged.values()).sort((a, b) => b.updatedAt - a.updatedAt);
      saveNotesToStorage();
    }

    function uploadUnsyncedNotes() {
      if (!userId) return;
      
      const unsyncedNotes = notes.filter(note => !note.synced);
      unsyncedNotes.forEach(note => {
        saveNoteToFirestore(note);
      });
    }

    async function saveNoteToFirestore(note) {
      if (!userId) return;
      
      try {
        await setDoc(doc(db, 'users', userId, 'notes', note.id), {
          title: note.title,
          content: note.content,
          tags: note.tags,
          createdAt: note.createdAt ? new Date(note.createdAt) : serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });
        
        note.synced = true;
        saveNotesToStorage();
      } catch (error) {
        console.error('Failed to save note to Firestore:', error);
        showStatus('Save failed - queued for retry', 'error');
      }
    }

    async function deleteNoteFromFirestore(noteId) {
      if (!userId) return;
      
      try {
        await deleteDoc(doc(db, 'users', userId, 'notes', noteId));
      } catch (error) {
        console.error('Failed to delete note from Firestore:', error);
      }
    }

    // Event Listeners for Notebook
    notesSearch.addEventListener('input', (e) => {
      notesFilter = e.target.value;
      renderNotesList();
    });

    noteTitle.addEventListener('input', scheduleAutoSave);
    noteContent.addEventListener('input', scheduleAutoSave);

    saveNoteBtn.addEventListener('click', saveCurrentNote);
    newNoteBtn.addEventListener('click', createNewNote);
    deleteNoteBtn.addEventListener('click', deleteCurrentNote);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Only handle shortcuts when in notebook tab
      if (!document.getElementById('notebookTab').classList.contains('hidden')) {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          saveCurrentNote();
        } else if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'N') {
          e.preventDefault();
          createNewNote();
        }
      }
    });

    // ========================
    // END NOTEBOOK FUNCTIONALITY
    // ========================

    // Auth
    googleSignInBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try { await signInWithPopup(auth, provider); } catch (error) { try { await signInWithRedirect(auth, provider); } catch (e) { toast('Google sign-in failed'); } }
    });
    getRedirectResult(auth).catch(()=>{});
    googleSignOutBtn.addEventListener('click', async () => { try { await signOut(auth); toast('Signed out'); items=[]; render(); } catch { toast('Sign-out failed'); } });
    // Auth state handling
    if (firebaseAvailable) {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          userId = user.uid;
          syncStatus.textContent = 'Online'; syncStatus.className = 'sync-status online';
          googleSignInBtn.classList.add('hidden'); googleSignOutBtn.classList.remove('hidden');
          if (user.photoURL) { googleAvatar.classList.remove('hidden'); googleAvatar.src = user.photoURL; } else { googleAvatar.classList.add('hidden'); googleAvatar.src = ''; }
          googleUserName.textContent = user.displayName || user.email || '';
          setupFirestoreSync();
          setupNotesSync(); // Setup notebook sync
        } else {
          googleSignInBtn.classList.remove('hidden'); googleSignOutBtn.classList.add('hidden');
          googleAvatar.classList.add('hidden'); googleAvatar.src = ''; googleUserName.textContent = '';
          items = []; render();
          if (notesUnsubscribe) { notesUnsubscribe(); notesUnsubscribe = null; } // Cleanup notes sync
        }
      });
    }

    // Firestore sync
    function setupFirestoreSync() {
      if (!userId) { items=[]; render(); return; }
      if (unsubscribe) unsubscribe();
      const userCollection = collection(db, 'users', userId, 'reminders');
      const qSnap = query(userCollection, orderBy('updatedAt', 'desc'));
      unsubscribe = onSnapshot(qSnap, (snapshot) => {
        const remoteItems = [];
        snapshot.forEach((d) => {
          const data = d.data();
          remoteItems.push({
            id: d.id,
            title: data.title, priority: data.priority, notes: data.notes || '', done: !!data.done,
            due: data.due || null,
            createdAt: data.createdAt?.toMillis?.() || 0,
            updatedAt: data.updatedAt?.toMillis?.() || 0
          });
        });
        items = remoteItems;
        render();
      }, (error) => {
        console.error('Firestore sync error:', error);
        syncStatus.textContent = 'Sync Error'; syncStatus.className = 'sync-status error';
      });
    }

    // Save/Delete
    async function saveToFirebase(item) {
      if (!userId) return;
      try {
        await setDoc(doc(db, 'users', userId, 'reminders', item.id), {
          title: item.title, priority: item.priority, notes: item.notes || '', done: !!item.done, due: item.due || null,
          createdAt: item.createdAt ? new Date(item.createdAt) : serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });
      } catch (error) {
        console.error('Save failed:', error); toast('Save queued (offline)');
      }
    }
    async function deleteFromFirebase(id) { if (!userId) return; try { await deleteDoc(doc(db, 'users', userId, 'reminders', id)); } catch { toast('Delete queued (offline)'); } }

    // Optional: Calendar/Sheet sync via Apps Script
    async function tryCalendarSync(task) {
      const url = (localStorage.getItem('syncUrl') || '').trim(); if (!url) return;
      const payload = { id: task.id, title: task.title, dueIso: task.due || null, priority: task.priority || 'Medium', done: !!task.done, source: 'memory-cue-mobile' };
      try { await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); }
      catch {}
    }

    // Utils
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function toISODatePart(d){ return formatDateLocal(d); }
    function todayISO(){ const now = new Date(); return formatDateLocal(now); }
    function startOfWeek(dateObj){ const d = new Date(dateObj); const day = (d.getDay() + 6) % 7; d.setDate(d.getDate() - day);d.setHours(0,0,0,0); return d; }
    function endOfWeek(dateObj){ const s = startOfWeek(dateObj); const e = new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
    function priorityWeight(p){ return p==='High'?3 : p==='Medium'?2 : 1; }
    function smartCompare(a,b){ const pr = priorityWeight(b.priority)-priorityWeight(a.priority); if(pr) return pr; const at=+new Date(a.due||0), bt=+new Date(b.due||0); if(at!==bt) return at-bt; return (a.updatedAt||0)>(b.updatedAt||0)?-1:1; }
    function fmtDayDate(iso){ if(!iso) return '—'; try{ const d = new Date(iso+'T00:00:00'); return dayFmt.format(d); }catch{ return iso; } }
    function fmtTime(d){ return timeFmt.format(d); }
    function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;' }[c])); }
    function toast(msg){ statusEl.textContent = msg; clearTimeout(toast._t); toast._t = setTimeout(()=> statusEl.textContent='', 2500); }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    function parseQuickWhen(text) {
      text = String(text || '').toLowerCase();

      // Default = today, no time
      let when = { date: todayISO(), time: '' };

      // Helper function to get next occurrence of a day
      const getNextDayOfWeek = (dayIndex) => {
        const today = new Date();
        const currentDay = today.getDay();
        const daysUntilTarget = (dayIndex - currentDay + 7) % 7;
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + (daysUntilTarget === 0 ? 7 : daysUntilTarget));
        return targetDate;
      };

      // Helper function to get this occurrence of a day
      const getThisDayOfWeek = (dayIndex) => {
        const today = new Date();
        const currentDay = today.getDay();
        const daysUntilTarget = (dayIndex - currentDay + 7) % 7;
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + daysUntilTarget);
        return targetDate;
      };

      // Day names mapping
      const dayNames = {
        'sunday': 0, 'sun': 0,
        'monday': 1, 'mon': 1,
        'tuesday': 2, 'tue': 2, 'tues': 2,
        'wednesday': 3, 'wed': 3,
        'thursday': 4, 'thu': 4, 'thur': 4, 'thurs': 4,
        'friday': 5, 'fri': 5,
        'saturday': 6, 'sat': 6
      };

      // Month names mapping
      const monthNames = {
        'january': 0, 'jan': 0,
        'february': 1, 'feb': 1,
        'march': 2, 'mar': 2,
        'april': 3, 'apr': 3,
        'may': 4,
        'june': 5, 'jun': 5,
        'july': 6, 'jul': 6,
        'august': 7, 'aug': 7,
        'september': 8, 'sep': 8, 'sept': 8,
        'october': 9, 'oct': 9,
        'november': 10, 'nov': 10,
        'december': 11, 'dec': 11
      };

      // Detect "tomorrow"
      if (/\btomorrow\b/.test(text)) {
        const d = new Date();
        d.setDate(d.getDate() + 1);
        when.date = formatDateLocal(d);
      }
      // Detect "today"
      else if (/\btoday\b/.test(text)) {
        when.date = todayISO();
      }
      // Detect "next [day]"
      else if (/\bnext\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\bnext\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getNextDayOfWeek(dayIndex);
        when.date = formatDateLocal(targetDate);
      }
      // Detect "this [day]"
      else if (/\bthis\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\bthis\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getThisDayOfWeek(dayIndex);
        when.date = formatDateLocal(targetDate);
      }
      // Detect standalone day names (assume next occurrence)
      else if (/\b(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\b(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getNextDayOfWeek(dayIndex);
        when.date = formatDateLocal(targetDate);
      }
      // Detect "in X days"
      else if (/\bin\s+(\d+)\s+days?\b/.test(text)) {
        const match = text.match(/\bin\s+(\d+)\s+days?\b/);
        const days = parseInt(match[1], 10);
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + days);
        when.date = formatDateLocal(targetDate);
      }
      // Detect "this weekend" (assume Saturday)
      else if (/\bthis\s+weekend\b/.test(text)) {
        const targetDate = getThisDayOfWeek(6); // Saturday
        when.date = formatDateLocal(targetDate);
      }
      else if (/\bnext\s+weekend\b/.test(text)) {
        const targetDate = getNextDayOfWeek(6); // Saturday
        when.date = formatDateLocal(targetDate);
      }
      // Detect "next week"
      else if (/\bnext\s+week\b/.test(text)) {
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + 7);
        when.date = formatDateLocal(targetDate);
      }
      // Detect specific dates like "september 15" or "sep 15"
      else if (/\b(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)\s+(\d{1,2})(st|nd|rd|th)?\b/.test(text)) {
        const match = text.match(/\b(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)\s+(\d{1,2})(st|nd|rd|th)?\b/);
        const monthIndex = monthNames[match[1]];
        const day = parseInt(match[2], 10);
        const targetDate = new Date();
        targetDate.setMonth(monthIndex, day);
        // If the date has passed this year, assume next year
        if (targetDate < new Date()) {
          targetDate.setFullYear(targetDate.getFullYear() + 1);
        }
        when.date = formatDateLocal(targetDate);
      }
      // Detect date formats like "15/09" or "09/15" or "15/09/2025"
      else if (/\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/.test(text)) {
        const match = text.match(/\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/);
        const first = parseInt(match[1], 10);
        const second = parseInt(match[2], 10);
        let year = match[3] ? parseInt(match[3], 10) : new Date().getFullYear();

        // Handle 2-digit years
        if (year < 100) {
          year += year < 50 ? 2000 : 1900;
        }

        // Assume DD/MM format (common in AU)
        if (first <= 12 && second <= 12) {
          // If both could be month or day, prefer DD/MM format
          const targetDate = new Date(year, second - 1, first);
          when.date = formatDateLocal(targetDate);
        } else if (first <= 31 && second <= 12) {
          // DD/MM format
          const targetDate = new Date(year, second - 1, first);
          when.date = formatDateLocal(targetDate);
        } else if (first <= 12 && second <= 31) {
          // MM/DD format
          const targetDate = new Date(year, first - 1, second);
          when.date = formatDateLocal(targetDate);
        }
      }

      // hh:mm (24h)
      let m = text.match(/\b(\d{1,2}):(\d{2})\b/);
      if (m) {
        const hh = String(parseInt(m[1], 10)).padStart(2, '0');
        const mm = String(parseInt(m[2], 10)).padStart(2, '0');
        when.time = `${hh}:${mm}`;
        return when;
      }

      // h am/pm
      m = text.match(/\b(\d{1,2})\s*(am|pm)\b/);
      if (m) {
        let h = parseInt(m[1], 10) % 12;
        if (m[2] == 'pm') h += 12;
        when.time = `${String(h).padStart(2, '0')}:00`;
        return when;
      }

      // compact 3–4 digit time like "630" or "0930"
      m = text.match(/\b(\d{3,4})\b/);
      if (m) {
        const digits = m[1];
        let hh, mm;
        if (digits.length == 3) {
          hh = '0' + digits[0];
          mm = digits.slice(1);
        } else {
          hh = digits.slice(0, 2);
          mm = digits.slice(2);
        }
        hh = String(parseInt(hh, 10)).padStart(2, '0');
        mm = String(parseInt(mm, 10)).padStart(2, '0');
        when.time = `${hh}:${mm}`;
      }

      return when;
    }


    function isoToLocalDate(iso){
      try {
        const d = new Date(iso);
        const parts = datePartsFmt.formatToParts(d);
        const y = parts.find(p=>p.type==='year')?.value || '0000';
        const m = parts.find(p=>p.type==='month')?.value || '01';
        const da = parts.find(p=>p.type==='day')?.value || '01';
        return `${y}-${m}-${da}`;
      } catch { return ''; }
    }
    function isoToLocalTime(iso){
      try {
        const d = new Date(iso);
        const parts = timePartsFmt.formatToParts(d);
        const h = parts.find(p=>p.type==='hour')?.value?.padStart(2,'0') || '00';
        const m = parts.find(p=>p.type==='minute')?.value?.padStart(2,'0') || '00';
        return `${h}:${m}`;
      } catch { return ''; }
    }

    function resetForm(){
      title.value = ''; date.value = ''; time.value=''; priority.value='Medium';
      editingId = null;
      saveBtn.textContent = 'Save Reminder';
      cancelEditBtn.classList.add('hidden');
    }

    function loadForEdit(id){
      const it = items.find(x => x.id === id);
      if (!it) return;
      title.value = it.title || '';
      if (it.due){
        date.value = isoToLocalDate(it.due);
        time.value = isoToLocalTime(it.due);
      } else {
        date.value = ''; time.value = '';
      }
      priority.value = it.priority || 'Medium';
      editingId = id;
      saveBtn.textContent = 'Update Reminder';
      cancelEditBtn.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      title.focus();
    }

    // Create & basic actions
    function addItem(obj){
      if (!userId) { toast('Sign in to add reminders'); return; }
      const nowMs = Date.now();
      const item = {
        id: uid(), title: obj.title.trim(), priority: obj.priority || 'Medium', notes: obj.notes || '', done: false,
        createdAt: nowMs, updatedAt: nowMs, due: obj.due || null
      };
      items = [item, ...items]; render(); saveToFirebase(item);
      tryCalendarSync(item);
      return item;
    }
    function toggleDone(id){ const it = items.find(x=>x.id===id); if(!it) return; it.done=!it.done; it.updatedAt=Date.now(); saveToFirebase(it); tryCalendarSync(it); render(); }
    function removeItem(id){ items = items.filter(x=>x.id!==id); render(); deleteFromFirebase(id); }

    // Rendering
    function render(){
      // Update inline counters first
      const now = new Date();
      const adlNow = new Date(now.toLocaleString('en-US', { timeZone: TZ }));
      const t0 = new Date(adlNow); t0.setHours(0,0,0,0);
      const t1 = new Date(adlNow); t1.setHours(23,59,59,999);
      const w0 = startOfWeek(adlNow);
      const w1 = endOfWeek(adlNow);
      const todays = items.filter(x => x.due && new Date(x.due) >= t0 && new Date(x.due) <= t1 && !x.done);
      const weeks  = items.filter(x => x.due && new Date(x.due) >= w0 && new Date(x.due) <= w1 && !x.done);
      inlineTodayCount.textContent = String(todays.length);
      inlineWeekCount.textContent = String(weeks.length);

      // Now render list
      const queryStr = q.value.trim().toLowerCase();
      let rows = items.slice();
      if (queryStr){ rows = rows.filter(r => r.title.toLowerCase().includes(queryStr) || (r.notes||'').toLowerCase().includes(queryStr)); }
      rows = rows.filter(r => {
        if (filter==='done') return r.done;
        if (filter==='overdue') return !r.done && r.due && new Date(r.due) < adlNow;
        if (filter==='today'){
          if (!r.due) return true;
          const dueAdl = new Date(new Date(r.due).toLocaleString('en-US', { timeZone: TZ }));
          return dueAdl >= t0 && dueAdl <= t1;
        }
        return true;
      });

      rows.sort((a,b)=>{
        if (sortKey==='time') return (+new Date(a.due||0)) - (+new Date(b.due||0));
        if (sortKey==='priority') return priorityWeight(b.priority) - priorityWeight(a.priority);
        return smartCompare(a,b);
      });
      $$('button[data-filter]').forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-filter')===filter));
      const frag = document.createDocumentFragment();
      if (rows.length===0){ list.innerHTML = '<div class="text-muted">No reminders found.</div>'; return; }
      list.replaceChildren();
      rows.forEach(r => {
        const div = document.createElement('div');
        div.className = 'task-item' + (r.done ? ' completed' : '');
        const dueTxt = r.due ? `${fmtTime(new Date(r.due))} • ${fmtDayDate(r.due.slice(0,10))}` : 'No due date';
        const priorityClass = `priority-${r.priority.toLowerCase()}`;
        div.innerHTML = `
          <input type="checkbox" ${r.done ? 'checked' : ''} aria-label="Mark complete" />
          <div class="task-content">
            <div class="task-title">${escapeHtml(r.title)}</div>
            <div class="task-meta">
              <div class="task-meta-row">
                <span>${dueTxt}</span>
                <span class="priority-badge ${priorityClass}">${r.priority}</span>
              </div>
            </div>
          </div>
          <div class="task-actions">
            <button class="btn-ghost" data-edit type="button">Edit</button>
            <button class="btn-ghost" data-del type="button">Del</button>
          </div>`;
        div.querySelector('input').addEventListener('change', () => toggleDone(r.id));
        div.querySelector('[data-edit]').addEventListener('click', () => loadForEdit(r.id));
        div.querySelector('[data-del]').addEventListener('click', () => removeItem(r.id));
        frag.appendChild(div);
      });
      list.appendChild(frag);
    }

    // Menu toggle
    function closeMenu(){ moreBtn?.setAttribute('aria-expanded','false'); moreMenu?.classList.add('hidden'); }
    function openMenu(){ moreBtn?.setAttribute('aria-expanded','true'); moreMenu?.classList.remove('hidden'); }
    moreBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); const open = moreBtn.getAttribute('aria-expanded')==='true';open ? closeMenu() : openMenu(); });
    document.addEventListener('click', (e)=>{ if (!moreMenu?.classList.contains('hidden')) { if (!moreMenu.contains(e.target) && e.target !== moreBtn) closeMenu(); } });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeMenu(); });

    // Settings toggle + force hidden on load + Esc hides
    openSettings.addEventListener('click', () => {
      const willShow = settingsSection.classList.contains('hidden');
      settingsSection.classList.toggle('hidden');
      if (willShow) { settingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
      closeMenu();
    });
    document.addEventListener('DOMContentLoaded', () => { settingsSection.classList.add('hidden'); });

    // Save/create or update
    saveBtn.addEventListener('click', () => {
      // Create new OR update existing depending on editingId
      if (editingId) {
        const it = items.find(x=>x.id===editingId);
        if (!it) { resetForm(); return; }
        const tNew = title.value.trim(); if (!tNew) { toast('Add a reminder title'); return; }
        let due = null;
        if (date.value || time.value) {
          const d = (date.value || todayISO()); const tm = (time.value || '09:00');
          due = localDateTimeToISO(d, tm);
        } else {
          const p = parseQuickWhen(tNew); if (p.time) { due = new Date(`${p.date}T${p.time}:00`).toISOString(); }
        }
        it.title = tNew; it.priority = priority.value; it.due = due; it.updatedAt = Date.now();
        saveToFirebase(it); tryCalendarSync(it); render(); resetForm(); toast('Reminder updated');
        return;
      }

      const t = title.value.trim(); if (!t) { toast('Add a reminder title'); return; }
      let due = null;
      if (date.value || time.value) { const d = (date.value || todayISO()); const tm = (time.value || '09:00'); due = localDateTimeToISO(d, tm); }
      else { const p = parseQuickWhen(t); if (p.time) { due = new Date(`${p.date}T${p.time}:00`).toISOString(); } }
      addItem({ title: t, priority: priority.value, due });
      title.value = ''; time.value = '';
    });
    title.addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveBtn.click(); });

    // Add real-time date feedback
    function updateDateFeedback() {
      const text = title.value.trim();
      if (!text) {
        dateFeedback.style.display = 'none';
        return;
      }

      try {
        const parsed = parseQuickWhen(text);
        const today = todayISO();

        if (parsed.date !== today || parsed.time) {
          let feedback = '';

          if (parsed.date !== today) {
            const dateObj = new Date(parsed.date + 'T00:00:00');
            feedback += `📅 ${fmtDayDate(parsed.date)}`;
          }

          if (parsed.time) {
            feedback += `${feedback ? ' ' : ''}🕐 ${parsed.time}`;
          }

          if (feedback) {
            dateFeedback.textContent = `Parsed: ${feedback}`;
            dateFeedback.style.display = 'block';
          } else {
            dateFeedback.style.display = 'none';
          }
        } else {
          dateFeedback.style.display = 'none';
        }
      } catch (e) {
        dateFeedback.style.display = 'none';
      }
    }

    title.addEventListener('input', debounce(updateDateFeedback, 300));
    cancelEditBtn?.addEventListener('click', () => { resetForm(); toast('Edit cancelled'); });
    window.addEventListener('load', ()=> title.focus());
    addQuickBtn.addEventListener('click', () => { if (!title.value.trim()) { title.focus(); toast('Type something like "email parents at 4pm"'); return; } saveBtn.click(); });
    q.addEventListener('input', debounce(render, 150));
    sortSel.addEventListener('change', () => { sortKey = sortSel.value; render(); });
    $$('button[data-filter]').forEach(b => b.addEventListener('click', () => { filter = b.getAttribute('data-filter'); render(); }));

    copyMtlBtn.addEventListener('click', () => {
      const lines = items.filter(x => !x.done).map(x => {
        const datePart = x.due ? fmtDayDate(x.due.slice(0, 10)) : '';
        const timePart = x.due ? new Date(x.due).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' }) : '';
        const pieces = [ 'mtl ' + x.title, x.due ? `Due Date: ${datePart}` : '', x.due ? `Time: ${timePart}` : '', `Status: Not started` ].filter(Boolean);
        return pieces.join('\n');
      });
      if (lines.length === 0) { toast('No active tasks to copy'); return; }
      navigator.clipboard.writeText(lines.join('\n\n')).then(() => toast('Copied for Master Task List')).catch(() => toast('Copy failed'));
      closeMenu();
    });
    importFile.addEventListener('change', () => {
      const f = importFile.files[0]; if (!f) return;
      const rd = new FileReader();
      rd.onload = () => {
        try {
          const importedItems = JSON.parse(String(rd.result) || '[]').slice(0, 500);
          importedItems.forEach(item => { item.id = (Math.random().toString(36).slice(2)+Date.now().toString(36)); items = [item, ...items]; saveToFirebase(item); });
          render(); toast('Import successful');
        } catch { toast('Invalid JSON'); }
      };
      rd.readAsText(f); importFile.value = '';
      closeMenu();
    });
    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'memory-cue-mobile.json'; a.click(); URL.revokeObjectURL(url);
      closeMenu();
    });

    // Sync All Now -> POST everything in batches
    syncAllBtn?.addEventListener('click', async () => {
      const url = (localStorage.getItem('syncUrl') || '').trim();
      if (!url) { toast('Add your Apps Script URL in Settings first'); closeMenu(); return; }
      if (!items.length) { toast('No tasks to sync'); closeMenu(); return; }

      toast('Syncing all tasks…');
      const chunkSize = 20;
      let fail = 0;
      for (let i = 0; i < items.length; i += chunkSize) {
        const chunk = items.slice(i, i + chunkSize);
        const results = await Promise.allSettled(chunk.map(task => {
          const payload = {
            id: task.id,
            title: task.title,
            dueIso: task.due || null,
            priority: task.priority || 'Medium',
            done: !!task.done,
            source: 'memory-cue-mobile'
          };
          return fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        }));
        fail += results.filter(r => r.status === 'rejected').length;
        await new Promise(res => setTimeout(res, 400));
      }
      toast(`Sync complete: ${items.length - fail} ok${fail ? `, ${fail} failed` : ''}`);
      closeMenu();
    });

    // Voice + Notifications
    try {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SR) {
        recog = new SR();
        recog.lang = 'en-AU';
        recog.interimResults = false;
        recog.onresult = (e) => { const t = e.results[0][0].transcript || ''; title.value = t; toast('Heard: ' + t); };
        recog.onend = () => { listening = false; voiceBtn.textContent = '🎙️'; };
      }
    } catch {}
    voiceBtn.addEventListener('click', () => {
      if (!recog) return;
      if (!listening) { try { recog.start(); listening = true; voiceBtn.textContent = '👂'; } catch {} }
      else { try { recog.stop(); } catch {} listening = false; voiceBtn.textContent = '🎙️'; }
    });
    notifBtn.addEventListener('click', async () => {
      if (!('Notification' in window)) { toast('Notifications not supported'); return; }
      if (Notification.permission === 'granted') { toast('Notifications enabled'); return; }
      const perm = await Notification.requestPermission(); toast(perm === 'granted' ? 'Notifications enabled' : 'Notifications blocked');
    });

    // PWA scaffold
    (function setupPWA(){
      const manifest = { name:'Memory Cue', short_name:'MemoryCue', start_url:'.', display:'standalone', background_color:'#0b1220', theme_color:'#0b1220' };
      const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      document.getElementById('manifestLink').setAttribute('href', url);
      if ('serviceWorker' in navigator) {
        const swCode = `self.addEventListener('install', e=>self.skipWaiting()); self.addEventListener('activate', e=>self.clients.claim());`;
        const swBlob = new Blob([swCode], { type: 'text/javascript' });
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).catch(()=>{});
      }
    })();

    // Initial render
    render();
  </script>
</body>
</html>
