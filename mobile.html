<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memory Cue (Mobile)</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#38bdf8; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    html,body{height:100%;}
    body{
      margin:0;
      background:linear-gradient(180deg,#0b1220 0%,#0a0f1c 100%);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji");
    }
    .wrap{max-width:420px;margin:0 auto;padding:10px;}
    header{position:sticky;top:0;background:rgba(10,15,28,.7);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937;z-index:10}
    h1{font-size:22px;margin:0;padding:9px 0;font-weight:700;letter-spacing:.2px}
    .row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{
      color:var(--text);background:#0f172a;border:1px solid #22304a;border-radius:12px;padding:8px 10px;font-size:15px
    }
    input::placeholder,textarea::placeholder{color:#64748b}
    button{cursor:pointer}
    button.primary{background:var(--accent);border-color:#1e7aa2;color:#001018;font-weight:700}
    button.good{background:var(--ok);border-color:#157a3a;color:#001108;font-weight:700}
    button.warn{background:var(--warn);border-color:#7a5a0f;color:#1b1200;font-weight:700}
    button.ghost{background:#0f172a;border-color:#22304a}
    .panel{background:var(--panel);border:1px solid #22304a;border-radius:14px;padding:10px}
    .list{display:grid;gap:7px}
    .item{display:grid;grid-template-columns:auto 1fr auto;gap:7px;align-items:center;padding:8px;border:1px solid #20314b;border-radius:12px;background:#0c1426}
    .item.done .title{text-decoration:line-through;color:#93a3b8}
    .title{font-weight:600}
    .meta{font-size:12px;color:var(--muted)}
    .badge{font-size:11px;padding:3px 7px;border-radius:999px;border:1px solid #2b3b58;background:#0f1a32}
    .section-title{margin:6px 0 0;font-size:13px;color:#a8b2c2;text-transform:uppercase;letter-spacing:.12em}
    .footer{color:#8aa0b8;font-size:12px;text-align:center;margin:12px 0}
    .sr-only{position:absolute;height:1px;width:1px;clip:rect(1px,1px,1px,1px);overflow:hidden;white-space:nowrap}
    .hidden { display: none; }
    .sync-status{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600}
    .sync-status.online{background:var(--ok);color:#001108}
    .sync-status.offline{background:var(--warn);color:#1b1200}
    .sync-status.error{background:var(--danger);color:#fff}
    .google-avatar{width:22px;height:22px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:4px;}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h1>Memory Cue</h1>
        <div id="syncStatus" class="sync-status offline">Offline</div>
      </div>
      <div class="row" style="padding-bottom:10px">
        <input id="q" placeholder="Search reminders or #tags" style="flex:1" />
        <button id="voiceBtn" class="ghost" type="button" title="Voice quick add">üéôÔ∏è</button>
        <button id="notifBtn" class="ghost" type="button" title="Enable notifications">üîî</button>
        <button id="addQuickBtn" class="primary" type="button" title="Add quick reminder">+</button>
        <!-- Google Auth buttons -->
        <button id="googleSignInBtn" class="ghost" type="button">Sign in with Google</button>
        <button id="googleSignOutBtn" class="ghost hidden" type="button"><img id="googleAvatar" class="google-avatar hidden" />Sign out</button>
        <span id="googleUserName" class="meta"></span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="row" style="gap:7px;align-items:flex-end">
        <div style="flex:1">
          <label class="sr-only" for="title">Reminder</label>
          <input id="title" placeholder="e.g., Pick up dog at 6pm #home" />
        </div>
        <div>
          <label class="sr-only" for="date">Date</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label class="sr-only" for="time">Time</label>
          <input id="time" type="time" />
        </div>
        <div>
          <select id="priority">
            <option>High</option>
            <option selected>Medium</option>
            <option>Low</option>
          </select>
        </div>
        <button id="saveBtn" class="good" type="button">Save</button>
      </div>
      <div class="row" style="margin-top:7px">
        <button id="copyMtlBtn" class="ghost" type="button">Copy MTL</button>
        <label class="ghost" style="display:inline-flex;align-items:center;gap:7px;padding:7px 10px">
          Import <input id="importFile" type="file" accept="application/json" style="display:none" />
        </label>
        <button id="exportBtn" class="ghost" type="button">Export</button>
        <button id="openSettings" class="ghost" type="button" title="Open settings">‚öôÔ∏è</button>
        <span id="status" class="meta"></span>
      </div>
    </section>

    <section class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:7px">
          <button class="ghost" data-filter="today" type="button">Today</button>
          <button class="ghost" data-filter="overdue" type="button">Overdue</button>
          <button class="ghost" data-filter="all" type="button">All</button>
          <button class="ghost" data-filter="done" type="button">Done</button>
        </div>
        <div>
          <select id="sort">
            <option value="smart">Smart sort</option>
            <option value="time">Time</option>
            <option value="priority">Priority</option>
          </select>
        </div>
      </div>
      <div class="section-title">Reminders</div>
      <div id="list" class="list" aria-live="polite">
        <div class="meta">Loading...</div>
      </div>
    </section>

    <section class="panel hidden" id="settingsSection">
      <div class="section-title">Calendar Sync Settings</div>
      <div class="row" style="gap:7px;align-items:flex-end">
        <input id="syncUrl" placeholder="https://script.google.com/macros/s/AKfycb.../exec" style="flex:1" />
        <button id="saveSettings" class="good" type="button">Save</button>
        <button id="testSync" class="ghost" type="button">Test</button>
      </div>
      <div class="meta" style="margin-top:7px">
        Tip: In Google Apps Script, click <b>Deploy ‚Üí New deployment ‚Üí Web app</b>,
        set <b>Execute as: Me</b>, <b>Who has access: Anyone with the link</b>, then copy the URL (ends with <code>/exec</code>).
      </div>
    </section>
  </main>

  <div class="wrap footer">
    Mobile. Voice works best in Chrome. Multi-device sync via Firebase + Calendar sync via Google Apps Script.
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
    import { GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAmAMiz0zG3dAhZJhOy1DYj8fKVDObL36c",
      authDomain: "memory-cue-app.firebaseapp.com",
      projectId: "memory-cue-app",
      storageBucket: "memory-cue-app.firebasestorage.app",
      messagingSenderId: "751284466633",
      appId: "1:751284466633:web:3b10742970bef1a5d5ee18",
      measurementId: "G-R0V4M7VCE6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let items = [];
    let filter = 'today';
    let sortKey = 'smart';
    let listening = false;
    let recog = null;
    let userId = null;
    let unsubscribe = null;
    let currentUser = null;

    const TZ = 'Australia/Adelaide';
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // DOM
    const q = $('#q');
    const title = $('#title');
    const date = $('#date');
    const time = $('#time');
    const priority = $('#priority');
    const saveBtn = $('#saveBtn');
    const list = $('#list');
    const statusEl = $('#status');
    const voiceBtn = $('#voiceBtn');
    const notifBtn = $('#notifBtn');
    const addQuickBtn = $('#addQuickBtn');
    const copyMtlBtn = $('#copyMtlBtn');
    const importFile = $('#importFile');
    const exportBtn = $('#exportBtn');
    const sortSel = $('#sort');
    const syncStatus = $('#syncStatus');
    const openSettings = $('#openSettings');
    const syncUrlInput = $('#syncUrl');
    const saveSettings = $('#saveSettings');
    const testSync = $('#testSync');
    const settingsSection = $('#settingsSection');
    const googleSignInBtn = $('#googleSignInBtn');
    const googleSignOutBtn = $('#googleSignOutBtn');
    const googleAvatar = $('#googleAvatar');
    const googleUserName = $('#googleUserName');

    // Restore saved Sync URL
    const savedSyncUrl = localStorage.getItem('syncUrl') || '';
    if (savedSyncUrl) syncUrlInput.value = savedSyncUrl;

    // Google Auth
    googleSignInBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        toast('Google sign-in failed');
        console.error(error);
      }
    });

    googleSignOutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        toast('Signed out');
        items = [];
        render();
      } catch (error) {
        toast('Sign-out failed');
        console.error(error);
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        currentUser = user;
        syncStatus.textContent = 'Online';
        syncStatus.className = 'sync-status online';
        googleSignInBtn.classList.add('hidden');
        googleSignOutBtn.classList.remove('hidden');
        if (user.photoURL) {
          googleAvatar.classList.remove('hidden');
          googleAvatar.src = user.photoURL;
        } else {
          googleAvatar.classList.add('hidden');
          googleAvatar.src = '';
        }
        if (user.displayName) {
          googleUserName.textContent = `Hello, ${user.displayName}`;
        } else if (user.email) {
          googleUserName.textContent = user.email;
        } else {
          googleUserName.textContent = '';
        }
        setupFirestoreSync();
      } else {
        googleSignInBtn.classList.remove('hidden');
        googleSignOutBtn.classList.add('hidden');
        googleAvatar.classList.add('hidden');
        googleAvatar.src = '';
        googleUserName.textContent = '';
        items = [];
        render();
      }
    });

    function setupFirestoreSync() {
      if (!userId) {
        items = [];
        render();
        return;
      }
      if (unsubscribe) unsubscribe();
      const userCollection = collection(db, 'users', userId, 'reminders');
      const qSnap = query(userCollection, orderBy('updatedAt', 'desc'));

      unsubscribe = onSnapshot(qSnap, (snapshot) => {
        const remoteItems = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          remoteItems.push({
            id: doc.id,
            title: data.title,
            priority: data.priority,
            notes: data.notes || '',
            done: data.done,
            due: data.due,
            createdAt: data.createdAt,
            updatedAt: data.updatedAt
          });
        });

        items = mergeWithLocal(remoteItems);
        render();
      }, (error) => {
        console.error('Firestore sync error:', error);
        syncStatus.textContent = 'Sync Error';
        syncStatus.className = 'sync-status error';
      });
    }

    function mergeWithLocal(remoteItems) {
      const localPending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const merged = new Map();

      remoteItems.forEach(item => merged.set(item.id, item));
      localPending.forEach(change => {
        if (change.action === 'upsert') {
          merged.set(change.item.id, change.item);
        } else if (change.action === 'delete') {
          merged.delete(change.itemId);
        }
      });

      return Array.from(merged.values());
    }

    async function saveToFirebase(item) {
      if (!userId) return;
      try {
        await setDoc(doc(db, 'users', userId, 'reminders', item.id), {
          title: item.title,
          priority: item.priority,
          notes: item.notes,
          done: item.done,
          due: item.due,
          createdAt: item.createdAt,
          updatedAt: item.updatedAt
        });
        removePendingChange(item.id);
      } catch (error) {
        console.error('Save failed:', error);
        addPendingChange({ action: 'upsert', item });
        syncStatus.textContent = 'Sync Pending';
        syncStatus.className = 'sync-status offline';
      }
    }

    async function deleteFromFirebase(id) {
      if (!userId) return;
      try {
        await deleteDoc(doc(db, 'users', userId, 'reminders', id));
        removePendingChange(id);
      } catch (error) {
        console.error('Delete failed:', error);
        addPendingChange({ action: 'delete', itemId: id });
      }
    }

    function addPendingChange(change) {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const filtered = pending.filter(p => 
        (p.action === 'upsert' && p.item.id !== (change.item?.id || change.itemId)) ||
        (p.action === 'delete' && p.itemId !== (change.item?.id || change.itemId))
      );
      filtered.push(change);
      localStorage.setItem('pendingChanges', JSON.stringify(filtered));
    }

    function removePendingChange(itemId) {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      const filtered = pending.filter(p => 
        (p.action === 'upsert' && p.item.id !== itemId) ||
        (p.action === 'delete' && p.itemId !== itemId)
      );
      localStorage.setItem('pendingChanges', JSON.stringify(filtered));
    }

    async function retryPendingChanges() {
      const pending = JSON.parse(localStorage.getItem('pendingChanges') || '[]');
      for (const change of pending) {
        try {
          if (change.action === 'upsert') {
            await saveToFirebase(change.item);
          } else if (change.action === 'delete') {
            await deleteFromFirebase(change.itemId);
          }
        } catch (error) {
          break;
        }
      }
    }

    async function tryCalendarSync(task) {
      const url = (localStorage.getItem('syncUrl') || '').trim();
      if (!url) return;
      const payload = { 
        title: task.title, 
        dueIso: task.due || null, 
        priority: task.priority || 'Medium' 
      };
      try {
        await fetch(url, { 
          method: 'POST', 
          headers: { 'Content-Type': 'text/plain' }, 
          body: JSON.stringify(payload) 
        });
        toast('Synced to Calendar');
      } catch (e) { 
        toast('Calendar sync failed (offline?)'); 
      }
    }

    function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function toISODatePart(d) { return d.toISOString().slice(0, 10); }
    function todayISO() {
      const now = new Date();
      const adelaideDate = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
      return toISODatePart(adelaideDate);
    }
    function priorityWeight(p) { return p === 'High' ? 3 : p === 'Medium' ? 2 : 1; }
    function smartCompare(a, b) {
      const pr = priorityWeight(b.priority) - priorityWeight(a.priority); if (pr) return pr;
      const at = +new Date(a.due || 0), bt = +new Date(b.due || 0); if (at !== bt) return at - bt;
      return (a.updatedAt || 0) > (b.updatedAt || 0) ? -1 : 1;
    }
    function fmtDayDate(iso) {
      if (!iso) return '‚Äî';
      try {
        const d = new Date(iso + 'T00:00:00');
        return new Intl.DateTimeFormat('en-AU', { timeZone: TZ, weekday: 'long', day: 'numeric', month: 'long' }).format(d);
      } catch { return iso; }
    }
    function parseQuickWhen(text) {
      text = text.toLowerCase();
      let when = { date: todayISO(), time: '' };
      if (/tomorrow/.test(text)) {
        const d = new Date(); d.setDate(d.getDate() + 1); when.date = toISODatePart(d);
      }
      const mHm = text.match(/\b(\d{1,2}):(\d{2})\b/);
      const m12 = text.match(/\b(\d{1,2})\s*(am|pm)\b/);
      if (mHm) { when.time = `${String(mHm[1]).padStart(2, '0')}:${mHm[2]}`; }
      else if (m12) {
        let h = parseInt(m12[1], 10) % 12; if (m12[2] === 'pm') h += 12; when.time = `${String(h).padStart(2, '0')}:00`;
      }
      return when;
    }

    function addItem(obj) {
      if (!userId) { toast('Sign in to add reminders'); return; }
      const item = {
        id: uid(),
        title: obj.title.trim(),
        priority: obj.priority || 'Medium',
        notes: obj.notes || '',
        done: false,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        due: obj.due || null
      };

      items = [item, ...items];
      render();

      saveToFirebase(item);
      tryCalendarSync(item);
      return item;
    }

    function toggleDone(id) {
      const item = items.find(x => x.id === id);
      if (item) {
        item.done = !item.done;
        item.updatedAt = Date.now();
        render();
        saveToFirebase(item);
      }
    }

    function removeItem(id) {
      items = items.filter(x => x.id !== id);
      render();
      deleteFromFirebase(id);
    }

    function render() {
      const query = q.value.trim().toLowerCase();
      const now = new Date();
      const adelaideNow = new Date(now.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
      const todayStart = new Date(adelaideNow);
      todayStart.setHours(0, 0, 0, 0);
      const todayEnd = new Date(adelaideNow);
      todayEnd.setHours(23, 59, 59, 999);

      let rows = items.slice();
      if (query) {
        rows = rows.filter(r =>
          r.title.toLowerCase().includes(query) || (r.notes || '').toLowerCase().includes(query)
        );
      }

      rows = rows.filter(r => {
        if (filter === 'done') return r.done;
        if (filter === 'overdue') return !r.done && r.due && new Date(r.due) < adelaideNow;
        if (filter === 'today') {
          if (!r.due) return true;
          const dueDate = new Date(r.due);
          const dueDateAdelaide = new Date(dueDate.toLocaleString("en-US", {timeZone: "Australia/Adelaide"}));
          return dueDateAdelaide >= todayStart && dueDateAdelaide <= todayEnd;
        }
        return true;
      });

      rows.sort((a, b) => {
        if (sortKey === 'time') return (+new Date(a.due || 0)) - (+new Date(b.due || 0));
        if (sortKey === 'priority') return priorityWeight(b.priority) - priorityWeight(a.priority);
        return smartCompare(a, b);
      });

      list.innerHTML = '';
      if (rows.length === 0) {
        list.innerHTML = '<div class="meta">Nothing here yet.</div>';
        return;
      }

      rows.forEach(r => {
        const div = document.createElement('div');
        div.className = 'item' + (r.done ? ' done' : '');
        const dueTxt = r.due
          ? new Date(r.due).toLocaleString('en-AU', { timeZone: TZ, hour: '2-digit', minute: '2-digit' }) +
          ' ‚Ä¢ ' + fmtDayDate(r.due.slice(0, 10))
          : '‚Äî';
        div.innerHTML = `
          <input type="checkbox" ${r.done ? 'checked' : ''} aria-label="Mark done" />
          <div>
            <div class="title">${escapeHtml(r.title)}</div>
            <div class="meta">${dueTxt} ‚Ä¢ <span class="badge">${r.priority}</span> ${r.notes ? '‚Ä¢ ' + escapeHtml(r.notes) : ''}</div>
          </div>
          <div class="row">
            <button class="ghost" data-del type="button">Del</button>
          </div>`;
        div.querySelector('input').addEventListener('change', () => toggleDone(r.id));
        div.querySelector('[data-del]').addEventListener('click', () => removeItem(r.id));
        list.appendChild(div);
      });
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) =>
        ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])
      );
    }

    function toast(msg) {
      statusEl.textContent = msg; clearTimeout(toast._t);
      toast._t = setTimeout(() => statusEl.textContent = '', 3000);
    }

    saveBtn.addEventListener('click', () => {
      const t = title.value.trim(); if (!t) { toast('Add a reminder title'); return; }
      let due = null;
      if (date.value || time.value) {
        const d = (date.value || todayISO());
        const tm = (time.value || '09:00');
        due = new Date(`${d}T${tm}:00`).toISOString();
      } else {
        const p = parseQuickWhen(t);
        if (p.time) { due = new Date(`${p.date}T${p.time}:00`).toISOString(); }
      }
      addItem({ title: t, priority: priority.value, due });
      title.value = ''; time.value = '';
    });

    addQuickBtn.addEventListener('click', () => {
      if (!title.value.trim()) {
        title.focus(); toast('Type something like \"pick up dog at 6pm\"'); return;
      }
      saveBtn.click();
    });

    q.addEventListener('input', render);
    sortSel.addEventListener('change', () => { sortKey = sortSel.value; render(); });
    $$('button[data-filter]').forEach(b => b.addEventListener('click', () => {
      filter = b.getAttribute('data-filter'); render();
    }));

    copyMtlBtn.addEventListener('click', () => {
      const lines = items.filter(x => !x.done).map(x => {
        const datePart = x.due ? fmtDayDate(x.due.slice(0, 10)) : '';
        const timePart = x.due ? new Date(x.due).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' }) : '';
        const pieces = [
          'mtl ' + x.title,
          x.due ? `Due Date: ${datePart}` : '',
          x.due ? `Time: ${timePart}` : '',
          `Status: Not started`,
        ].filter(Boolean);
        return pieces.join('\n');
      });
      if (lines.length === 0) { toast('No active tasks to copy'); return; }
      navigator.clipboard.writeText(lines.join('\n\n')).then(() => {
        toast('Copied for Master Task List');
      }).catch(() => toast('Copy failed'));
    });

    importFile.addEventListener('change', () => {
      const f = importFile.files[0]; if (!f) return;
      const rd = new FileReader();
      rd.onload = () => {
        try { 
          const importedItems = JSON.parse(String(rd.result) || '[]'); 
          importedItems.forEach(item => {
            item.id = uid();
            items = [item, ...items];
            saveToFirebase(item);
          });
          render();
          toast('Import successful');
        }
        catch (err) { toast('Invalid JSON'); }
      };
      rd.readAsText(f);
      importFile.value = '';
    });

    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'memory-cue-mobile.json'; a.click();
      URL.revokeObjectURL(url);
    });

    openSettings.addEventListener('click', () => {
      if (settingsSection) {
        settingsSection.classList.remove('hidden');
        settingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });

    saveSettings.addEventListener('click', () => {
      const url = syncUrlInput.value.trim();
      localStorage.setItem('syncUrl', url);
      toast('Calendar sync settings saved');
    });

    testSync.addEventListener('click', async () => {
      const url = syncUrlInput.value.trim();
      if (!url) { toast('Enter Google Apps Script URL first'); return; }
      try {
        const r = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ title: 'Test from Memory Cue Mobile', dueIso: null, priority: 'Low' })
        });
        toast(r.ok ? 'Calendar test sent successfully' : 'Calendar sync error');
      } catch (e) { toast('Calendar sync failed (check URL & deploy)'); }
    });

    // Voice recognition
    try {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SR) {
        recog = new SR();
        recog.lang = 'en-AU';
        recog.interimResults = false;
        recog.onresult = (e) => {
          const t = e.results[0][0].transcript || '';
          title.value = t;
          toast('Heard: ' + t);
        };
        recog.onend = () => { listening = false; voiceBtn.textContent = 'üéôÔ∏è'; };
      }
    } catch { }

    voiceBtn.addEventListener('click', () => {
      if (!recog) return;
      if (!listening) { try { recog.start(); listening = true; voiceBtn.textContent = 'üëÇ'; } catch { } }
      else { try { recog.stop(); } catch { } listening = false; voiceBtn.textContent = 'üéôÔ∏è'; }
    });

    notifBtn.addEventListener('click', async () => {
      if (!('Notification' in window)) { toast('Notifications not supported'); return; }
      if (Notification.permission === 'granted') { toast('Notifications enabled'); return; }
      const perm = await Notification.requestPermission();
      toast(perm === 'granted' ? 'Notifications enabled' : 'Notifications blocked');
    });

    window.addEventListener('online', () => {
      syncStatus.textContent = 'Online';
      syncStatus.className = 'sync-status online';
      retryPendingChanges();
    });

    window.addEventListener('offline', () => {
      syncStatus.textContent = 'Offline';
      syncStatus.className = 'sync-status offline';
    });

    render();
  </script>

<script>
(function(){
  function setStatus(el, state, label){
    if (!el) return;
    el.classList.remove('online','offline','error');
    el.classList.add(state);
    el.textContent = label;
  }
  function updateNetworkBadge(){
    var el = document.getElementById('syncStatus');
    if (!el) return;
    if (navigator.onLine) {
      setStatus(el, 'online', 'Online');
    } else {
      setStatus(el, 'offline', 'Offline');
    }
  }
  window.addEventListener('online', updateNetworkBadge);
  window.addEventListener('offline', updateNetworkBadge);
  if (document.readyState !== 'loading') updateNetworkBadge();
  else document.addEventListener('DOMContentLoaded', updateNetworkBadge);

  var testBtn = document.getElementById('testSync');
  var urlInput = document.getElementById('syncUrl');
  async function pingSync(){
    var el = document.getElementById('syncStatus');
    try {
      var url = (urlInput && urlInput.value) || urlInput?.getAttribute('value') || '';
      if (!url) { updateNetworkBadge(); return; }
      const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'ping=1', { method: 'GET', cache:'no-store' });
      if (res.ok) setStatus(el, 'online', 'Online');
      else setStatus(el, 'error', 'Sync Error');
    } catch (e) {
      if (!navigator.onLine) setStatus(el, 'offline', 'Offline');
      else setStatus(el, 'error', 'Sync Error');
    }
  }
  if (testBtn) testBtn.addEventListener('click', function(e){ e.preventDefault(); pingSync(); });
  if (navigator.onLine) setTimeout(pingSync, 600);
})();
</script>

<script>
(function(){
  function getSyncUrl(){
    var el = document.getElementById('syncUrl');
    var url = (el && (el.value || el.getAttribute('value'))) ? (el.value || el.getAttribute('value')) : '';
    url = (url || '').trim();
    if (!url) throw new Error('Missing sync URL. Add your Google Apps Script Web App URL in Settings.');
    if (!/^https:\/\//i.test(url)) throw new Error('Sync URL must start with https://');
    return url;
  }
  window.__getSyncUrl = getSyncUrl;
})();
</script>

<script>
(function(){
  async function loadFromServer(opts){
    opts = opts || {};
    const maxRetries = 2;
    const backoff = [200, 600];
    const statusEl = document.getElementById('syncStatus');
    function setStatus(cls, label){
      if (!statusEl) return;
      statusEl.classList.remove('online','offline','error');
      statusEl.classList.add(cls);
      statusEl.textContent = label;
    }
    let url;
    try {
      url = (window.__getSyncUrl && window.__getSyncUrl()) || '';
    } catch(e) {
      console.warn(e.message);
      setStatus('error', 'Sync URL missing');
      return { ok:false, error:e.message };
    }

    async function attempt(i){
      try {
        const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'list=1', {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          cache: 'no-store',
          redirect: 'follow',
        });
        if (!res.ok) throw new Error('Server responded ' + res.status);
        const data = await res.json();
        setStatus('online', 'Online');
        return { ok:true, data };
      } catch (err) {
        if (i < maxRetries) {
          await new Promise(r => setTimeout(r, backoff[i]));
          return attempt(i+1);
        }
        console.error('loadFromServer failed', err);
        if (!navigator.onLine) setStatus('offline', 'Offline');
        else setStatus('error', 'Sync Error');
        return { ok:false, error: String(err && err.message || err) };
      }
    }
    return attempt(0);
  }
  window.loadFromServer = loadFromServer;
})();
</script>

</body>
</html>
