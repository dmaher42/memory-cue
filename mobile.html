<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memory Cue (Mobile) — Inline + Edit + Sync All</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="#" id="manifestLink" />
  <script>
    tailwind.config = {
      theme: { extend: { colors: { brand: '#38bdf8' } } }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style type="text/tailwindcss">
    :root { --color-brand: #38bdf8; }

    @layer components {
      body { @apply bg-gradient-to-b from-sky-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 text-slate-900 dark:text-slate-100 antialiased; }
      .container { @apply max-w-lg mx-auto px-3; }
      header { @apply sticky top-0 z-10 backdrop-blur bg-white/70 dark:bg-slate-900/70 border-b border-slate-200 dark:border-slate-700 shadow-sm; }
      .header-content { @apply py-3; }
      .header-top { @apply flex justify-between items-center mb-4; }
      h1 { @apply text-2xl font-bold bg-gradient-to-r from-slate-900 to-brand bg-clip-text text-transparent dark:from-slate-100 dark:to-brand; }
      .header-controls { @apply flex flex-wrap items-center gap-2; }
      .search-input { @apply flex-1 min-w-[160px] rounded-md border border-slate-300 dark:border-slate-600 bg-white/60 dark:bg-slate-800 px-3 py-2 text-sm placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-brand; }
      button { @apply inline-flex items-center justify-center gap-1 font-medium rounded-md transition active:scale-95; }
      .btn-primary { @apply bg-brand text-white hover:bg-brand/90; }
      .btn-ghost { @apply bg-white/60 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700; }
      .btn-compact { @apply px-2.5 py-2 text-xs; }
      .tabs { @apply flex border-b border-slate-200 dark:border-slate-700; }
      .tab-btn { @apply flex-1 py-3 text-sm font-semibold border-b-2 border-transparent; }
      .tab-btn.active { @apply text-brand border-b-brand; }
      .main-content { @apply py-4; }
      .section { @apply mb-6; }
      .card { @apply rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow; }
      .card-header { @apply p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/60; }
      .card-content { @apply p-4; }
      .card-title { @apply text-lg font-semibold; }
      .form-stack { @apply flex flex-col gap-3; }
      .form-row { @apply flex gap-2 items-end; }
      .form-group { @apply flex flex-col gap-1 flex-1; }
      .task-list { @apply flex flex-col gap-3; }
      .task-item { @apply grid grid-cols-[auto_1fr_auto] gap-3 items-start p-4 bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg transition active:scale-95; }
      .task-item.completed .task-title { @apply line-through text-slate-400; }
      .task-content { @apply min-w-0 pt-0.5; }
      .task-title { @apply text-base font-medium text-slate-900 dark:text-slate-100; }
      .task-meta { @apply flex flex-col gap-1 text-xs text-slate-500 dark:text-slate-400; }
      .task-meta-row { @apply flex gap-2 items-center flex-wrap; }
      .priority-badge { @apply px-2 py-0.5 rounded-sm text-xs font-medium border; }
      .priority-high { @apply bg-red-100 text-red-600 border-red-200; }
      .priority-medium { @apply bg-amber-100 text-amber-600 border-amber-200; }
      .priority-low { @apply bg-green-100 text-green-600 border-green-200; }
      input[type="checkbox"] { @apply w-4 h-4 cursor-pointer mt-0.5; }
      .sync-status { @apply px-2 py-1 rounded text-xs font-semibold border; }
      .sync-status.online { @apply bg-green-100 text-green-600 border-green-200; }
      .sync-status.offline { @apply bg-amber-100 text-amber-600 border-amber-200; }
      .sync-status.error { @apply bg-red-100 text-red-600 border-red-200; }
      .status-message { @apply text-xs text-slate-500 dark:text-slate-400 mt-2; }
      .footer { @apply text-center py-6 text-xs text-slate-500 dark:text-slate-400 border-t border-slate-200 dark:border-slate-700 mt-8; }
      .menu-wrap { @apply relative ml-auto; }
      .menu { @apply absolute right-0 top-[calc(100%+6px)] bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-md shadow-md min-w-[200px] p-1 z-50; }
      .menu.hidden { @apply hidden; }
      .menu-item { @apply w-full text-left px-3 py-2 rounded-md text-sm text-slate-900 dark:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-700; }
      .menu-sep { @apply h-px bg-slate-200 dark:bg-slate-700 my-1; }
      .panel-header { @apply grid grid-cols-[1fr_auto] gap-3 items-center; }
      .summary-pills { @apply flex gap-2 items-center; }
      .pill { @apply flex items-center gap-2 px-2 py-2 border border-slate-200 dark:border-slate-600 bg-slate-100 dark:bg-slate-700 rounded-sm; }
      .pill .count { @apply font-bold text-lg; }
      .filters { @apply flex gap-2 flex-wrap items-center justify-end; }
      .filter-buttons { @apply flex gap-2; }
      .filter-buttons .btn-ghost.active { @apply outline outline-2 outline-brand/35; }
      .sort-control select { @apply min-w-[120px] rounded-md border border-slate-300 dark:border-slate-600 bg-white/60 dark:bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand; }
    }
    .hidden { display: none !important; }
    .sr-only { position: absolute !important; width: 1px !important; height: 1px !important; padding: 0 !important; margin: -1px !important; overflow: hidden !important; clip: rect(0, 0, 1px, 1px) !important; white-space: nowrap !important; border: 0 !important; }
  </style>
</head>
<body class="bg-gradient-to-b from-sky-50 to-slate-100 dark:from-slate-950 dark:to-slate-900 text-slate-900 dark:text-slate-100 antialiased">
  <header class="sticky top-0 border-b border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-slate-900/70 backdrop-blur">
    <div class="container">
      <div class="header-content">
        <div class="header-top">
          <h1>Memory Cue</h1>
          <div id="syncStatus" class="sync-status offline" aria-live="polite">Offline</div>
        </div>
        <div class="header-controls">
          <input id="q" class="search-input" placeholder="Search reminders or #tags" aria-label="Search reminders" />
          <button id="voiceBtn" class="btn-ghost btn-compact" type="button" title="Voice quick add" aria-label="Start voice input">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 1.5a3 3 0 00-3 3v6a3 3 0 006 0v-6a3 3 0 00-3-3z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5v1a7.5 7.5 0 01-15 0v-1M12 21v-3" />
            </svg>
          </button>
          <button id="notifBtn" class="btn-ghost btn-compact" type="button" title="Enable notifications" aria-label="Enable notifications">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M14.25 18.75a1.5 1.5 0 01-3 0M18.75 9a6.75 6.75 0 10-13.5 0c0 3.135-1.195 4.35-1.5 4.5h16.5c-.305-.15-1.5-1.365-1.5-4.5z" />
            </svg>
          </button>
          <button id="addQuickBtn" class="btn-primary btn-compact flex items-center justify-center" type="button" title="Add quick reminder" aria-label="Add quick reminder">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
          </button>
          <div class="menu-wrap">
            <button id="moreBtn" class="btn-ghost btn-compact" aria-haspopup="true" aria-expanded="false" aria-controls="moreMenu" title="More actions" aria-label="More actions">⋯</button>
            <div id="moreMenu" class="menu hidden" role="menu" aria-label="More actions">
              <button id="copyMtlBtn" class="menu-item" role="menuitem">Copy MTL</button>
              <label class="menu-item" role="menuitem" for="importFile" style="display:flex; align-items:center; gap:8px; cursor:pointer;">Import<input id="importFile" type="file" accept="application/json" class="sr-only" /></label>
              <button id="exportBtn" class="menu-item" role="menuitem">Export</button>
              <button id="syncAllBtn" class="menu-item" role="menuitem">Sync All Now</button>
              <div class="menu-sep"></div>
              <button id="openSettings" class="menu-item" role="menuitem">Settings</button>
              <button id="authBtn" class="menu-item" role="menuitem">Sign In</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>
  <nav class="tabs">
    <button class="tab-btn active" data-target="tasksTab">Reminders</button>
    <button class="tab-btn" data-target="notebookTab">Notebook</button>
  </nav>

  <div id="tasksTab" class="tab-panel">
    <main class="main-content">
    <div class="container">
      <!-- Create Reminder Card -->
      <section class="card section">
        <div class="card-header"><h2 class="card-title">Create Reminder</h2></div>
        <div class="card-content">
          <div class="form-stack">
            <div class="form-group">
              <label class="sr-only" for="title">Reminder</label>
              <input id="title" placeholder="e.g., Email parents about camp #admin" aria-label="Reminder title" />
              <div id="dateFeedback" style="margin-top: 4px; font-size: 12px; color: var(--text-muted); display: none;"></div>
            </div>
            <div class="form-row">
              <div class="form-group flex-1">
                <label class="sr-only" for="date">Date</label>
                <input id="date" type="date" aria-label="Due date" />
              </div>
              <div class="form-group flex-1">
                <label class="sr-only" for="time">Time</label>
                <input id="time" type="time" aria-label="Due time" />
              </div>
              <div class="form-group">
                <label class="sr-only" for="priority">Priority</label>
                <select id="priority" aria-label="Priority">
                  <option>High</option><option selected>Medium</option><option>Low</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <button id="saveBtn" class="btn-success flex-1" type="button">Save Reminder</button>
              <button id="cancelEditBtn" class="btn-ghost flex-1 hidden" type="button">Cancel</button>
            </div>
          </div>
          <div id="status" class="status-message" aria-live="polite"></div>
        </div>
      </section>

      <!-- Reminders List with inline counters -->
      <section class="card section">
        <div class="card-header">
          <div class="panel-header">
            <div class="summary-pills">
              <div class="pill" title="Tasks due today">
                <span>Today</span>
                <span class="count" id="inlineTodayCount">0</span>
              </div>
              <div class="pill" title="Tasks due this week">
                <span>This Week</span>
                <span class="count" id="inlineWeekCount">0</span>
              </div>
            </div>
            <div class="filters">
              <div class="filter-buttons">
                <button class="btn-ghost active" data-filter="today" type="button">Today</button>
                <button class="btn-ghost" data-filter="overdue" type="button">Overdue</button>
                <button class="btn-ghost" data-filter="all" type="button">All</button>
                <button class="btn-ghost" data-filter="done" type="button">Done</button>
              </div>
              <div class="sort-control">
                <label class="sr-only" for="sort">Sort</label>
                <select id="sort">
                  <option value="smart">Smart sort</option>
                  <option value="time">Time</option>
                  <option value="priority">Priority</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="card-content">
          <div id="list" class="task-list" aria-live="polite">
            <div class="text-muted">No reminders yet.</div>
          </div>
        </div>
      </section>

      <!-- Settings (hidden by default) -->
      <section class="card section hidden" id="settingsSection">
        <div class="card-header"><h2 class="card-title">Sync Settings</h2></div>
        <div class="card-content">
          <div class="form-stack">
            <div class="form-group"><input id="syncUrl" placeholder="https://script.google.com/macros/s/AKfycb.../exec" aria-label="Google Apps Script URL" /></div>
            <div class="form-row"><button id="saveSettings" class="btn-success flex-1" type="button">Save</button><button id="testSync" class="btn-ghost flex-1" type="button">Test</button></div>
            <div class="form-group"><input id="emailAddress" type="email" placeholder="you@example.com" aria-label="Daily email address" /></div>
            <div class="form-row"><button id="saveEmail" class="btn-success flex-1" type="button">Save Email</button><button id="testEmail" class="btn-ghost flex-1" type="button">Send Now</button></div>
          </div>
          <div class="text-muted" style="margin-top: var(--space-3); font-size: var(--text-xs);">
            <strong>Tip:</strong> In Google Apps Script, click <strong>Deploy → New deployment → Web app</strong>,
            set <strong>Execute as: Me</strong>, <strong>Who has access: Anyone with the link</strong>, then copy the URL.
          </div>
        </div>
      </section>
    </div>
  </main>
  </div>

  <div id="notebookTab" class="tab-panel hidden">
    <div class="container">
      <section class="card section">
        <div class="card-header">
          <h2 class="card-title">Notebook</h2>
        </div>
        <div class="card-content">
          <div class="form-stack">
            <textarea id="notes" placeholder="Type notes..." style="width:100%;min-height:200px;"></textarea>
            <div class="form-row">
              <button id="saveNoteBtn" class="btn-success flex-1" type="button">Save Note</button>
              <button id="newNoteBtn" class="btn-ghost flex-1" type="button">New Note</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, enableIndexedDbPersistence, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAmAMiz0zG3dAhZJhOy1DYj8fKVDObL36c",
      authDomain: "memory-cue-app.firebaseapp.com",
      projectId: "memory-cue-app",
      storageBucket: "memory-cue-app.firebasestorage.app",
      messagingSenderId: "751284466633",
      appId: "1:751284466633:web:3b10742970bef1a5d5ee18",
      measurementId: "G-R0V4M7VCE6"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    enableIndexedDbPersistence(db).catch(err => { console.warn('Firestore persistence not enabled:', err?.code || err); });

    // State
    let items = [];
    let filter = 'today';
    let sortKey = 'smart';
    let listening = false;
    let recog = null;
    let userId = null;
    let unsubscribe = null;

    // ---- Edit state ----
    let editingId = null;

    const TZ = 'Australia/Adelaide';
    const timeFmt = new Intl.DateTimeFormat('en-AU', { timeZone: TZ, hour:'2-digit', minute:'2-digit' });
    const dayFmt  = new Intl.DateTimeFormat('en-AU', { timeZone: TZ, weekday:'long', day:'numeric', month:'long' });
    // --- TZ-safe helpers (Australia/Adelaide) ---
    const dateOnlyFmt = new Intl.DateTimeFormat('en-CA', { timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit' }); // YYYY-MM-DD
    function formatDateLocal(d){ // returns 'YYYY-MM-DD' in TZ
      const parts = dateOnlyFmt.formatToParts(d);
      const y = parts.find(p=>p.type==='year').value;
      const m = parts.find(p=>p.type==='month').value;
      const da = parts.find(p=>p.type==='day').value;
      return `${y}-${m}-${da}`;
    }
    function localDateTimeToISO(dstr, tstr){ // build a Date using local wall time, then toISOString()
      const [Y,M,D] = dstr.split('-').map(n=>parseInt(n,10));
      const [h,m] = tstr.split(':').map(n=>parseInt(n,10));
      const dt = new Date();
      dt.setFullYear(Y, (M||1)-1, D||1);
      dt.setHours(h||0, m||0, 0, 0);
      return dt.toISOString();
    }

    const datePartsFmt = new Intl.DateTimeFormat('en-AU', { timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit' });
    const timePartsFmt = new Intl.DateTimeFormat('en-AU', { timeZone: TZ, hour: '2-digit', minute: '2-digit', hour12: false });

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // Elements
    const q = $('#q'), title = $('#title'), date = $('#date'), time = $('#time'), priority = $('#priority'), saveBtn = $('#saveBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const list = $('#list'), statusEl = $('#status'), syncStatus = $('#syncStatus');
    const voiceBtn = $('#voiceBtn'), notifBtn = $('#notifBtn'), addQuickBtn = $('#addQuickBtn');
    const copyMtlBtn = $('#copyMtlBtn'), importFile = $('#importFile'), exportBtn = $('#exportBtn');
    const dateFeedback = $('#dateFeedback');
    const sortSel = $('#sort'), openSettings = $('#openSettings'), settingsSection = $('#settingsSection');
    const syncAllBtn = document.getElementById('syncAllBtn');
    const syncUrlInput = $('#syncUrl'), saveSettings = $('#saveSettings'), testSync = $('#testSync');
    const emailInput = $('#emailAddress'), saveEmail = $('#saveEmail'), testEmail = $('#testEmail');
    const moreBtn = $('#moreBtn'), moreMenu = $('#moreMenu'), authBtn = $('#authBtn');
    const inlineTodayCount = $('#inlineTodayCount'), inlineWeekCount = $('#inlineWeekCount');
    const notesEl = $('#notes');
    const saveNoteBtn = $('#saveNoteBtn'), newNoteBtn = $('#newNoteBtn');
    const tabBtns = $$('.tab-btn');
    const tabPanels = $$('.tab-panel');

    const savedSyncUrl = localStorage.getItem('syncUrl') || '';
    if (savedSyncUrl) syncUrlInput.value = savedSyncUrl;
    const savedEmail = localStorage.getItem('emailAddress') || '';
    if (savedEmail) emailInput.value = savedEmail;
    saveEmail?.addEventListener('click', () => {
      localStorage.setItem('emailAddress', emailInput.value.trim());
      toast('Email saved');
    });
    testEmail?.addEventListener('click', () => sendDailyEmail(true));

    notesEl.value = localStorage.getItem('mobileNotes') || '';
    notesEl.addEventListener('input', () => localStorage.setItem('mobileNotes', notesEl.value));

    tabBtns.forEach(btn => btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('active'));
      tabPanels.forEach(p => p.classList.add('hidden'));
      btn.classList.add('active');
      const target = btn.getAttribute('data-target');
      document.getElementById(target).classList.remove('hidden');
    }));

    function updateNetworkBadge() {
      if (!syncStatus) return;
      if (navigator.onLine) {
        syncStatus.textContent = 'Online';
        syncStatus.className = 'sync-status online';
      } else {
        syncStatus.textContent = 'Offline';
        syncStatus.className = 'sync-status offline';
      }
    }

    window.addEventListener('online', updateNetworkBadge);
    window.addEventListener('offline', updateNetworkBadge);
    updateNetworkBadge();

    // Firestore sync
    function setupFirestoreSync() {
      if (!userId) { items=[]; render(); return; }
      if (unsubscribe) unsubscribe();
      const userCollection = collection(db, 'users', userId, 'reminders');
      const qSnap = query(userCollection, orderBy('updatedAt', 'desc'));
      unsubscribe = onSnapshot(qSnap, (snapshot) => {
        const remoteItems = [];
        snapshot.forEach((d) => {
          const data = d.data();
          remoteItems.push({
            id: d.id,
            title: data.title, priority: data.priority, notes: data.notes || '', done: !!data.done,
            due: data.due || null,
            createdAt: data.createdAt?.toMillis?.() || 0,
            updatedAt: data.updatedAt?.toMillis?.() || 0
          });
        });
        items = remoteItems;
        render();
      }, (error) => {
        console.error('Firestore sync error:', error);
        syncStatus.textContent = 'Sync Error'; syncStatus.className = 'sync-status error';
      });
    }

    function handleAuth() {
      if (auth.currentUser) {
        signOut(auth);
      } else {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch(() => toast('Sign in failed'));
      }
    }

    function updateAuthButton(user) {
      if (!authBtn) return;
      authBtn.textContent = user ? 'Sign Out' : 'Sign In';
    }

    // Save/Delete
    async function saveToFirebase(item) {
      if (!userId) return;
      try {
        await setDoc(doc(db, 'users', userId, 'reminders', item.id), {
          title: item.title, priority: item.priority, notes: item.notes || '', done: !!item.done, due: item.due || null,
          createdAt: item.createdAt ? new Date(item.createdAt) : serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });
      } catch (error) {
        console.error('Save failed:', error); toast('Save queued (offline)');
      }
    }
    async function deleteFromFirebase(id) { if (!userId) return; try { await deleteDoc(doc(db, 'users', userId, 'reminders', id)); } catch { toast('Delete queued (offline)'); } }

    // Optional: Calendar/Sheet sync via Apps Script
    async function tryCalendarSync(task) {
      const url = (localStorage.getItem('syncUrl') || '').trim(); if (!url) return;
      const payload = { id: task.id, title: task.title, dueIso: task.due || null, priority: task.priority || 'Medium', done: !!task.done, source: 'memory-cue-mobile' };
      try { await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); }
      catch {}
    }

    async function sendDailyEmail(force = false) {
      const email = (localStorage.getItem('emailAddress') || '').trim();
      if (!email) return;
      const today = new Date().toISOString().slice(0,10);
      const lastSent = localStorage.getItem('lastEmailSent');
      if (!force && lastSent === today) return;
      const active = items.filter(i => !i.done);
      if (!active.length) return;
      const url = (localStorage.getItem('syncUrl') || '').trim();
      if (!url) return;
      try {
        console.log('Daily email URL', url);
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, reminders: active })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        localStorage.setItem('lastEmailSent', today);
        if (force) toast('Email sent');
      } catch (err) {
        console.error('Daily email failed', err);
        if (force) {
          const msg = navigator.onLine ? `Email failed: ${err.message}` : 'Offline; email not sent';
          toast(msg);
        }
      }
    }

    // Utils
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function toISODatePart(d){ return formatDateLocal(d); }
    function todayISO(){ const now = new Date(); return formatDateLocal(now); }
    function startOfWeek(dateObj){ const d = new Date(dateObj); const day = (d.getDay() + 6) % 7; d.setDate(d.getDate() - day);d.setHours(0,0,0,0); return d; }
    function endOfWeek(dateObj){ const s = startOfWeek(dateObj); const e = new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
    function priorityWeight(p){ return p==='High'?3 : p==='Medium'?2 : 1; }
    function smartCompare(a,b){ const pr = priorityWeight(b.priority)-priorityWeight(a.priority); if(pr) return pr; const at=+new Date(a.due||0), bt=+new Date(b.due||0); if(at!==bt) return at-bt; return (a.updatedAt||0)>(b.updatedAt||0)?-1:1; }
    function fmtDayDate(iso){ if(!iso) return '—'; try{ const d = new Date(iso+'T00:00:00'); return dayFmt.format(d); }catch{ return iso; } }
    function fmtTime(d){ return timeFmt.format(d); }
    function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;' }[c])); }
    function toast(msg){ statusEl.textContent = msg; clearTimeout(toast._t); toast._t = setTimeout(()=> statusEl.textContent='', 2500); }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    function parseQuickWhen(text) {
      text = String(text || '').toLowerCase();

      // Default = today, no time
      let when = { date: todayISO(), time: '' };

      // Helper function to get next occurrence of a day
      const getNextDayOfWeek = (dayIndex) => {
        const today = new Date();
        const currentDay = today.getDay();
        const daysUntilTarget = (dayIndex - currentDay + 7) % 7;
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + (daysUntilTarget === 0 ? 7 : daysUntilTarget));
        return targetDate;
      };

      // Helper function to get this occurrence of a day
      const getThisDayOfWeek = (dayIndex) => {
        const today = new Date();
        const currentDay = today.getDay();
        const daysUntilTarget = (dayIndex - currentDay + 7) % 7;
        const targetDate = new Date(today);
        targetDate.setDate(today.getDate() + daysUntilTarget);
        return targetDate;
      };

      // Day names mapping
      const dayNames = {
        'sunday': 0, 'sun': 0,
        'monday': 1, 'mon': 1,
        'tuesday': 2, 'tue': 2, 'tues': 2,
        'wednesday': 3, 'wed': 3,
        'thursday': 4, 'thu': 4, 'thur': 4, 'thurs': 4,
        'friday': 5, 'fri': 5,
        'saturday': 6, 'sat': 6
      };

      // Month names mapping
      const monthNames = {
        'january': 0, 'jan': 0,
        'february': 1, 'feb': 1,
        'march': 2, 'mar': 2,
        'april': 3, 'apr': 3,
        'may': 4,
        'june': 5, 'jun': 5,
        'july': 6, 'jul': 6,
        'august': 7, 'aug': 7,
        'september': 8, 'sep': 8, 'sept': 8,
        'october': 9, 'oct': 9,
        'november': 10, 'nov': 10,
        'december': 11, 'dec': 11
      };

      // Detect "tomorrow"
      if (/\btomorrow\b/.test(text)) {
        const d = new Date();
        d.setDate(d.getDate() + 1);
        when.date = formatDateLocal(d);
      }
      // Detect "today"
      else if (/\btoday\b/.test(text)) {
        when.date = todayISO();
      }
      // Detect "next [day]"
      else if (/\bnext\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\bnext\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getNextDayOfWeek(dayIndex);
        when.date = formatDateLocal(targetDate);
      }
      // Detect "this [day]"
      else if (/\bthis\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\bthis\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getThisDayOfWeek(dayIndex);
        when.date = formatDateLocal(targetDate);
      }
      // Detect standalone day names (assume next occurrence)
      else if (/\b(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/.test(text)) {
        const match = text.match(/\b(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
        const dayIndex = dayNames[match[1]];
        const targetDate = getNextDayOfWeek(dayIndex);
        when.date = formatDateLocal(targetDate);
      }
      // Detect "in X days"
      else if (/\bin\s+(\d+)\s+days?\b/.test(text)) {
        const match = text.match(/\bin\s+(\d+)\s+days?\b/);
        const days = parseInt(match[1], 10);
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + days);
        when.date = formatDateLocal(targetDate);
      }
      // Detect "this weekend" (assume Saturday)
      else if (/\bthis\s+weekend\b/.test(text)) {
        const targetDate = getThisDayOfWeek(6); // Saturday
        when.date = formatDateLocal(targetDate);
      }
      else if (/\bnext\s+weekend\b/.test(text)) {
        const targetDate = getNextDayOfWeek(6); // Saturday
        when.date = formatDateLocal(targetDate);
      }
      // Detect "next week"
      else if (/\bnext\s+week\b/.test(text)) {
        const targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + 7);
        when.date = formatDateLocal(targetDate);
      }
      // Detect specific dates like "september 15" or "sep 15"
      else if (/\b(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)\s+(\d{1,2})(st|nd|rd|th)?\b/.test(text)) {
        const match = text.match(/\b(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)\s+(\d{1,2})(st|nd|rd|th)?\b/);
        const monthIndex = monthNames[match[1]];
        const day = parseInt(match[2], 10);
        const targetDate = new Date();
        targetDate.setMonth(monthIndex, day);
        // If the date has passed this year, assume next year
        if (targetDate < new Date()) {
          targetDate.setFullYear(targetDate.getFullYear() + 1);
        }
        when.date = formatDateLocal(targetDate);
      }
      // Detect date formats like "15/09" or "09/15" or "15/09/2025"
      else if (/\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/.test(text)) {
        const match = text.match(/\b(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?\b/);
        const first = parseInt(match[1], 10);
        const second = parseInt(match[2], 10);
        let year = match[3] ? parseInt(match[3], 10) : new Date().getFullYear();

        // Handle 2-digit years
        if (year < 100) {
          year += year < 50 ? 2000 : 1900;
        }

        // Assume DD/MM format (common in AU)
        if (first <= 12 && second <= 12) {
          // If both could be month or day, prefer DD/MM format
          const targetDate = new Date(year, second - 1, first);
          when.date = formatDateLocal(targetDate);
        } else if (first <= 31 && second <= 12) {
          // DD/MM format
          const targetDate = new Date(year, second - 1, first);
          when.date = formatDateLocal(targetDate);
        } else if (first <= 12 && second <= 31) {
          // MM/DD format
          const targetDate = new Date(year, first - 1, second);
          when.date = formatDateLocal(targetDate);
        }
      }

      // hh:mm (24h)
      let m = text.match(/\b(\d{1,2}):(\d{2})\b/);
      if (m) {
        const hh = String(parseInt(m[1], 10)).padStart(2, '0');
        const mm = String(parseInt(m[2], 10)).padStart(2, '0');
        when.time = `${hh}:${mm}`;
        return when;
      }

      // h am/pm
      m = text.match(/\b(\d{1,2})\s*(am|pm)\b/);
      if (m) {
        let h = parseInt(m[1], 10) % 12;
        if (m[2] == 'pm') h += 12;
        when.time = `${String(h).padStart(2, '0')}:00`;
        return when;
      }

      // compact 3–4 digit time like "630" or "0930"
      m = text.match(/\b(\d{3,4})\b/);
      if (m) {
        const digits = m[1];
        let hh, mm;
        if (digits.length == 3) {
          hh = '0' + digits[0];
          mm = digits.slice(1);
        } else {
          hh = digits.slice(0, 2);
          mm = digits.slice(2);
        }
        hh = String(parseInt(hh, 10)).padStart(2, '0');
        mm = String(parseInt(mm, 10)).padStart(2, '0');
        when.time = `${hh}:${mm}`;
      }

      return when;
    }


    function isoToLocalDate(iso){
      try {
        const d = new Date(iso);
        const parts = datePartsFmt.formatToParts(d);
        const y = parts.find(p=>p.type==='year')?.value || '0000';
        const m = parts.find(p=>p.type==='month')?.value || '01';
        const da = parts.find(p=>p.type==='day')?.value || '01';
        return `${y}-${m}-${da}`;
      } catch { return ''; }
    }
    function isoToLocalTime(iso){
      try {
        const d = new Date(iso);
        const parts = timePartsFmt.formatToParts(d);
        const h = parts.find(p=>p.type==='hour')?.value?.padStart(2,'0') || '00';
        const m = parts.find(p=>p.type==='minute')?.value?.padStart(2,'0') || '00';
        return `${h}:${m}`;
      } catch { return ''; }
    }

    function resetForm(){
      title.value = ''; date.value = ''; time.value=''; priority.value='Medium';
      editingId = null;
      saveBtn.textContent = 'Save Reminder';
      cancelEditBtn.classList.add('hidden');
    }

    function loadForEdit(id){
      const it = items.find(x => x.id === id);
      if (!it) return;
      title.value = it.title || '';
      if (it.due){
        date.value = isoToLocalDate(it.due);
        time.value = isoToLocalTime(it.due);
      } else {
        date.value = ''; time.value = '';
      }
      priority.value = it.priority || 'Medium';
      editingId = id;
      saveBtn.textContent = 'Update Reminder';
      cancelEditBtn.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      title.focus();
    }

    // Create & basic actions
    function addItem(obj){
      if (!userId) { toast('Sign in to add reminders'); return; }
      const nowMs = Date.now();
      const item = {
        id: uid(), title: obj.title.trim(), priority: obj.priority || 'Medium', notes: obj.notes || '', done: false,
        createdAt: nowMs, updatedAt: nowMs, due: obj.due || null
      };
      items = [item, ...items]; render(); saveToFirebase(item);
      tryCalendarSync(item);
      return item;
    }
    function toggleDone(id){ const it = items.find(x=>x.id===id); if(!it) return; it.done=!it.done; it.updatedAt=Date.now(); saveToFirebase(it); tryCalendarSync(it); render(); }
    function removeItem(id){ items = items.filter(x=>x.id!==id); render(); deleteFromFirebase(id); }

    // Rendering
    function render(){
      sendDailyEmail();
      // Update inline counters first
      const now = new Date();
      const adlNow = new Date(now.toLocaleString('en-US', { timeZone: TZ }));
      const t0 = new Date(adlNow); t0.setHours(0,0,0,0);
      const t1 = new Date(adlNow); t1.setHours(23,59,59,999);
      const w0 = startOfWeek(adlNow);
      const w1 = endOfWeek(adlNow);
      const todays = items.filter(x => x.due && new Date(x.due) >= t0 && new Date(x.due) <= t1 && !x.done);
      const weeks  = items.filter(x => x.due && new Date(x.due) >= w0 && new Date(x.due) <= w1 && !x.done);
      inlineTodayCount.textContent = String(todays.length);
      inlineWeekCount.textContent = String(weeks.length);

      // Now render list
      const queryStr = q.value.trim().toLowerCase();
      let rows = items.slice();
      if (queryStr){ rows = rows.filter(r => r.title.toLowerCase().includes(queryStr) || (r.notes||'').toLowerCase().includes(queryStr)); }
      rows = rows.filter(r => {
        if (filter==='done') return r.done;
        if (filter==='overdue') return !r.done && r.due && new Date(r.due) < adlNow;
        if (filter==='today'){
          if (!r.due) return true;
          const dueAdl = new Date(new Date(r.due).toLocaleString('en-US', { timeZone: TZ }));
          return dueAdl >= t0 && dueAdl <= t1;
        }
        return true;
      });

      rows.sort((a,b)=>{
        if (sortKey==='time') return (+new Date(a.due||0)) - (+new Date(b.due||0));
        if (sortKey==='priority') return priorityWeight(b.priority) - priorityWeight(a.priority);
        return smartCompare(a,b);
      });
      $$('button[data-filter]').forEach(btn => btn.classList.toggle('active', btn.getAttribute('data-filter')===filter));
      const frag = document.createDocumentFragment();
      if (rows.length===0){ list.innerHTML = '<div class="text-muted">No reminders found.</div>'; return; }
      list.replaceChildren();
      rows.forEach(r => {
        const div = document.createElement('div');
        div.className = 'task-item' + (r.done ? ' completed' : '');
        const dueTxt = r.due ? `${fmtTime(new Date(r.due))} • ${fmtDayDate(r.due.slice(0,10))}` : 'No due date';
        const priorityClass = `priority-${r.priority.toLowerCase()}`;
        div.innerHTML = `
          <input type="checkbox" ${r.done ? 'checked' : ''} aria-label="Mark complete" />
          <div class="task-content">
            <div class="task-title">${escapeHtml(r.title)}</div>
            <div class="task-meta">
              <div class="task-meta-row">
                <span>${dueTxt}</span>
                <span class="priority-badge ${priorityClass}">${r.priority}</span>
              </div>
            </div>
          </div>
          <div class="task-actions">
            <button class="btn-ghost" data-edit type="button">Edit</button>
            <button class="btn-ghost" data-del type="button">Del</button>
          </div>`;
        div.querySelector('input').addEventListener('change', () => toggleDone(r.id));
        div.querySelector('[data-edit]').addEventListener('click', () => loadForEdit(r.id));
        div.querySelector('[data-del]').addEventListener('click', () => removeItem(r.id));
        frag.appendChild(div);
      });
      list.appendChild(frag);
    }

    // Menu toggle
    function closeMenu(){ moreBtn?.setAttribute('aria-expanded','false'); moreMenu?.classList.add('hidden'); }
    function openMenu(){ moreBtn?.setAttribute('aria-expanded','true'); moreMenu?.classList.remove('hidden'); }
    moreBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); const open = moreBtn.getAttribute('aria-expanded')==='true';open ? closeMenu() : openMenu(); });
    document.addEventListener('click', (e)=>{ if (!moreMenu?.classList.contains('hidden')) { if (!moreMenu.contains(e.target) && e.target !== moreBtn) closeMenu(); } });
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeMenu(); });

    // Settings toggle + force hidden on load + Esc hides
    openSettings.addEventListener('click', () => {
      const willShow = settingsSection.classList.contains('hidden');
      settingsSection.classList.toggle('hidden');
      if (willShow) { settingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
      closeMenu();
    });
    document.addEventListener('DOMContentLoaded', () => { settingsSection.classList.add('hidden'); });

    // Save/create or update
    saveBtn.addEventListener('click', () => {
      // Create new OR update existing depending on editingId
      if (editingId) {
        const it = items.find(x=>x.id===editingId);
        if (!it) { resetForm(); return; }
        const tNew = title.value.trim(); if (!tNew) { toast('Add a reminder title'); return; }
        let due = null;
        if (date.value || time.value) {
          const d = (date.value || todayISO()); const tm = (time.value || '09:00');
          due = localDateTimeToISO(d, tm);
        } else {
          const p = parseQuickWhen(tNew); if (p.time) { due = new Date(`${p.date}T${p.time}:00`).toISOString(); }
        }
        it.title = tNew; it.priority = priority.value; it.due = due; it.updatedAt = Date.now();
        saveToFirebase(it); tryCalendarSync(it); render(); resetForm(); toast('Reminder updated');
        return;
      }

      const t = title.value.trim(); if (!t) { toast('Add a reminder title'); return; }
      let due = null;
      if (date.value || time.value) { const d = (date.value || todayISO()); const tm = (time.value || '09:00'); due = localDateTimeToISO(d, tm); }
      else { const p = parseQuickWhen(t); if (p.time) { due = new Date(`${p.date}T${p.time}:00`).toISOString(); } }
      addItem({ title: t, priority: priority.value, due });
      title.value = ''; time.value = '';
    });
    title.addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveBtn.click(); });

    // Add real-time date feedback
    function updateDateFeedback() {
      const text = title.value.trim();
      if (!text) {
        dateFeedback.style.display = 'none';
        return;
      }

      try {
        const parsed = parseQuickWhen(text);
        const today = todayISO();

        if (parsed.date !== today || parsed.time) {
          let feedback = '';

          if (parsed.date !== today) {
            const dateObj = new Date(parsed.date + 'T00:00:00');
            feedback += `📅 ${fmtDayDate(parsed.date)}`;
          }

          if (parsed.time) {
            feedback += `${feedback ? ' ' : ''}🕐 ${parsed.time}`;
          }

          if (feedback) {
            dateFeedback.textContent = `Parsed: ${feedback}`;
            dateFeedback.style.display = 'block';
          } else {
            dateFeedback.style.display = 'none';
          }
        } else {
          dateFeedback.style.display = 'none';
        }
      } catch (e) {
        dateFeedback.style.display = 'none';
      }
    }

    title.addEventListener('input', debounce(updateDateFeedback, 300));
    cancelEditBtn?.addEventListener('click', () => { resetForm(); toast('Edit cancelled'); });
    window.addEventListener('load', ()=> title.focus());
    addQuickBtn.addEventListener('click', () => { if (!title.value.trim()) { title.focus(); toast('Type something like "email parents at 4pm"'); return; } saveBtn.click(); });
    q.addEventListener('input', debounce(render, 150));
    sortSel.addEventListener('change', () => { sortKey = sortSel.value; render(); });
    $$('button[data-filter]').forEach(b => b.addEventListener('click', () => { filter = b.getAttribute('data-filter'); render(); }));

    copyMtlBtn.addEventListener('click', () => {
      const lines = items.filter(x => !x.done).map(x => {
        const datePart = x.due ? fmtDayDate(x.due.slice(0, 10)) : '';
        const timePart = x.due ? new Date(x.due).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' }) : '';
        const pieces = [ 'mtl ' + x.title, x.due ? `Due Date: ${datePart}` : '', x.due ? `Time: ${timePart}` : '', `Status: Not started` ].filter(Boolean);
        return pieces.join('\n');
      });
      if (lines.length === 0) { toast('No active tasks to copy'); return; }
      navigator.clipboard.writeText(lines.join('\n\n')).then(() => toast('Copied for Master Task List')).catch(() => toast('Copy failed'));
      closeMenu();
    });
    importFile.addEventListener('change', () => {
      const f = importFile.files[0]; if (!f) return;
      const rd = new FileReader();
      rd.onload = () => {
        try {
          const importedItems = JSON.parse(String(rd.result) || '[]').slice(0, 500);
          importedItems.forEach(item => { item.id = (Math.random().toString(36).slice(2)+Date.now().toString(36)); items = [item, ...items]; saveToFirebase(item); });
          render(); toast('Import successful');
        } catch { toast('Invalid JSON'); }
      };
      rd.readAsText(f); importFile.value = '';
      closeMenu();
    });
    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'memory-cue-mobile.json'; a.click(); URL.revokeObjectURL(url);
      closeMenu();
    });

    authBtn.addEventListener('click', () => {
      handleAuth();
      closeMenu();
    });

    // Sync All Now -> POST everything in batches
    syncAllBtn?.addEventListener('click', async () => {
      const url = (localStorage.getItem('syncUrl') || '').trim();
      if (!url) { toast('Add your Apps Script URL in Settings first'); closeMenu(); return; }
      if (!items.length) { toast('No tasks to sync'); closeMenu(); return; }

      toast('Syncing all tasks…');
      const chunkSize = 20;
      let fail = 0;
      for (let i = 0; i < items.length; i += chunkSize) {
        const chunk = items.slice(i, i + chunkSize);
        const results = await Promise.allSettled(chunk.map(task => {
          const payload = {
            id: task.id,
            title: task.title,
            dueIso: task.due || null,
            priority: task.priority || 'Medium',
            done: !!task.done,
            source: 'memory-cue-mobile'
          };
          return fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        }));
        fail += results.filter(r => r.status === 'rejected').length;
        await new Promise(res => setTimeout(res, 400));
      }
      toast(`Sync complete: ${items.length - fail} ok${fail ? `, ${fail} failed` : ''}`);
      closeMenu();
    });

    // Voice + Notifications
    try {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SR) {
        recog = new SR();
        recog.lang = 'en-AU';
        recog.interimResults = false;
        recog.onresult = (e) => { const t = e.results[0][0].transcript || ''; title.value = t; toast('Heard: ' + t); };
        recog.onend = () => { listening = false; voiceBtn.textContent = '🎙️'; };
      }
    } catch {}
    voiceBtn.addEventListener('click', () => {
      if (!recog) return;
      if (!listening) { try { recog.start(); listening = true; voiceBtn.textContent = '👂'; } catch {} }
      else { try { recog.stop(); } catch {} listening = false; voiceBtn.textContent = '🎙️'; }
    });
    notifBtn.addEventListener('click', async () => {
      if (!('Notification' in window)) { toast('Notifications not supported'); return; }
      if (Notification.permission === 'granted') { toast('Notifications enabled'); return; }
      const perm = await Notification.requestPermission(); toast(perm === 'granted' ? 'Notifications enabled' : 'Notifications blocked');
    });

    // Notebook functionality
    saveNoteBtn.addEventListener('click', () => {
      // Persist current note to localStorage and show confirmation
      localStorage.setItem('mobileNotes', notesEl.value);
      toast('Note saved');
    });
    
    newNoteBtn.addEventListener('click', () => {
      if (notesEl.value.trim() && !confirm('Are you sure you want to start a new note? This will clear the current content.')) {
        return;
      }
      notesEl.value = '';
      localStorage.setItem('mobileNotes', '');
      notesEl.focus();
      toast('New note started');
    });

    // PWA scaffold
    (function setupPWA(){
      const manifest = { name:'Memory Cue', short_name:'MemoryCue', start_url:'.', display:'standalone', background_color:'#0b1220', theme_color:'#0b1220' };
      const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      document.getElementById('manifestLink').setAttribute('href', url);
      if ('serviceWorker' in navigator) {
        const swCode = `self.addEventListener('install', e=>self.skipWaiting()); self.addEventListener('activate', e=>self.clients.claim());`;
        const swBlob = new Blob([swCode], { type: 'text/javascript' });
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).catch(()=>{});
      }
    })();

    // Initial render
    onAuthStateChanged(auth, user => {
      userId = user ? user.uid : null;
      updateAuthButton(user);
      setupFirestoreSync();
    });

    render();
  </script>
</body>
</html>
